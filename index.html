<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile ERP ‚Äî Single-File HTML (Koder Test Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script> 
    
    <style>
      html, body { height: 100%;
 background: #f1f5f9; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;
 /* ------------- Firebase Setup (REPLACE THESE CONFIG VALUES) ------------- */
      // ‚ö†Ô∏è IMPORTANT: You must replace the placeholders below with your actual Firebase project configuration.
 const firebaseConfig = {
        apiKey: "AIzaSyB21YCBgR4qJgRRunwWPx3tUeELvFegxnE",
        authDomain: "rentalerp-abe70.firebaseapp.com",
        projectId: "rentalerp-abe70",
        storageBucket: "rentalerp-abe70.firebasestorage.app",
        messagingSenderId: "400286046254",
        appId: "1:400286046254:web:50a278b1c0d97246b2a7bf"
      };
 // Initialize Firebase App, Firestore, Auth, and Storage
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
 }
      const db = firebase.firestore();
      const auth = firebase.auth();
 // NEW: Initialize Storage service
      const storage = firebase.storage();
 // The single document ID where all your application data will be stored.
      const FIRESTORE_DOC_ID = "main_rental_data";
 /* ------------- Utilities (MODIFIED/ADDED) ------------- */
      const todayStr = () => new Date().toISOString().slice(0, 10);
 const currency = (n) => {
        const num = Number(n || 0);
 try {
          return num
            .toLocaleString(undefined, { style: "currency", currency: "BDT" })
            .replace("BDT", "‡ß≥")
            .trim();
 } catch {
          // Fallback for browsers that don't know BDT
          return `‡ß≥${num.toLocaleString()}`;
 }
      };

      // NEW: Function to format YYYY-MM to descriptive month name (REQUEST 1)
      const formatMonth = (ym) => {
          if (!ym || ym.length !== 7) return "N/A";
 const [year, month] = ym.split('-');
          // month is 1-based, so month - 1 is needed for Date constructor
          const date = new Date(year, month - 1, 1);
 return date.toLocaleString('default', { month: 'long', year: 'numeric' });
      };

      // NEW: Function to convert amount to words (BDT specific, using Lakh/Crore)
      const amountToWords = (n) => {
          if (typeof n !== 'number') {
              n = Number(n);
 }
          if (isNaN(n) || n <= 0) {
              return "Zero Taka Only";
 }

          const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
 const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
 const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
 function helper(num) {
              if (num === 0) return '';
 if (num < 10) return units[num] + ' ';
              if (num < 20) return teens[num - 10] + ' ';
 if (num < 100) return tens[Math.floor(num / 10)] + ' ' + helper(num % 10);
 if (num < 1000) return units[Math.floor(num / 100)] + ' Hundred ' + helper(num % 100);
              
              let words = '';
 // Use Crore
              if (num >= 10000000) {
                  words += helper(Math.floor(num / 10000000)) + ' Crore ';
 num %= 10000000;
              }
              // Use Lakh
              if (num >= 100000) {
                  words += helper(Math.floor(num / 100000)) + ' Lakh ';
 num %= 100000;
              }
              if (num >= 1000) {
                  words += helper(Math.floor(num / 1000)) + ' Thousand ';
 num %= 1000;
              }
              words += helper(num);
 return words;
          }

          let totalAmount = Math.round(n * 100) / 100;
 let taka = Math.floor(totalAmount);
          let paisa = Math.round((totalAmount - taka) * 100);

          let takaWords = helper(taka).trim();
          let words = takaWords;
 if (words) {
              words += ' Taka';
 } else {
              words = '';
 }

          if (paisa > 0) {
              if (words) {
                  words += ' and ';
 }
              // Converting paisa to words is complex, using fraction for simplicity/accuracy
              let paisaWords = helper(paisa).trim();
 if (paisaWords) {
                  words += paisaWords + ' Paisa';
 } else {
                  words += `${String(paisa).padStart(2, '0')}/100 Paisa`;
 }
          }

          if (words) {
              words += ' Only';
 }

          return words.replace(/\s+/g, ' ').trim() || "Zero Taka Only";
      };
 const monthKey = (dateStr) => {
        const d = new Date(dateStr);
 return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`; // YYYY-MM
      };
 const nextReceiptNo = (allPayments) => {
        const yyyymm = monthKey(new Date().toISOString());
 const prefix = `RC-${yyyymm}-`;
        const count = allPayments.filter((p) => (p.receiptNo || "").startsWith(prefix)).length + 1;
        return `${prefix}${String(count).padStart(4, "0")}`;
      };
 const download = (filename, text) => {
        const blob = new Blob([text], { type: "application/json;charset=utf-8;" });
 const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };
 const classNames = (...c) => c.filter(Boolean).join(" ");

      if (!(window.crypto && window.crypto.randomUUID)) {
        window.crypto = window.crypto ||
 {};
        window.crypto.randomUUID = function () {
          // RFC4122 v4-ish
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = (Math.random() * 16) | 0;
            const v = c === 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          });
 };
      }
      
      // Utility function to check for reminder
      const shouldShowReminder = (dueDay) => {
          const today = new Date();
 const currentDay = today.getDate();
          
          // Simplified check: is today the day 2 days before the dueDay?
 return Math.abs(currentDay - Number(dueDay)) === 2;
      }
      
      // Utility function to generate WhatsApp link
      const createWhatsAppLink = (tenantPhone, unitName, orgName, dueDay, rentAmount) => {
          if (!tenantPhone || !unitName) return null;
 // Clean phone number (remove +, spaces, dashes, etc.)
          const phone = tenantPhone.replace(/\D/g, '');
 const rent = currency(rentAmount);
          
          const message = `*Rent Reminder from ${orgName}*\n\nDear tenant of ${unitName},\n\nThis is a friendly reminder that your monthly rent of ${rent} is due in 2 days (on the ${dueDay}th of the month).\n\nPlease make the payment before the due date.\nThank you!`;
 const encodedMessage = encodeURIComponent(message);
          
          return `https://wa.me/${phone}?text=${encodedMessage}`;
      };


      /* ------------- Demo initial data (unchanged) ------------- */
      const initialData = {
        org: {
          name: "Shahjaha chowdhury Bari",
          address: "House: 383, Road: 13, Block: J, Bashundhara R/A, Dhaka-1230",
          phone: "+8801749333661",
          email: "Foyaz.islam@yahoo.com",
          note: "Thank you for 
 your payment!",
     
        },
        units: [
          ...Array.from({ length: 10 }).map((_, i) => ({
            id: `F${i + 1}`,
            type: "Flat",
            name: `Flat ${i + 1}`,
            floor: Math.ceil((i + 1) / 
 2),
           
            rent: 15000,
            dueDay: 5,
            tenant: "",
            tenantPhone: "", 
            tenantPhotoUrl: "", 
            tenantNidUrl: "", 
        
     rentAgreementUrl: "", 
            enableReminder: true, 
  
          })),
          ...Array.from({ length: 5 }).map((_, i) => ({
            id: `S${i + 1}`,
            type: "Shop",
            name: `Shop ${i + 1}`,
        
     floor: 0,
            rent: 25000,
      
            dueDay: 5,
            tenant: "",
            tenantPhone: "", 
            tenantPhotoUrl: "", 
            tenantNidUrl: "", 
        
     rentAgreementUrl: "", 
            enableReminder: true, 
          
          })),
        ],
        payments: [], 
        expenses: []
      };
 /* ------------- Cloud Storage Functions (unchanged) ------------- */
      const localStorageKey = "rental_erp_v1";
 const loadData = async (uid) => {
        try {
          // Check for old localStorage data for one-time migration
          const rawLocal = localStorage.getItem(localStorageKey);
 if (rawLocal) {
            console.log("Found data in localStorage. Attempting cloud migration.");
 const parsed = JSON.parse(rawLocal);
            // Save it to Firestore immediately
            await saveData(parsed, uid);
 // Clear local storage after successful migration
            localStorage.removeItem(localStorageKey);
 alert("Local data migrated to the cloud successfully! It will now sync across devices.");
            return { ...initialData, ...parsed };
 }

          // Load from Firestore (using UID to scope the document path)
          const docPath = `erp_data/${uid}`;
 const docRef = db.doc(docPath);
          const doc = await docRef.get();

          if (doc.exists) {
            console.log("Data loaded from cloud storage.");
 // Merge with initialData to ensure new fields are present
            return { ...initialData, ...doc.data() };
 }

          console.log("No cloud data found. Saving initial demo data to cloud.");
 // Initial save of demo data to the cloud
          await saveData(initialData, uid);
 return initialData;

        } catch (e) {
          console.error("Cloud Load error. Returning initial data.", e);
 // If load fails, we return initial data and the app will try to save on next change.
          return initialData;
 }
      };

      const saveData = async (data, uid) => {
        if (!uid) {
            console.error("Cannot save data: User ID is missing.");
 return;
        }
        try {
          // Use UID in the document path for user-specific data
          const docPath = `erp_data/${uid}`;
 const docRef = db.doc(docPath);
          
          const dataToSave = {
            org: data.org,
            units: data.units,
            payments: data.payments,
            expenses: data.expenses,
          };
 await docRef.set(dataToSave);
          console.log(`Data saved to cloud successfully for user: ${uid}.`);
 } catch (e) {
          console.error("Cloud Save error.", e);
 alert("Warning: Data failed to save to the cloud. You are working offline and data will not sync.");
 }
      };

      // NEW: Utility to upload file to Firebase Storage
      const uploadFile = async (file, unitId, type) => {
          const storageRef = storage.ref();
 // Use a simple path structure
          const path = `tenant_docs/${unitId}/${type}/${file.name}`;
 const fileRef = storageRef.child(path);
          
          console.log(`Uploading ${type} for ${unitId}...`);
          
          const snapshot = await fileRef.put(file);
          const downloadURL = await snapshot.ref.getDownloadURL();
 console.log(`Upload successful. URL: ${downloadURL}`);
          return downloadURL;
      };


      /* ------------- UI primitives (MODIFIED - Input/Select/Checkbox fixed for Babel) ------------- */
      const Section = ({ title, right, children }) => (
        <div className="bg-white rounded-2xl shadow p-4 md:p-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
            {right}
          </div>
   
     
          {children}
        </div>
      );
 // MODIFIED: Use explicit return for better compatibility with browser-Babel
      const Input = (props) => {
        return (
          <input
            {...props}
            className={classNames(
              "w-full rounded-xl border px-3 py-2 text-sm md:text-base",
              "focus:outline-none focus:ring-2 focus:ring-indigo-400",
 
              props.className
            )}
          />
        );
 };

      // MODIFIED: Use explicit return for better compatibility with browser-Babel
      const Select = (props) => {
        return (
          <select
            {...props}
            className={classNames(
              "w-full rounded-xl border px-3 py-2 text-sm md:text-base",
              "focus:outline-none focus:ring-2 
 focus:ring-indigo-400",
              props.className
            )}
          />
        );
 };
   
        

      const Button = ({ children, variant = "primary", className, ...rest }) => {
        const styles = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700",
          secondary: "bg-slate-100 hover:bg-slate-200",
          danger: "bg-rose-600 text-white hover:bg-rose-700",
          ghost: "bg-transparent hover:bg-slate-100",
        };
 return (
          <button
            {...rest}
            className={classNames(
              "rounded-xl px-4 py-2 text-sm md:text-base transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed",
              styles[variant],
              className
            )}
   
 
          >
            {children}
          </button>
        );
 };
      
      // MODIFIED: Use explicit return for better compatibility with browser-Babel (FIX)
      const Checkbox = (props) => { 
        return (
          <div className="flex items-center">
              <input type="checkbox" 
                  {...props}
                  className="h-4 w-4 rounded border-gray-300 
 text-indigo-600 focus:ring-indigo-500" 
              />
              {props.label && <label htmlFor={props.id} 
                className="ml-2 text-sm text-slate-700">{props.label}</label>}
          </div>
        );
 };
      // NEW: Custom File Upload Component
      function FileUpload({ label, urlKey, unitId, setUnitForm, currentUrl }) {
          const [uploading, setUploading] = useState(false);
 const fileInputRef = useRef(null);

          const handleFileChange = async (event) => {
              const file = event.target.files[0];
 if (!file) return;

              setUploading(true);
              try {
                  const url = await uploadFile(file, unitId, type);
 // Update the unit form state with the new URL
                  setUnitForm(f => ({ ...f, [`${urlKey}Url`]: url }));
 alert(`${label} uploaded successfully!`);
              } catch (error) {
                  console.error("Upload failed:", error);
 alert(`Upload failed for ${label}. Check console for details. Ensure you have enabled Firebase Storage and the security rules allow public writes.`);
 } finally {
                  setUploading(false);
 // Reset file input to allow uploading the same file again
                  if (fileInputRef.current) {
                      fileInputRef.current.value = null;
 }
              }
          };
 return (
              <div className="space-y-1">
                  <label className="text-sm font-medium text-slate-700 block">{label}</label>
                  <input 
                      type="file" 
                    
 
                      ref={fileInputRef}
                      onChange={handleFileChange} 
                      disabled={uploading || !unitId} 
                      className="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 
 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                
                      />
                  {!unitId && <p className="text-xs text-rose-500">Save unit first to enable upload.</p>}
                  {currentUrl && (
           
               <div className="flex items-center text-xs text-emerald-600">
                         
                        <span className="mr-2">‚úÖ File uploaded.</span>
                          <a href={currentUrl} target="_blank" rel="noopener noreferrer" className="underline hover:text-emerald-700">View 
 Document</a>
                      </div>
                  )}
                  {uploading && <p className="text-sm text-indigo-600">Uploading... 
              Please wait.</p>}
              </div>
        
   );
      }
      
      /* ------------- Main App (UPDATED) ------------- */
      function App({ currentUser }) {
        const [data, setData] = useState(initialData);
 const [tab, setTab] = useState("dashboard");
        const [search, setSearch] = useState("");
        const [showReceipt, setShowReceipt] = useState(null); 
        const [loading, setLoading] = useState(true);
 const uid = currentUser.uid; // Get UID from the logged-in user

        // 1. Initial data fetch from cloud
        useEffect(() => {
            setLoading(true);
            // Pass UID to loadData
            loadData(uid).then(initialData => {
                setData(initialData);
        
 
                setLoading(false);
            });
        }, [uid]);
 // Re-run when UID changes (though it shouldn't once logged in)

        // 2. Data Persistence (Debounced Cloud Save)
        const saveTimeout = useRef(null);
 useEffect(() => {
          if (loading || !uid) return; // Do not save until initial load is complete or if no UID

          if (saveTimeout.current) {
            clearTimeout(saveTimeout.current);
          }

          // Set a new timeout to save data after a small delay (500ms)
          saveTimeout.current = setTimeout(() => {
 
            saveData(data, uid); // Pass UID to saveData
          }, 500); 

          return () => {
            if (saveTimeout.current) {
              clearTimeout(saveTimeout.current);
            }
          };
       
  
        }, [data, loading, uid]);


        const units = data.units;
 const payments = data.payments;
        const expenses = data.expenses;
        const org = data.org;
 const totals = useMemo(() => {
          const income = payments.reduce((s, p) => s + Number(p.amount || 0), 0);
          const expense = expenses.reduce((s, e) => s + Number(e.amount || 0), 0);
          return { income, expense, net: income - expense };
        }, [payments, expenses]);
 const outstandingByUnit = useMemo(() => {
          const now = new Date();
          const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
          const map = Object.fromEntries(units.map((u) => [u.id, u.rent || 0]));
          payments
            .filter((p) => (p.forMonth || "").startsWith(ym))
            .forEach((p) => {
       
 
              map[p.unitId] = (map[p.unitId] || 0) - Number(p.amount || 0);
            });
          return map; // positive means due
        }, [units, payments]);
 const filteredUnits = useMemo(() => {
          if (!search) return units;
          const q = search.toLowerCase();
          return units.filter(
            (u) =>
              u.id.toLowerCase().includes(q) ||
              u.name.toLowerCase().includes(q) ||
              (u.tenant 
 
                || "").toLowerCase().includes(q) ||
              (u.type || "").toLowerCase().includes(q)
          );
        }, [units, search]);
 const unitsForReminder = useMemo(() => {
            if (!org.name) return []; 
            return units.filter(u => 
                u.enableReminder && 
                u.tenantPhone && 
                u.rent > 0 && 
        
 
                u.dueDay >= 1 && u.dueDay <= 31 &&
                shouldShowReminder(u.dueDay)
            ).map(u => ({
                ...u,
                whatsappLink: createWhatsAppLink(u.tenantPhone, u.name, org.name, u.dueDay, u.rent)
          
   }));
      
          }, [units, org]);
 // Data helpers
        const updateOrg = (patch) => setData((d) => ({ ...d, org: { ...d.org, ...patch } }));
 const upsertUnit = (unit) =>
          setData((d) => ({
            ...d,
            units: d.units.some((x) => x.id === unit.id)
              ? d.units.map((x) => (x.id === unit.id ? { ...x, ...unit } : x))
              : [...d.units, unit],
          }));
 const deleteUnit = (id) => setData((d) => ({ ...d, units: d.units.filter((u) => u.id !== id) }));
 const addPayment = (p) =>
          setData((d) => ({ ...d, payments: [{ ...p, id: crypto.randomUUID() }, ...d.payments] }));
 const addExpense = (e) =>
          setData((d) => ({ ...d, expenses: [{ ...e, id: crypto.randomUUID() }, ...d.expenses] }));
 const exportData = () => download(`rental-erp-backup-${todayStr()}.json`, JSON.stringify(data, null, 2));
        const importData = (file) => {
          const reader = new FileReader();
 reader.onload = (evt) => {
            try {
              const parsed = JSON.parse(evt.target.result);
 setData(parsed);
              alert("Import successful ‚úÖ");
            } catch (e) {
              alert("Import failed: invalid JSON");
 }
          };
          reader.readAsText(file);
        };
 // Reset / data management actions for Settings
        const clearOrgFields = () =>
          setData((d) => ({ ...d, org: { name: "", address: "", phone: "", email: "", note: "" } }));
 const restoreDemoOrg = () =>
          setData((d) => ({ ...d, org: { ...initialData.org } }));
 const clearPayments = () =>
          setData((d) => ({ ...d, payments: [] }));
 const clearExpenses = () =>
          setData((d) => ({ ...d, expenses: [] }));
 const factoryReset = () => {
          setData({ ...initialData });
        };
 // Auth Action (kept for completeness, but Sign Out button removed in Koder version)
        const handleSignOut = async () => {
            try {
                await auth.signOut();
 } catch (e) {
                console.error("Sign out error:", e);
 alert("Failed to sign out.");
            }
        };
 return (
          <div className="min-h-screen bg-slate-50 text-slate-800">
            {loading && (
              <div className="fixed inset-0 bg-white/70 z-50 flex flex-col items-center justify-center p-8 text-center">
                <div className="h-12 w-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                 <div className="text-xl font-semibold text-indigo-600 mt-4">Loading Data from Cloud...</div>
 
                 <div className="text-sm text-slate-500 mt-2">Connecting to Firebase to sync your data.</div>
              </div>
            )}
            <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
              <div className="mx-auto max-w-6xl px-4 py-3 flex items-center gap-2">
         
                <div className="text-xl md:text-2xl font-bold">üè¢ {data.org.name}</div>
                <div className="ml-auto flex items-center gap-2">
                    <span className="text-xs text-slate-500 hidden sm:inline">User: {currentUser.email}</span>
                  <Button variant="secondary" onClick={exportData}>‚§ì Export</Button>
             
                  <label className="cursor-pointer">
     
                    <span className="inline-block bg-slate-100 hover:bg-slate-200 rounded-xl px-4 py-2 text-sm">Import</span>
                    <input className="hidden" type="file" accept="application/json" onChange={(e) => e.target.files?.[0] && importData(e.target.files[0])} />
                  </label>
               
                {/* NOTE: Sign Out button removed from header to keep layout clean, added to Settings tab */}
                </div>
              </div>
          
           
              <nav className="mx-auto max-w-6xl px-2 pb-3">
                <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
       
                   {[
                    ["dashboard", "Dashboard"],
                    ["units", "Units"],
     
                ["payments", "Payments"],
                    ["newReceipt", "New Receipt"],
                    ["statement", "Statement"], // ADDED: New Statement tab
                    ["expenses", "Expenses"],
               
      ["settings", "Settings"],
                  ].map(([key, label]) => (
                    <Button
                     
                      key={key}
          
                      variant={tab === key ?
 "primary" : "secondary"}
                      className="w-full"
                      onClick={() => setTab(key)}
                      disabled={loading} 
                    >
         
 
                      {label}
                    </Button>
                  ))}
                </div>
              </nav>
          
   </header>

       
            <main className="mx-auto max-w-6xl p-4 space-y-4 md:space-y-6">
              {tab === "dashboard" && (
                <DashboardSection 
                    totals={totals} 
                  
   units={units} 
                    outstandingByUnit={outstandingByUnit} 
                    unitsForReminder={unitsForReminder} 
                    setTab={setTab} 
                />
              )}

    
              {tab === "units" && (
                <Section
  
                  title="Units (Flats & Shops)"
                  right={<Input placeholder="Search units/tenant‚Ä¶" value={search} onChange={(e) => setSearch(e.target.value)} />}
                >
      
             <UnitsTable units={filteredUnits} upsertUnit={upsertUnit} deleteUnit={deleteUnit} />
                </Section>
  
              )}

              {tab === "payments" && (
                <Section title="Payments (tap a row for receipt)">
            
       <PaymentsTable payments={payments} units={units} onRowClick={setShowReceipt} />
                </Section>
          
              )}

              {tab === "newReceipt" && (
                <Section title="Create Money Receipt">
             
             <NewReceiptForm units={units} addPayment={addPayment} data={data} />
                </Section>
              )}
              
              {/* ADDED: New Statement Tab (REQUEST 2) */}
              {tab === "statement" && (
        
                 <Section title="Income & Expense Statement">
                    <DateRangeStatement payments={payments} expenses={expenses} />
                </Section>
              )}

       
              {tab === "expenses" && (
          
               <Section title="Expenses">
                  <ExpensesSection expenses={expenses} addExpense={addExpense} />
                </Section>
              )}

              {tab === "settings" && 
   
                (
     
                   <Section title="Organization Settings">
                  <OrgSettings
                    org={data.org}
                    updateOrg={updateOrg}
             
                
                    clearOrgFields={clearOrgFields}
                    restoreDemoOrg={restoreDemoOrg}
                    clearPayments={() => { if (confirm("Clear ALL payments?
 This will remove every receipt...")) clearPayments(); }}
                    clearExpenses={() => { if (confirm("Clear ALL expenses? This will remove every expense entry...")) clearExpenses(); }}
                    factoryReset={() => { if (confirm("DANGER: Factory Reset? This will delete all your data and restore the demo data.")) factoryReset(); }}
                    handleSignOut={handleSignOut} // <-- ADDED: Pass the sign out function
                  />
   
               </Section>
              )}

              {showReceipt && (
                <ReceiptModal 
                  org={data.org} 
                  payment={showReceipt} 
  
                  unit={units.find((u) => u.id === showReceipt.unitId)} 
                  onClose={() => setShowReceipt(null)} 
                />
              )}

            </main>
          </div>
      
   );
      }
      
      /* ------------- Login/Auth Components (NEW) ------------- */
      function LoginScreen({ setAuthError }) {
          const [email, setEmail] = useState("");
          const [password, setPassword] = useState("");
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState("");

          const handleLogin = async (e) => {
              e.preventDefault();
              setError("");
              setLoading(true);
              try {
                  await auth.signInWithEmailAndPassword(email, password);
                  // Success: AuthStatusWrapper handles state change
              } catch (err) {
                  console.error("Login failed:", err);
                  if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential') {
                      setError("Invalid email or password.");
                  } else if (err.code === 'auth/invalid-email') {
                      setError("Invalid email format.");
                  } else {
                      setError("Login failed. Check console for details.");
                  }
                  // Notify parent wrapper about auth error if needed (though onAuthStateChanged will handle it)
                  setAuthError(error);
              } finally {
                  setLoading(false);
              }
          };

          return (
              <div className="min-h-screen flex items-center justify-center bg-slate-50 p-4">
                  <div className="w-full max-w-sm bg-white rounded-2xl shadow-xl p-6 space-y-4">
                      <h1 className="text-2xl font-bold text-center text-indigo-700">Mobile ERP Login</h1>
                      <p className="text-center text-sm text-slate-500">Please sign in to continue.</p>
                      
                      {error && (
                          <div className="bg-rose-100 border border-rose-400 text-rose-700 px-4 py-3 rounded relative text-sm" role="alert">
                              <span className="block sm:inline">{error}</span>
                          </div>
                      )}

                      <form onSubmit={handleLogin} className="space-y-4">
                          <Input
                              type="email"
                              placeholder="Email"
                              value={email}
                              onChange={(e) => setEmail(e.target.value)}
                              required
                          />
                          <Input
                              type="password"
                              placeholder="Password"
                              value={password}
                              onChange={(e) => setPassword(e.target.value)}
                              required
                          />
                          <Button 
                              type="submit" 
                              className="w-full" 
                              disabled={loading}
                          >
                              {loading ? "Signing In..." : "Log In"}
                          </Button>
                          <p className="text-xs text-center text-slate-500">
                             (No signup option available)
                          </p>
                      </form>
                  </div>
              </div>
          );
      }

      function AuthStatusWrapper() {
          const [currentUser, setCurrentUser] = useState(null);
          const [loadingAuth, setLoadingAuth] = useState(true);
          const [authError, setAuthError] = useState(null);

          useEffect(() => {
              const unsubscribe = auth.onAuthStateChanged(user => {
                  setCurrentUser(user);
                  setLoadingAuth(false);
                  setAuthError(null);
              });
              return () => unsubscribe();
          }, []);

          if (loadingAuth) {
              return (
                  <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-slate-50">
                      <div className="h-12 w-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                      <div className="text-xl font-semibold text-indigo-600 mt-4">Checking Session...</div>
                  </div>
              );
          }

          if (!currentUser) {
              return <LoginScreen setAuthError={setAuthError} />;
          }

          return <App currentUser={currentUser} />;
      }
      
      /* ------------- Dashboard (MODIFIED - Removed Monthly Summary) ------------- */
      function DashboardSection({ totals, units, outstandingByUnit, unitsForReminder, setTab }) { 
        const totalDue = Object.values(outstandingByUnit).reduce((s, v) => s + Math.max(0, v), 0);
 return (
          <div className="space-y-4">
            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
              <StatCard label="Total Income" value={currency(totals.income)} />
              <StatCard label="Total Expenses" value={currency(totals.expense)} />
              <StatCard label="Net Profit" value={currency(totals.net)} />
              <StatCard label="Current Month 
 Due" value={currency(totalDue)} />

              {/* NEW: Reminder card */}
              {unitsForReminder.length > 0 && (
                <div className="col-span-2 md:col-span-4">
                  <Section title="‚ö†Ô∏è Rent Reminder Needed Today">
                    <div 
 className="space-y-2">
                      {unitsForReminder.map(u => (
                        <div key={u.id} className="flex items-center justify-between rounded-xl border border-indigo-200 bg-indigo-50 p-3">
                          <div className="font-medium">{u.name} (Due: {u.dueDay}th)</div>
              
             <a href={u.whatsappLink} target="_blank" rel="noopener noreferrer">
                            <Button variant="primary" className="text-sm"> Send WhatsApp to {u.tenant} </Button>
                          </a>
                       
 </div>
                      ))}
                    </div>
                    <div className="text-xs text-slate-500 mt-2">These units are 2 days from their due date and have reminders enabled.</div>
                  </Section>
    
             </div>
              )}
              {/* End of NEW: Reminder card */}

              <div className="col-span-2 md:col-span-4">
                <Section title="Quick Actions" right={<div />}>
                  
 <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <Button className="w-full" onClick={() => setTab("newReceipt")}>New Receipt</Button>
                    <Button variant="secondary" className="w-full" onClick={() => setTab("statement")}>View Statement</Button>
                    <Button variant="secondary" className="w-full" onClick={() => setTab("units")}>Manage Units</Button>
                   
  <Button variant="secondary" className="w-full" onClick={() => setTab("expenses")}>Add Expense</Button>
                  </div>
                </Section>
              </div>

            </div>

            <Section title="Current Month Dues by Unit">
              <div className="grid 
 grid-cols-1 md:grid-cols-2 gap-2">
                {units.map((u) => (
                  <div key={u.id} className="flex items-center justify-between rounded-xl border p-3">
                    <div>
                      <div className="font-medium">{u.name}</div>
            
           <div className="text-xs text-slate-500">{u.tenant ||
 "Vacant"}</div>
                    </div>
                    <div className={outstandingByUnit[u.id] > 0 ?
 "text-rose-600 font-semibold" : "text-emerald-600 font-semibold"}>
                      {currency(outstandingByUnit[u.id])}
                    </div>
                  </div>
                ))}
              </div>
      
       </Section>
          </div>
        );
 }
      
      /* ------------- Date Range Statement Component (MODIFIED - Date Logic Fixed) ------------- */
      function DateRangeStatement({ payments, expenses }) {
        // Helper to get the first day of the current month (YYYY-MM-DD)
        const getFirstDayOfMonth = (date) => new Date(date.getFullYear(), date.getMonth(), 1).toISOString().slice(0, 10);
 // Default range: current month
        const [startDate, setStartDate] = useState(getFirstDayOfMonth(new Date()));
 const [endDate, setEndDate] = useState(todayStr());

        const filteredData = useMemo(() => {
            // Helper function to create a date object normalized to local midnight
            // This is crucial for accurate date-range filtering, avoiding UTC/timezone issues
            const getLocalDateTimestamp = (dateStr) => {
                if (!dateStr) return 0; // dateStr is 'YYYY-MM-DD'
                const parts = dateStr.split('-');
                // Date(year, month-1, day) creates a date at midnight in the local timezone
                return new Date(parts[0], parts[1] - 1, parts[2]).getTime();
            };

            // 1. Calculate the start boundary (local midnight of start date)
            const start = getLocalDateTimestamp(startDate);
            // 2. Calculate the end boundary (local midnight of the day *after* the end date)
            // Get the local midnight of the end date, then add one day's worth of milliseconds
            const end = getLocalDateTimestamp(endDate) + (24 * 60 * 60 * 1000);
            
            const isWithinRange = (dateStr) => {
                if (!dateStr) return false;
                const checkDate = getLocalDateTimestamp(dateStr);
                // Check if checkDate >= start AND checkDate < end (exclusive of end day)
                return checkDate >= start && checkDate < end;
            };

            const incomeList = payments.filter(p => isWithinRange(p.date));
            const expenseList = expenses.filter(e => isWithinRange(e.date));

            const totalIncome = incomeList.reduce((sum, p) => sum + Number(p.amount || 0), 0);
            const totalExpense = expenseList.reduce((sum, e) => sum + Number(e.amount || 0), 0);
            const netProfit = totalIncome - totalExpense;

            const combinedList = [
                ...incomeList.map(p => ({
                    id: `P-${p.id}`,
                    date: p.date,
                    description: `${p.purpose || "Rent"} received for ${p.unitId} (${p.tenant}) - Month: ${formatMonth(p.forMonth)}`,
                    type: 'Income',
                    amount: Number(p.amount || 0),
                })),
                ...expenseList.map(e => ({
                    id: `E-${e.id}`,
                    date: e.date,
                    description: `Expense: ${e.category} (${e.notes || e.vendor || 'N/A'})`,
                    type: 'Expense',
                    amount: Number(e.amount || 0),
                })),
            ].sort((a, b) => new Date(a.date) - new Date(b.date)); // Sort by date ascending

            return { combinedList, totalIncome, totalExpense, netProfit };
        }, [payments, expenses, startDate, endDate]);

        return (
            <div className="space-y-4">
                <div className="grid grid-cols-2 gap-2">
                    <div>
                        <label className="text-sm font-medium block mb-1">Start Date</label>
                        <Input 
                            type="date" 
                            value={startDate} 
                            onChange={(e) => setStartDate(e.target.value)}
                            style={{ width: "auto", height: "auto", padding: "auto", fontSize: "16px", }}
                        />
                    </div>
                    <div>
                        <label className="text-sm font-medium block mb-1">End Date</label>
                        <Input 
                            type="date" 
                            value={endDate} 
                            onChange={(e) => setEndDate(e.target.value)}
                            style={{ width: "auto", height: "auto", padding: "auto", fontSize: "16px", }}
                        />
                    </div>
                </div>

                <div className="grid grid-cols-3 gap-3 md:gap-4 border-t pt-4">
                    <StatCard label="Total Income" value={currency(filteredData.totalIncome)} />
                    <StatCard label="Total Expense" value={currency(filteredData.totalExpense)} />
                    <StatCard label="Net Profit" value={currency(filteredData.netProfit)} />
                </div>

                <div className="overflow-auto rounded-2xl border">
                    <table className="min-w-full text-sm">
                        <thead className="bg-slate-100 text-slate-600">
                            <tr>
                                <th className="p-3 text-left">Date</th>
                                <th className="p-3 text-left">Description</th>
                                <th className="p-3 text-left">Type</th>
                                <th className="p-3 text-right">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {filteredData.combinedList.length === 0 ?
                            (
                                <tr><td colSpan="4" className="p-3 text-center text-slate-500">No transactions found in this date range.</td></tr>
                            ) : (
                                filteredData.combinedList.map((item, index) => (
                                    <tr key={item.id} className={classNames("border-t", item.type === 'Income' ? 'hover:bg-emerald-50/50' : 'hover:bg-rose-50/50')}>
                                        <td className="p-3">{item.date}</td>
                                        <td className="p-3 max-w-xs">{item.description}</td>
                                        <td className="p-3">{item.type}</td>
                                        <td className={classNames("p-3 text-right font-semibold", item.type === 'Income' ? 'text-emerald-600' : 'text-rose-600')}>
                                            {currency(item.amount)}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        );
      }

      /* ------------- Unit Management (MODIFIED - File Uploads) ------------- */
      function UnitForm({ initialUnit, upsertUnit, deleteUnit }) {
        const [unitForm, setUnitForm] = useState(initialUnit || {
          id: "",
          type: "Flat",
          name: "",
          floor: "",
          rent: "",
          dueDay: 5,
          tenant: "",
          tenantPhone: "",
          tenantPhotoUrl: "", // NEW
          tenantNidUrl: "", // NEW
          rentAgreementUrl: "", // NEW
          enableReminder: true, // NEW
        });
        const reset = () =>
          setUnitForm({
            id: "",
            type: "Flat",
            name: "",
            floor: "",
            rent: "",
            dueDay: 5,
            tenant: "",
            tenantPhone: "",
            tenantPhotoUrl: "",
            tenantNidUrl: "",
            rentAgreementUrl: "",
            enableReminder: true,
          });
        const save = () => {
          if (!unitForm.id || !unitForm.name) return alert("ID and Name are required.");
          upsertUnit({ ...unitForm, floor: Number(unitForm.floor || 0), rent: Number(unitForm.rent || 0), dueDay: Number(unitForm.dueDay || 1) });
          reset();
        };
        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Add / Edit Unit</div>
              <div className="grid gap-2">
                <div className="grid grid-cols-2 gap-2">
                  <Input placeholder="Unit ID (e.g., F1)" value={unitForm.id || ""} onChange={(e) => setUnitForm({ ...unitForm, id: e.target.value })} />
                  <Select value={unitForm.type} onChange={(e) => setUnitForm({ ...unitForm, type: e.target.value })}>
                    <option>Flat</option>
                    <option>Shop</option>
                  </Select>
                </div>
                <Input placeholder="Name" value={unitForm.name || ""} onChange={(e) => setUnitForm({ ...unitForm, name: e.target.value })} />
                <Input type="number" placeholder="Floor" value={unitForm.floor ?? ""} onChange={(e) => setUnitForm({ ...unitForm, floor: Number(e.target.value) })} />
                <Input type="number" placeholder="Monthly Rent" value={unitForm.rent ?? ""} onChange={(e) => setUnitForm({ ...unitForm, rent: e.target.value })} />
                <Input type="number" placeholder="Due 
 Day (1-28)" value={unitForm.dueDay ?? ""} onChange={(e) => setUnitForm({ ...unitForm, dueDay: e.target.value })} />
                <Input placeholder="Tenant Name" value={unitForm.tenant ||
 ""} onChange={(e) => setUnitForm({ ...unitForm, tenant: e.target.value })} />
                <Input placeholder="Tenant Phone (for WhatsApp)" value={unitForm.tenantPhone ||
 ""} onChange={(e) => setUnitForm({ ...unitForm, tenantPhone: e.target.value })} />
                {/* NEW: Reminder Toggle */}
                <Checkbox id="enableReminder" label="Enable 2-day Rent Reminder (WhatsApp)" checked={unitForm.enableReminder} onChange={(e) => setUnitForm({ ...unitForm, enableReminder: e.target.checked })} />
                <hr className="my-2 border-slate-200" />
                {/* MODIFIED: File Uploads */}
                <div className="font-medium text-sm mb-2">Tenant Documents (Upload)</div>
                <FileUpload label="Tenant Photo" urlKey="tenantPhoto" unitId={unitForm.id} setUnitForm={setUnitForm} currentUrl={unitForm.tenantPhotoUrl} />
                <FileUpload label="NID Scan/Photo" urlKey="tenantNid" unitId={unitForm.id} setUnitForm={setUnitForm} currentUrl={unitForm.tenantNidUrl} />
                <FileUpload label="Rent Agreement" urlKey="rentAgreement" unitId={unitForm.id} setUnitForm={setUnitForm} currentUrl={unitForm.rentAgreementUrl} />
                <hr className="my-2 border-slate-200" />
              </div>
              <div className="flex gap-2">
                <Button onClick={save}>Save Unit</Button>
                {initialUnit && <Button variant="secondary" onClick={reset}>Clear Form</Button>}
              </div>
            </div>
            <div className="md:col-span-2 space-y-3">
              <div className="font-semibold">Unit List</div>
              <UnitsListTable units={units} setUnitForm={setUnitForm} deleteUnit={deleteUnit} />
            </div>
          </div>
        );
      }

      function UnitsListTable({ units, setUnitForm, deleteUnit }) {
        const [showProfile, setShowProfile] = useState(null);

        // Helper for document links in the modal
        const DocumentLink = ({ label, url }) => (
            <p className="text-sm">
                <span className="font-medium text-slate-500">{label}:</span> 
                {url ? (
                    <a href={url} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:underline ml-1">View Document</a>
                ) : (
                    <span className="ml-1 text-rose-500">Not Uploaded</span>
                )}
            </p>
        );

        function TenantProfileModal({ unit, onClose }) {
            return (
                <div className="fixed inset-0 z-50 bg-black/50 flex items-end md:items-center justify-center p-0 md:p-6">
                    <div className="bg-white w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-xl">
                        <div className="p-3 border-b flex items-center justify-between">
                            <div className="font-semibold text-lg">Tenant Profile: {unit.tenant} ({unit.name})</div>
                            <Button variant="danger" onClick={onClose}>Close</Button>
                        </div>
                        <div className="p-4 overflow-y-auto max-h-[80vh]">
                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="space-y-3">
                                    <h3 className="text-lg font-semibold border-b pb-2">Tenant Details</h3>
                                    <p className="text-sm"><span className="font-medium text-slate-500">Name:</span> {unit.tenant || 'N/A'}</p>
                                    <p className="text-sm"><span className="font-medium text-slate-500">Phone:</span> {unit.tenantPhone || 'N/A'}</p>
                                    <p className="text-sm"><span className="font-medium text-slate-500">Unit:</span> {unit.name}</p>
                                    <p className="text-sm"><span className="font-medium text-slate-500">Rent:</span> {currency(unit.rent)}</p>
                                    <p className="text-sm"><span className="font-medium text-slate-500">Due Day:</span> {unit.dueDay}th</p>
                                    <p className="text-sm">
                                        <span className="font-medium text-slate-500">Reminder:</span> 
                                        <span className={unit.enableReminder ?
                                            'text-emerald-600' : 'text-rose-600'}> 
                                            {unit.enableReminder ? 'Enabled' : 'Disabled'} 
                                        </span>
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    <h3 className="text-lg font-semibold border-b pb-2">Documents</h3>
                                    <DocumentLink label="Tenant Photo" url={unit.tenantPhotoUrl} />
                                    <DocumentLink label="NID Scan/Photo" url={unit.tenantNidUrl} />
                                    <DocumentLink label="Rent Agreement" url={unit.rentAgreementUrl} />
                                    <p className="text-xs text-slate-500 pt-2">Note: Click "View Document" to open the uploaded file in a new tab.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const handleDelete = (unit) => {
          if (confirm(`Are you sure you want to delete unit ${unit.name} (${unit.id})? This action cannot be undone.`)) {
            deleteUnit(unit.id);
          }
        };

        return (
          <>
            <div className="overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600">
                  <tr>
                    <th className="p-3 text-left">ID</th>
                    <th className="p-3 text-left">Name</th>
                    <th className="p-3 text-left">Tenant</th>
                    <th className="p-3 text-right">Rent</th>
                    <th className="p-3 text-left">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {units.map((u) => (
                    <tr key={u.id} className="border-t hover:bg-slate-50">
                      <td className="p-3 font-medium">{u.id}</td>
                      <td className="p-3">{u.name}</td>
                      <td className="p-3">{u.tenant || "‚Äî"}</td>
                      <td className="p-3 text-right">{currency(u.rent)}</td>
                      <td className="p-3 flex gap-1">
                        <Button variant="ghost" className="px-2 py-1 text-xs" onClick={() => setUnitForm(u)}>
                          Edit
                        </Button>
                        <Button variant="secondary" className="px-2 py-1 text-xs" onClick={() => setShowProfile(u)}>
                            Profile
                        </Button>
                        <Button variant="danger" className="px-2 py-1 text-xs" onClick={() => handleDelete(u)}>
                          Delete
                        </Button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            {showProfile && <TenantProfileModal unit={showProfile} onClose={() => setShowProfile(null)} />}
          </>
        );
      }
      
      function UnitsTable(props) {
        return (
          <UnitForm {...props} units={props.units} />
        );
      }

      /* ------------- Payments (unchanged) ------------- */
      function PaymentsTable({ payments, units, onRowClick }) {
        const list = useMemo(() => payments.sort((a, b) => new Date(b.date) - new Date(a.date)), [payments]);
        return (
          <div className="space-y-4">
            <div className="text-sm text-slate-500">
              Total {list.length} payments. Sorted by date descending.
            </div>
            <div className="overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600">
                  <tr>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3 text-left">Receipt #</th>
                    <th className="p-3 text-left">Unit</th>
                    <th className="p-3 text-left">Tenant</th>
                    <th className="p-3 text-right">Amount</th>
                    <th className="p-3 text-left">Month</th>
                    <th className="p-3 text-left">Method</th>
                  </tr>
                </thead>
                <tbody>
                  {list.map((p) => (
                    <tr key={p.id} className="border-t hover:bg-slate-50 cursor-pointer" onClick={() => onRowClick(p)}>
                      <td className="p-3">{p.date}</td>
                      <td className="p-3 font-medium">{p.receiptNo}</td>
                      <td className="p-3">{units.find((u) => u.id === p.unitId)?.name || p.unitId}</td>
                      <td className="p-3">{p.tenant}</td>
                      <td className="p-3 text-right font-semibold">{currency(p.amount)}</td>
                      <td className="p-3">{formatMonth(p.forMonth)}</td>
                      <td className="p-3">{p.method}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      /* ------------- New Receipt (unchanged from last modified version) ------------- */
      function NewReceiptForm({ units, addPayment, data }) {
        const [form, setForm] = useState({ date: todayStr(), method: "Cash", purpose: "Rent" });
        // ADDED purpose
        useEffect(() => {
          if (!form.receiptNo) setForm((f) => ({ ...f, receiptNo: nextReceiptNo(data.payments) }));
        }, [data.payments, form.receiptNo]);

        // When a unit is selected, auto-fill tenant and rent amount
        const unit = useMemo(() => units.find((u) => u.id === form.unitId), [units, form.unitId]);
        useEffect(() => {
          if (unit) {
            setForm((f) => ({ ...f, tenant: unit.tenant, amount: unit.rent || "" }));
          }
        }, [unit]);

        const resetForm = () => setForm({ date: todayStr(), method: "Cash", purpose: "Rent", receiptNo: nextReceiptNo(data.payments) });
        // ADDED purpose
        // MODIFIED SUBMIT FUNCTION FOR CLEARER VALIDATION (Issue #1 fix)
        const submit = () => {
          if (!form.unitId) return alert("Please select a Unit.");
          if (!form.tenant) return alert("Please enter Tenant Name.");
          if (!form.amount) return alert("Please enter Amount.");
          if (!form.forMonth) return alert("Please select For Month.");
          // purpose is not required if it defaults to Rent
          addPayment({ ...form, amount: Number(form.amount || 0), purpose: form.purpose || "Rent" });
          // Use "Rent" as fallback
          alert(`Receipt ${form.receiptNo} created ‚úÖ`);
          setForm({ date: todayStr(), method: "Cash", purpose: "Rent", receiptNo: nextReceiptNo(data.payments) });
        };

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-2 space-y-3 bg-slate-50 border rounded-2xl p-4">
              <div className="grid gap-2">
                <Input type="date" value={form.date || todayStr()} onChange={(e) => setForm({ ...form, date: e.target.value })} />
                <Input placeholder="Receipt No (Auto)" value={form.receiptNo || ""} disabled />
                <Select value={form.purpose || "Rent"} onChange={(e) => setForm({ ...form, purpose: e.target.value })}>
                    <option>Rent</option>
                    <option>Advance</option>
                    <option>Security Deposit</option>
                    <option>Other</option>
                </Select>
                <div className="grid grid-cols-2 gap-2">
                  <Select value={form.unitId || ""} onChange={(e) => setForm({ ...form, unitId: e.target.value })}>
                    <option value="">Select Unit (ID - Name) </option>
                    {units.map((u) => (
                      <option key={u.id} value={u.id}>
                        {u.id} - {u.name}
                      </option>
                    ))}
                  </Select>
                  <Input type="month" value={form.forMonth ||
 ""} style={{ width: "auto", height: "auto", padding: "auto", fontSize: "16px", }} onChange={(e) => setForm({ ...form, forMonth: e.target.value })} />
                </div>
                <Input placeholder="Tenant Name (Auto-filled from Unit)" value={form.tenant ||
 ""} onChange={(e) => setForm({ ...form, tenant: e.target.value })} />
                <Input type="number" placeholder="Amount (‡ß≥)" value={form.amount ??
 ""} onChange={(e) => setForm({ ...form, amount: e.target.value })} />
                <Select value={form.method ||
 ""} onChange={(e) => setForm({ ...form, method: e.target.value })}>
                  <option>Cash</option>
                  <option>Bank Transfer</option>
                  <option>Mobile Banking (Bkash/Nagad)</option>
                  <option>Cheque</option>
                </Select>
                <Input placeholder="Notes (Optional)" value={form.notes ||
 ""} onChange={(e) => setForm({ ...form, notes: e.target.value })} />
                <div className="flex gap-2">
                  <Button onClick={submit}>Create Receipt (No. {form.receiptNo})</Button>
                  <Button variant="secondary" onClick={resetForm}>Reset Form</Button>
                </div>
              </div>
            </div>
            <div className="md:col-span-1 bg-white border rounded-2xl p-4 space-y-3">
              <div className="font-semibold border-b pb-2">Unit Details</div>
              {unit ?
 (
                <div className="text-sm space-y-1">
                  <div><span className="text-slate-500">Name:</span> {unit.name}</div>
                  <div><span className="text-slate-500">Type:</span> {unit.type}</div>
                  <div><span className="text-slate-500">Rent:</span> {currency(unit.rent)}</div>
                  <div><span className="text-slate-500">Tenant:</span> {unit.tenant || "‚Äî"}</div>
                </div>
              ) : (
                <div className="text-sm text-slate-500">Select a unit to preview details.</div>
              )}
            </div>
          </div>
        );
      }

      /* ------------- Expenses (unchanged) ------------- */
      function ExpensesSection({ expenses, addExpense }) {
        const [form, setForm] = useState({ date: todayStr() });
        const list = useMemo(() => expenses.sort((a, b) => new Date(b.date) - new Date(a.date)), [expenses]);

        const resetForm = () => setForm({ date: todayStr() });
        const submit = () => {
          if (!form.category || !form.amount) return alert("Fill Category and Amount");
          addExpense({ ...form, amount: Number(form.amount || 0) });
          alert(`Expense '${form.category}' recorded ‚úÖ`);
          resetForm();
        };

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 space-y-3 bg-slate-50 border rounded-2xl p-3">
              <div className="font-semibold">Add New Expense</div>
              <div className="grid gap-2">
                <Input type="date" value={form.date || todayStr()} onChange={(e) => setForm({ ...form, date: e.target.value })} />
                <Input placeholder="Category (e.g., Repair, Utility)" value={form.category || ""} onChange={(e) => setForm({ ...form, category: e.target.value })} />
                <Input placeholder="Vendor / Payee (Optional)" value={form.vendor || ""} onChange={(e) => setForm({ ...form, vendor: e.target.value })} />
                <Input type="number" placeholder="Amount (‡ß≥)" value={form.amount ?? ""} onChange={(e) => setForm({ ...form, amount: e.target.value })} />
                <Input placeholder="Notes (Optional)" value={form.notes || ""} onChange={(e) => setForm({ ...form, notes: e.target.value })} />
                <div className="flex gap-2 pt-1">
                  <Button onClick={submit}>Record Expense</Button>
                  <Button variant="secondary" onClick={resetForm}>Reset Form</Button>
                </div>
              </div>
            </div>
            <div className="md:col-span-2 space-y-3">
              <div className="font-semibold">Expense History</div>
              <div className="overflow-auto rounded-2xl border">
                <table className="min-w-full text-sm">
                  <thead className="bg-slate-100 text-slate-600">
                    <tr>
                      <th className="p-3 text-left">Date</th>
                      <th className="p-3 text-left">Category</th>
                      <th className="p-3 text-left">Vendor</th>
                      <th className="p-3 text-right">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    {list.map((e) => (
                      <tr key={e.id} className="border-t hover:bg-slate-50">
                        <td className="p-3">{e.date}</td>
                        <td className="p-3 font-medium">{e.category}</td>
                        <td className="p-3">{e.vendor}</td>
                        <td className="p-3 text-right text-rose-600 font-semibold">{currency(e.amount)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        );
      }

      /* ------------- OrgSettings (MODIFIED - Added Sign Out Button) ------------- */
      function OrgSettings({ org, updateOrg, clearOrgFields, restoreDemoOrg, clearPayments, clearExpenses, factoryReset, handleSignOut }) { // <-- MODIFIED
        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-2 space-y-3 bg-slate-50 border rounded-2xl p-3">
              <div className="font-semibold border-b pb-2">Your Organization / Property Info</div>
              <Input placeholder="Name (e.g., Foyaz Properties)" value={org.name || ""} onChange={(e) => updateOrg({ name: e.target.value })} />
              <Input placeholder="Address" value={org.address ||
 ""} onChange={(e) => updateOrg({ address: e.target.value })} />
              <Input placeholder="Phone" value={org.phone ||
 ""} onChange={(e) => updateOrg({ phone: e.target.value })} />
              <Input placeholder="Email" value={org.email ||
 ""} onChange={(e) => updateOrg({ email: e.target.value })} />
              <Input placeholder="Receipt Note" value={org.note ||
 ""} onChange={(e) => updateOrg({ note: e.target.value })} />
              <div className="flex gap-2 pt-1">
                <Button variant="secondary" onClick={clearOrgFields}>Reset Org Fields</Button>
                <Button variant="secondary" onClick={restoreDemoOrg}>Restore Demo Org</Button>
              </div>
            </div>
            <div className="space-y-3 bg-slate-50 border rounded-2xl p-3">
              <div className="text-sm text-slate-500">Data Management / Reset</div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                <Button variant="danger" onClick={clearPayments}>Clear ALL Payments</Button>
                <Button variant="danger" onClick={clearExpenses}>Clear ALL Expenses</Button>
                <Button variant="danger" onClick={factoryReset}>Factory Reset (Everything)</Button>
              </div>
              
              {/* NEW LOGOUT BUTTON */}
              <div className="pt-4 border-t mt-4">
                  <div className="font-semibold text-base mb-2">User Session</div>
                  <Button variant="danger" className="w-full" onClick={handleSignOut}>
                      Sign Out / Log Out
                  </Button>
              </div>
              
              <div className="text-xs text-slate-500"> ‚Ä¢ Clearing payments removes all receipts.
 <br/> ‚Ä¢ Clearing expenses removes all expense entries. <br/> ‚Ä¢ Factory Reset restores the initial demo data and removes all custom data.
              </div>
            </div>
          </div>
        );
      }

      /* ------------- Receipt Modal (unchanged) ------------- */
      function StatCard({ label, value }) {
        return (
          <div className="bg-white rounded-xl shadow p-4 border space-y-1">
            <div className="text-sm text-slate-500 font-medium">{label}</div>
            <div className="text-xl font-bold">{value}</div>
          </div>
        );
      }
      
      function ReceiptModal({ org, payment, unit, onClose }) {
        const unitName = unit?.name || payment.unitId || "N/A";
        const formattedMonth = formatMonth(payment.forMonth);
        const amountInWords = amountToWords(payment.amount);
        
        const printReceipt = () => {
          const content = generateReceiptHTML(org, payment, unit);
          const printWindow = window.open('', '_blank');
          printWindow.document.write(content);
          printWindow.document.close();
          printWindow.focus();
          // Timeout to ensure content is rendered before print dialog appears
          setTimeout(() => {
              printWindow.print();
          }, 500);
        }

        return (
          <div className="fixed inset-0 z-50 bg-black/50 flex items-end md:items-center justify-center p-0 md:p-6">
            <div className="bg-white w-full md:max-w-xl rounded-t-2xl md:rounded-2xl shadow-xl">
              <div className="p-3 border-b flex items-center justify-between">
                <div className="font-semibold text-lg">Money Receipt: {payment.receiptNo}</div>
                <div className="flex gap-2">
                    <Button variant="secondary" onClick={printReceipt}>Print / PDF</Button>
                    <Button variant="danger" onClick={onClose}>Close</Button>
                </div>
              </div>
              <div className="p-4 overflow-y-auto max-h-[80vh]">
                <div className="p-6 border border-slate-300 rounded-xl space-y-4">
                  <div className="text-center border-b-2 border-slate-300 pb-2">
                    <h1 className="text-2xl font-bold text-indigo-700">{org.name}</h1>
                    <p className="text-xs text-slate-500">{org.address} | Phone: {org.phone} | Email: {org.email}</p>
                  </div>
                  
                  <div className="text-center">
                      <h2 className="text-xl font-bold border-b border-indigo-300 inline-block px-4 pb-1 text-indigo-700">MONEY RECEIPT</h2>
                  </div>

                  <div className="flex justify-between text-sm">
                    <p><strong>Receipt No:</strong> {payment.receiptNo}</p>
                    <p><strong>Date:</strong> {payment.date}</p>
                  </div>
                  
                  <div className="text-sm space-y-1">
                    <p><strong>Received From:</strong> {payment.tenant}</p>
                    <p><strong>Amount:</strong> <span className="font-semibold text-lg text-emerald-600">{currency(payment.amount)}</span></p>
                    <p><strong>Amount in Words:</strong> <span className="italic">{amountInWords}</span></p>
                    <p><strong>For Rent/Purpose of:</strong> {payment.purpose || "Rent"} for {unitName}</p>
                    <p><strong>Month:</strong> {formattedMonth}</p>
                    <p><strong>Payment Method:</strong> {payment.method}</p>
                    {payment.notes && <p><strong>Notes:</strong> {payment.notes}</p>}
                  </div>

                  <div className="flex justify-between items-end pt-8 text-sm">
                    <div className="border-t border-slate-400 pt-1 text-center">
                        Receiver's Signature
                    </div>
                    <div className="text-right">
                        <p className="text-xs italic text-slate-500">{org.note}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      function escapeHTML(str) {
        return String(str || "").replace(/[&<>'"/]/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;","/":"&#x2F;"}[c] || c));
      }
      
      // MODIFIED: Simplified receipt structure, reduced font sizes and padding for minimal height.
      function renderReceiptInner(org, payment, unit) {
        const amountInWords = amountToWords(payment.amount);
        const unitName = unit?.name || payment.unitId || "N/A";
        const formattedMonth = formatMonth(payment.forMonth);

        return `
 <div style="font-family: Times New Roman, system-ui, sans-serif; max-width: 190mm; margin: 0 auto; padding: 0;">
 <div style="text-align:center; padding-bottom:4px; border-bottom:3px solid #e2e8f0;">
 <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0;">${escapeHTML(org.name)}</h1>
 <p style="font-size: 0.65rem; color: #475569; margin: 0;">${escapeHTML(org.address)} |
 Phone: ${escapeHTML(org.phone)} | Email: ${escapeHTML(org.email)}</p>
 </div>
 
 <div style="text-align:center; margin-top: 10px; margin-bottom: 10px;">
 <h2 style="font-size: 1.1rem; font-weight: 700; border-bottom: 1px solid #94a3b8; display: inline-block; padding: 0 16px 2px; color: #4338ca;">MONEY RECEIPT</h2>
 </div>

 <div style="display:flex; justify-content:space-between; font-size: 0.75rem; margin-bottom: 8px;">
 <p><strong>Receipt No:</strong> ${escapeHTML(payment.receiptNo)}</p>
 <p><strong>Date:</strong> ${escapeHTML(payment.date)}</p>
 </div>
 
 <div style="font-size: 0.7rem; line-height: 1.4; margin-bottom: 10px; padding-left: 2px;">
 <p style="margin: 2px 0;"><strong>Received From:</strong> ${escapeHTML(payment.tenant)}</p>
 <p style="margin: 2px 0;"><strong>Amount:</strong> <span style="font-weight: 700; font-size: 1rem; color: #059669;">${escapeHTML(currency(payment.amount))}</span></p>
 <p style="margin: 2px 0;"><strong>Amount in Words:</strong> <span style="font-style: italic;">${escapeHTML(amountInWords)}</span></p>
 <p style="margin: 2px 0;"><strong>For Rent/Purpose of:</strong> ${escapeHTML(payment.purpose || "Rent")} for ${escapeHTML(unitName)}</p>
 <p style="margin: 2px 0;"><strong>Month:</strong> ${escapeHTML(formattedMonth)}</p>
 <p style="margin: 2px 0;"><strong>Payment Method:</strong> ${escapeHTML(payment.method)}</p>
 ${payment.notes ? `<p style="margin: 2px 0;"><strong>Notes:</strong> ${escapeHTML(payment.notes)}</p>` : ''}
 </div>

 <div style="display:flex; justify-content:space-between; align-items:flex-end; padding-top: 16px; font-size: 0.75rem;">
 <div style="border-top: 1px solid #64748b; padding-top: 2px; text-align:center;">
 Receiver's Signature
 </div>
 <div style="text-align:right;">
 <p style="font-size: 0.6rem; font-style: italic; color: #64748b; margin: 0;">${escapeHTML(org.note)}</p>
 </div>
 </div>
 </div>
        `;
      }
      
      function generateReceiptHTML(org, payment, unit) {
          return `<!doctype html>
        <html>
        <head>
          <title>Money Receipt - ${payment.receiptNo}</title>
          <style>
            /* Print-specific styles */
            @media print {
              @page { size: A4 portrait; margin: 5mm; } /* Minimal margin to fit more */
              body { background:white !important; }
              .sheet {
                /* Set fixed size for approx 1/5 of A4 height (297mm). 55mm * 5 = 275mm */
                height: 55mm; 
                max-width: 200mm; 
                margin-bottom: 3mm; /* Small space between receipts */
                padding: 8px; /* Greatly reduced padding */
                page-break-after: always;
                border: 1px dotted #ccc; /* Use dotted line border for easy cutting */
                border-radius: 0;
                box-shadow: none;
              }
              /* Do not break page after the last receipt */
              .sheet:last-child {
                page-break-after: avoid;
              }
            }
            /* Styling for screen preview */
            body { background:#f8fafc; margin:0; padding:16px; }
            .sheet { background:white; padding:16px; border:1px solid #e2e8f0; border-radius:12px; max-width: 600px; }
          </style>
        </head>
        <body>
          <div class="sheet">${renderReceiptInner(org, payment, unit)}</div>
        </body>
        </html>`;
      }

      // FINAL RENDER: Use Auth Wrapper to enable login screen
      ReactDOM.createRoot(document.getElementById("root")).render(<AuthStatusWrapper />);
    </script>
  </body>
</html>
