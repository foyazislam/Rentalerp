<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile ERP — Firestore Enabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and Babel are included but the app primarily uses vanilla JS + string templates -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> 
    
    <style>
      /* Ensure full height and base background */
      html, body { 
        height: 100%; 
        background: #f1f5f9; 
        font-family: 'Inter', sans-serif;
      }
      /* Custom toggle styling for better UX */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #4f46e5;
      }
      input:focus + .slider {
        box-shadow: 0 0 1px #4f46e5;
      }
      input:checked + .slider:before {
        transform: translateX(20px);
      }

      /* Print styles for the receipt modal */
      @media print {
        @page { size: A4; margin: 16mm; }
        /* Hide everything except the receipt when printing */
        body > *:not(.print-only) { display: none !important; } 
        .print-only { 
          display: block !important; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%;
          overflow: auto;
        }
      }

      /* Receipt specific styles for preview */
      .receipt-page {
        background: white;
        padding: 30px;
        max-width: 700px;
        margin: 20px auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 8px;
      }
      .table-fixed-layout {
        table-layout: fixed;
      }
    </style>
  </head>

  <body>
    <div id="app" class="min-h-screen flex flex-col">
      <!-- Content will be rendered here -->
    </div>

    <!-- Hidden div for print-only content -->
    <div id="print-container" class="print-only hidden"></div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        setDoc, 
        onSnapshot, 
        collection, 
        setLogLevel 
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Set Firestore debug level
      setLogLevel('Debug');

      // --- GLOBAL FIREBASE/APP VARIABLES (MANDATORY CANVAS GLOBALS) ---
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      // --- APPLICATION STATE (Now powered by Firestore) ---
      let app;
      let db;
      let auth;
      let userId = null; // Holds the user's UID or anonymous ID
      let isAuthReady = false; // Flag to ensure listeners start after auth

      let orgData = {}; 
      let unitList = [];
      let paymentList = [];

      // --- UTILITY FUNCTIONS ---
      function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }

      function formatCurrency(amount) {
        return `₱ ${new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount)}`;
      }

      function getDefaultOrgData() {
        return {
            name: "ERP Default Company",
            address: "123 Main St, Manila",
            contact: "0917-000-0000",
            email: "default@example.com",
            logo: "https://placehold.co/100x50/3730a3/ffffff?text=LOGO",
        };
      }

      // --- FIREBASE DATA PERSISTENCE FUNCTIONS ---
      
      /** * Constructs the Firestore path for the user's ERP data.
       * Data is stored privately under the user's ID.
       */
      function getErpCollection(uid) {
          const path = `artifacts/${appId}/users/${uid}/erp_data`;
          return collection(db, path);
      }

      /**
       * Sets up real-time listeners for all ERP data points.
       * Updates global variables and re-renders the necessary UI components.
       */
      function setupFirestoreListeners(uid) {
          const erpCollection = getErpCollection(uid);
          console.log(`Setting up listeners for path: artifacts/${appId}/users/${uid}/erp_data`);

          // 1. Organization Data Listener
          onSnapshot(doc(erpCollection, 'organization'), (docSnapshot) => {
              if (docSnapshot.exists()) {
                  orgData = docSnapshot.data();
              } else {
                  // Initialize with default if document doesn't exist
                  orgData = getDefaultOrgData();
                  saveData('org', orgData); 
              }
              renderOrgSettings();
          }, (error) => console.error("Error reading organization data:", error));

          // 2. Unit List Listener
          onSnapshot(doc(erpCollection, 'units'), (docSnapshot) => {
              if (docSnapshot.exists() && Array.isArray(docSnapshot.data().units)) {
                  unitList = docSnapshot.data().units;
              } else {
                  unitList = [];
              }
              renderUnitList();
              renderPaymentForms(); // Unit list affects payment dropdowns
          }, (error) => console.error("Error reading unit list:", error));

          // 3. Payment List Listener
          onSnapshot(doc(erpCollection, 'payments'), (docSnapshot) => {
              if (docSnapshot.exists() && Array.isArray(docSnapshot.data().payments)) {
                  paymentList = docSnapshot.data().payments.map(p => ({
                    ...p, 
                    // Convert Firestore Timestamps back to JS Date objects if needed later, 
                    // though for display, formatDate handles it fine.
                  })); 
              } else {
                  paymentList = [];
              }
              renderPaymentList();
              // Update dashboard/summary views if needed
          }, (error) => console.error("Error reading payment list:", error));
      }

      /**
       * Saves the specific data type to Firestore.
       * @param {string} dataType - 'org', 'units', or 'payments'.
       * @param {object|array} data - The data to save.
       */
      async function saveData(dataType, data) {
          if (!userId || !db) {
              console.error("Firestore not initialized or user not authenticated. Cannot save data.");
              return;
          }
          try {
              const erpCollection = getErpCollection(userId);
              const docRef = doc(erpCollection, 
                  dataType === 'org' ? 'organization' : dataType
              );

              // Structure data for saving to documents
              let saveDataPayload = data;
              if (dataType === 'units') {
                  saveDataPayload = { units: data };
              } else if (dataType === 'payments') {
                  saveDataPayload = { payments: data };
              }
              
              await setDoc(docRef, saveDataPayload);
              console.log(`Data saved successfully for: ${dataType}`);

          } catch (e) {
              console.error("Error saving data to Firestore:", e);
              // In a real app, you'd show a user-facing error message here.
          }
      }
      
      // Initial Auth Setup
      async function initializeFirebase() {
          try {
              app = initializeApp(firebaseConfig);
              auth = getAuth(app);
              db = getFirestore(app);

              // 1. Initial Authentication
              if (initialAuthToken) {
                  await signInWithCustomToken(auth, initialAuthToken);
              } else {
                  await signInAnonymously(auth);
              }

              // 2. Auth State Change Listener
              onAuthStateChanged(auth, (user) => {
                  if (user) {
                      userId = user.uid;
                      // Display the UID on the dashboard for collaboration reference
                      document.getElementById('user-id-display').textContent = userId;
                      if (!isAuthReady) {
                          setupFirestoreListeners(userId);
                          isAuthReady = true;
                          renderView('dashboard'); // Render main view after auth/listeners are ready
                      }
                  } else {
                      // Should not happen in Canvas, but handle unauthenticated state
                      userId = null;
                      isAuthReady = false;
                      console.log("User is signed out.");
                      // Optionally prompt for sign-in or handle anonymous failure
                  }
              });

          } catch (error) {
              console.error("Firebase initialization failed:", error);
              // Handle error, maybe show a message to the user
              document.getElementById('app').innerHTML = `
                  <div class="p-8 text-center text-red-600 bg-red-100 rounded-lg m-4">
                      Error loading application: Failed to connect to Firebase. Check console for details.
                  </div>
              `;
          }
      }

      // --- RENDERING & UI FUNCTIONS (Simplified for brevity, maintaining original structure) ---
      
      let currentView = 'dashboard';
      const views = {
        'dashboard': renderDashboard,
        'units': renderUnitManagement,
        'payments': renderPaymentManagement,
        'settings': renderSettings,
      };

      function renderView(viewName) {
        currentView = viewName;
        const appContainer = document.getElementById('app');
        appContainer.innerHTML = '';
        appContainer.appendChild(renderHeader());
        
        const mainContent = document.createElement('div');
        mainContent.className = 'flex-1 p-4 md:p-8 bg-white rounded-t-xl shadow-lg overflow-y-auto';
        mainContent.innerHTML = `<h1 class="text-3xl font-bold mb-6 text-gray-800">${viewName.charAt(0).toUpperCase() + viewName.slice(1)}</h1>`;
        
        views[viewName](mainContent);
        
        appContainer.appendChild(mainContent);
        appContainer.appendChild(renderFooter());
      }
      
      // --- HEADER & NAVIGATION ---
      function renderHeader() {
          const navMap = {
              'dashboard': 'Dashboard',
              'units': 'Units',
              'payments': 'Payments',
              'settings': 'Settings',
          };
          
          const header = document.createElement('header');
          header.className = 'bg-indigo-700 text-white p-4 shadow-xl sticky top-0 z-10';
          
          header.innerHTML = `
              <div class="max-w-6xl mx-auto flex justify-between items-center">
                  <div class="text-xl font-extrabold tracking-tight">ERP (Powered by Firestore)</div>
                  <div class="text-xs text-indigo-200">
                    User ID: <span id="user-id-display" class="font-mono text-white text-sm">Loading...</span>
                  </div>
                  <nav class="hidden md:flex space-x-4">
                      ${Object.keys(navMap).map(key => `
                          <button onclick="window.renderView('${key}')" class="px-3 py-1 rounded-lg transition-colors 
                              ${currentView === key ? 'bg-indigo-600 font-bold' : 'hover:bg-indigo-500'}">
                              ${navMap[key]}
                          </button>
                      `).join('')}
                  </nav>
                  <button id="mobile-menu-toggle" class="md:hidden p-2 rounded-full hover:bg-indigo-600">
                      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                  </button>
              </div>
          `;
          return header;
      }
      
      // --- FOOTER/MOBILE NAV ---
      function renderFooter() {
          const navMap = {
              'dashboard': 'Dashboard',
              'units': 'Units',
              'payments': 'Payments',
              'settings': 'Settings',
          };

          const footer = document.createElement('footer');
          footer.className = 'fixed bottom-0 left-0 right-0 bg-white shadow-2xl md:hidden z-20';
          footer.innerHTML = `
              <div class="flex justify-around p-2 border-t border-gray-200">
                  ${Object.keys(navMap).map(key => `
                      <button onclick="window.renderView('${key}')" class="flex flex-col items-center p-2 rounded-lg transition-colors w-1/4
                          ${currentView === key ? 'text-indigo-700 font-bold' : 'text-gray-500 hover:text-indigo-600'}">
                          <!-- Icon placeholder for ${navMap[key]} -->
                          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${key === 'dashboard' ? 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6' : key === 'units' ? 'M12 4.354a4 4 0 110 5.292M15 21H9a2 2 0 01-2-2v-1a2 2 0 012-2h6a2 2 0 012 2v1a2 2 0 01-2 2z' : key === 'payments' ? 'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm10-4h.01' : 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065zM12 15a3 3 0 100-6 3 3 0 000 6z'}"></path></svg>
                          <span class="text-xs mt-1">${navMap[key]}</span>
                      </button>
                  `).join('')}
              </div>
          `;
          return footer;
      }

      // --- VIEW IMPLEMENTATIONS ---

      // DASHBOARD VIEW (Summary of data)
      function renderDashboard(container) {
          const totalUnits = unitList.length;
          const occupiedUnits = unitList.filter(u => u.status === 'Occupied').length;
          const vacantUnits = totalUnits - occupiedUnits;
          const totalPayments = paymentList.reduce((sum, p) => sum + parseFloat(p.amount), 0);
          
          container.innerHTML += `
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <!-- Card 1: Total Units -->
                  <div class="bg-indigo-50 border border-indigo-200 p-6 rounded-xl shadow-md">
                      <p class="text-sm font-medium text-indigo-600">Total Units</p>
                      <p class="text-3xl font-bold text-gray-900 mt-1">${totalUnits}</p>
                  </div>
                  <!-- Card 2: Occupied Units -->
                  <div class="bg-green-50 border border-green-200 p-6 rounded-xl shadow-md">
                      <p class="text-sm font-medium text-green-600">Occupied Units</p>
                      <p class="text-3xl font-bold text-gray-900 mt-1">${occupiedUnits}</p>
                  </div>
                  <!-- Card 3: Total Payments YTD -->
                  <div class="bg-yellow-50 border border-yellow-200 p-6 rounded-xl shadow-md">
                      <p class="text-sm font-medium text-yellow-600">Total Payments Recorded</p>
                      <p class="text-3xl font-bold text-gray-900 mt-1">${formatCurrency(totalPayments)}</p>
                  </div>
              </div>
              
              <h2 class="text-2xl font-semibold mt-10 mb-4 text-gray-800">Unit Occupancy Breakdown</h2>
              <ul class="space-y-3">
                  ${unitList.slice(0, 5).map(unit => `
                      <li class="p-3 bg-gray-50 border border-gray-200 rounded-lg flex justify-between items-center">
                          <span class="font-medium text-gray-700">${escapeHTML(unit.name)}</span>
                          <span class="px-3 py-1 text-xs font-semibold rounded-full ${unit.status === 'Occupied' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                              ${unit.status}
                          </span>
                      </li>
                  `).join('')}
                  ${totalUnits > 5 ? `<li class="text-center text-sm text-indigo-600 pt-2"><button onclick="window.renderView('units')">View all ${totalUnits} units</button></li>` : ''}
              </ul>
          `;
      }
      
      // UNIT MANAGEMENT VIEW
      function renderUnitManagement(container) {
          // Add Unit Form (Simplified)
          container.innerHTML += `
              <form id="add-unit-form" class="bg-indigo-50 p-6 rounded-xl shadow-inner mb-6 space-y-4 border border-indigo-200">
                  <h3 class="text-xl font-semibold text-indigo-800">Add New Unit</h3>
                  <div>
                      <label for="unit-name" class="block text-sm font-medium text-gray-700">Unit Name/ID</label>
                      <input type="text" id="unit-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                  </div>
                  <div>
                      <label for="unit-rent" class="block text-sm font-medium text-gray-700">Monthly Rent (₱)</label>
                      <input type="number" id="unit-rent" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                  </div>
                  <div>
                      <label for="unit-status" class="block text-sm font-medium text-gray-700">Status</label>
                      <select id="unit-status" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                          <option value="Vacant">Vacant</option>
                          <option value="Occupied">Occupied</option>
                      </select>
                  </div>
                  <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                      Save Unit
                  </button>
              </form>
              <h3 class="text-2xl font-semibold mt-8 mb-4 text-gray-800">All Units (${unitList.length})</h3>
              <div id="unit-list-container"></div>
          `;
          
          document.getElementById('add-unit-form').addEventListener('submit', handleAddUnit);
          renderUnitList();
      }

      function handleAddUnit(event) {
          event.preventDefault();
          const name = document.getElementById('unit-name').value.trim();
          const rent = parseFloat(document.getElementById('unit-rent').value);
          const status = document.getElementById('unit-status').value;
          
          if (!name || isNaN(rent) || rent <= 0) {
              console.error("Invalid unit data.");
              return;
          }
          
          const newUnit = { 
              id: Date.now(), // Simple unique ID
              name, 
              rent, 
              status 
          };

          const newUnitList = [...unitList, newUnit];
          saveData('units', newUnitList); // Save to Firestore
          
          // Clear form
          document.getElementById('add-unit-form').reset();
      }

      function renderUnitList() {
          const container = document.getElementById('unit-list-container');
          if (!container) return; // Exit if we are not on the Units view

          container.innerHTML = `
              <div class="space-y-3">
                  ${unitList.map(unit => `
                      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                          <div>
                              <p class="font-bold text-lg">${escapeHTML(unit.name)}</p>
                              <p class="text-sm text-gray-600">${formatCurrency(unit.rent)} rent</p>
                          </div>
                          <div class="flex items-center space-x-3">
                              <span class="px-3 py-1 text-xs font-semibold rounded-full ${unit.status === 'Occupied' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                  ${unit.status}
                              </span>
                              <button onclick="window.deleteUnit(${unit.id})" class="text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-50">
                                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                              </button>
                          </div>
                      </div>
                  `).join('')}
                  ${unitList.length === 0 ? '<p class="text-gray-500 text-center py-4">No units added yet.</p>' : ''}
              </div>
          `;
      }

      function deleteUnit(id) {
          if (confirm("Are you sure you want to delete this unit?")) {
              const newUnitList = unitList.filter(unit => unit.id !== id);
              saveData('units', newUnitList);
          }
      }

      // PAYMENT MANAGEMENT VIEW
      function renderPaymentManagement(container) {
          container.innerHTML += `
              <form id="add-payment-form" class="bg-green-50 p-6 rounded-xl shadow-inner mb-6 space-y-4 border border-green-200">
                  <h3 class="text-xl font-semibold text-green-800">Record New Payment</h3>
                  <div>
                      <label for="payment-unit-id" class="block text-sm font-medium text-gray-700">Unit</label>
                      <select id="payment-unit-id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                          <option value="">Select Unit</option>
                          ${unitList.map(unit => `<option value="${unit.id}">${escapeHTML(unit.name)} (${unit.status})</option>`).join('')}
                      </select>
                  </div>
                  <div>
                      <label for="payment-amount" class="block text-sm font-medium text-gray-700">Amount Paid (₱)</label>
                      <input type="number" id="payment-amount" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                  </div>
                  <div>
                      <label for="payment-date" class="block text-sm font-medium text-gray-700">Payment Date</label>
                      <input type="date" id="payment-date" value="${new Date().toISOString().slice(0, 10)}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                  </div>
                  <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                      Record Payment
                  </button>
              </form>
              <h3 class="text-2xl font-semibold mt-8 mb-4 text-gray-800">Payment History (${paymentList.length})</h3>
              <div id="payment-list-container"></div>
          `;
          
          document.getElementById('add-payment-form').addEventListener('submit', handleAddPayment);
          renderPaymentList();
      }
      
      function renderPaymentForms() {
          const selectElement = document.getElementById('payment-unit-id');
          if (selectElement) {
              selectElement.innerHTML = `
                  <option value="">Select Unit</option>
                  ${unitList.map(unit => `<option value="${unit.id}">${escapeHTML(unit.name)} (${unit.status})</option>`).join('')}
              `;
          }
      }

      function handleAddPayment(event) {
          event.preventDefault();
          const unitId = parseInt(document.getElementById('payment-unit-id').value);
          const amount = parseFloat(document.getElementById('payment-amount').value);
          const date = document.getElementById('payment-date').value;
          
          const unit = unitList.find(u => u.id === unitId);

          if (!unit || isNaN(amount) || amount <= 0 || !date) {
              console.error("Invalid payment data.");
              return;
          }
          
          const newPayment = {
              id: Date.now(),
              unitId,
              unitName: unit.name,
              amount,
              date: date,
              receiptNo: `REC-${paymentList.length + 1}` // Simple receipt number
          };

          const newPaymentList = [...paymentList, newPayment];
          saveData('payments', newPaymentList);
          
          // Clear form
          document.getElementById('add-payment-form').reset();
          document.getElementById('payment-date').value = new Date().toISOString().slice(0, 10);

          showReceipt(newPayment, unit);
      }

      function renderPaymentList() {
          const container = document.getElementById('payment-list-container');
          if (!container) return;

          // Sort by date descending
          const sortedPayments = [...paymentList].sort((a, b) => new Date(b.date) - new Date(a.date));

          container.innerHTML = `
              <div class="space-y-3">
                  ${sortedPayments.map(payment => {
                      const unit = unitList.find(u => u.id === payment.unitId) || { name: 'Unknown Unit' };
                      return `
                          <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center">
                              <div>
                                  <p class="font-bold text-lg text-gray-800">${escapeHTML(unit.name)}</p>
                                  <p class="text-sm text-gray-600">Receipt No: ${escapeHTML(payment.receiptNo)}</p>
                              </div>
                              <div class="flex items-center space-x-3">
                                  <p class="text-xl font-semibold text-green-700">${formatCurrency(payment.amount)}</p>
                                  <button onclick="window.showReceipt(${JSON.stringify(payment).replace(/"/g, '&quot;')}, ${JSON.stringify(unit).replace(/"/g, '&quot;')})" class="text-indigo-500 hover:text-indigo-700 p-1 rounded-full hover:bg-indigo-50">
                                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m0 0v2a2 2 0 002 2h2a2 2 0 002-2v-2m0 0h-6"></path></svg>
                                  </button>
                              </div>
                          </div>
                      `;
                  }).join('')}
                  ${paymentList.length === 0 ? '<p class="text-gray-500 text-center py-4">No payments recorded yet.</p>' : ''}
              </div>
          `;
      }

      // RECEIPT GENERATION (Simplified)
      function renderReceiptInner(org, payment, unit) {
        // Use a structure similar to the original file's receipt rendering logic
        return `
            <div class="receipt-page font-sans text-gray-800">
                <div class="border-b pb-4 mb-4 text-center">
                    <img src="${escapeHTML(org.logo)}" alt="Company Logo" class="mx-auto h-12 mb-2">
                    <h1 class="text-2xl font-bold text-indigo-800">${escapeHTML(org.name)}</h1>
                    <p class="text-sm text-gray-600">${escapeHTML(org.address)}</p>
                    <p class="text-sm text-gray-600">Contact: ${escapeHTML(org.contact)} | Email: ${escapeHTML(org.email)}</p>
                </div>

                <div class="text-center mb-6">
                    <h2 class="text-xl font-semibold uppercase tracking-wider border-b-2 border-indigo-200 inline-block px-4 pb-1">RENT PAYMENT RECEIPT</h2>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                    <div>
                        <p><span class="font-medium">Unit:</span> ${escapeHTML(unit.name)}</p>
                        <p><span class="font-medium">Tenant/Status:</span> ${unit.status === 'Occupied' ? 'Occupied' : 'Vacant'}</p>
                    </div>
                    <div class="text-right">
                        <p><span class="font-medium">Receipt No:</span> ${escapeHTML(payment.receiptNo)}</p>
                        <p><span class="font-medium">Date:</span> ${formatDate(payment.date)}</p>
                    </div>
                </div>

                <table class="w-full text-left table-fixed-layout border border-gray-300 rounded-lg overflow-hidden mb-6">
                    <thead class="bg-indigo-50 text-indigo-800 text-sm">
                        <tr>
                            <th class="p-3 w-1/2">Description</th>
                            <th class="p-3 text-right w-1/2">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3">Monthly Rent Payment for Unit ${escapeHTML(unit.name)}</td>
                            <td class="p-3 text-right">${formatCurrency(payment.amount)}</td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-indigo-100 font-bold">
                        <tr>
                            <td class="p-3 text-lg">TOTAL PAID</td>
                            <td class="p-3 text-right text-lg">${formatCurrency(payment.amount)}</td>
                        </tr>
                    </tfoot>
                </table>

                <div class="text-center text-sm italic text-gray-500">
                    <p>Thank you for your prompt payment.</p>
                </div>

                <div class="flex justify-end mt-12">
                    <div class="w-48 text-center border-t border-gray-400 pt-2">
                        Authorized Signature
                    </div>
                </div>
            </div>
        `;
      }

      function showReceipt(payment, unit) {
          const printContainer = document.getElementById('print-container');
          printContainer.innerHTML = renderReceiptInner(orgData, payment, unit);
          printContainer.classList.remove('hidden');

          const modal = document.createElement('div');
          modal.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4';
          modal.innerHTML = `
              <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex justify-between items-center p-4 border-b">
                      <h3 class="text-xl font-bold">Receipt Preview: ${escapeHTML(payment.receiptNo)}</h3>
                      <div class="space-x-2">
                          <button id="print-receipt-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md transition-colors">Print</button>
                          <button id="close-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 shadow-md transition-colors">Close</button>
                      </div>
                  </div>
                  <div id="receipt-preview-content" class="p-6">
                      <!-- Receipt content will be inserted here -->
                  </div>
              </div>
          `;

          // Insert the receipt HTML into the modal content
          modal.querySelector('#receipt-preview-content').innerHTML = renderReceiptInner(orgData, payment, unit);

          document.body.appendChild(modal);

          modal.querySelector('#close-modal-btn').onclick = () => {
              document.body.removeChild(modal);
              printContainer.classList.add('hidden');
          };
          
          modal.querySelector('#print-receipt-btn').onclick = () => {
              window.print();
          };
      }


      // SETTINGS VIEW
      function renderSettings(container) {
          const org = orgData || getDefaultOrgData();
          container.innerHTML += `
              <div class="max-w-xl mx-auto">
                  <form id="org-settings-form" class="bg-white p-8 rounded-xl shadow-lg border border-gray-200 space-y-6">
                      <h3 class="text-2xl font-semibold text-indigo-700 border-b pb-3 mb-4">Organization Details</h3>
                      
                      <div>
                          <label for="org-name" class="block text-sm font-medium text-gray-700">Company Name</label>
                          <input type="text" id="org-name" value="${escapeHTML(org.name || '')}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                      </div>
                      <div>
                          <label for="org-address" class="block text-sm font-medium text-gray-700">Address</label>
                          <input type="text" id="org-address" value="${escapeHTML(org.address || '')}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                      </div>
                      <div>
                          <label for="org-contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
                          <input type="text" id="org-contact" value="${escapeHTML(org.contact || '')}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                      </div>
                      <div>
                          <label for="org-email" class="block text-sm font-medium text-gray-700">Email</label>
                          <input type="email" id="org-email" value="${escapeHTML(org.email || '')}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                      </div>
                      <div>
                          <label for="org-logo" class="block text-sm font-medium text-gray-700">Logo URL (Placeholder)</label>
                          <input type="url" id="org-logo" value="${escapeHTML(org.logo || '')}" placeholder="e.g. https://placehold.co/100x50" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                      </div>
                      
                      <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                          Save Organization Settings
                      </button>
                  </form>
              </div>
          `;
          
          document.getElementById('org-settings-form').addEventListener('submit', handleSaveOrgSettings);
      }

      function handleSaveOrgSettings(event) {
          event.preventDefault();
          const newOrgData = {
              name: document.getElementById('org-name').value.trim(),
              address: document.getElementById('org-address').value.trim(),
              contact: document.getElementById('org-contact').value.trim(),
              email: document.getElementById('org-email').value.trim(),
              logo: document.getElementById('org-logo').value.trim(),
          };

          // Update global variable (though onSnapshot will override, this provides immediate feedback)
          orgData = newOrgData; 
          saveData('org', newOrgData); // Save to Firestore
          
          alertMessage('Organization settings saved successfully!', 'success');
      }

      function renderOrgSettings() {
          // This function updates the UI elements that depend on orgData.
          // Since the main view is redrawn on navigation, we mainly need it for the settings view
          // to update the form fields after initial load/change from Firestore.
          if (currentView === 'settings') {
             renderView('settings'); // A simpler way to force a redraw with new data
          }
      }

      // Simple Alert/Toast mechanism (replacing 'alert()')
      function alertMessage(message, type = 'info') {
          let color = '';
          if (type === 'success') color = 'bg-green-100 text-green-800 border-green-400';
          else if (type === 'error') color = 'bg-red-100 text-red-800 border-red-400';
          else color = 'bg-blue-100 text-blue-800 border-blue-400';

          const container = document.getElementById('alert-container');
          if (!container) {
              const appContainer = document.getElementById('app');
              const alertDiv = document.createElement('div');
              alertDiv.id = 'alert-container';
              alertDiv.className = 'fixed top-4 right-4 z-50 space-y-2';
              document.body.appendChild(alertDiv);
          }
          
          const alertEl = document.createElement('div');
          alertEl.className = `${color} p-4 rounded-lg shadow-xl border-l-4 transition-opacity duration-300 opacity-0`;
          alertEl.textContent = message;
          
          document.getElementById('alert-container').appendChild(alertEl);
          
          // Fade in
          setTimeout(() => alertEl.style.opacity = '1', 10);

          // Fade out and remove
          setTimeout(() => {
              alertEl.style.opacity = '0';
              setTimeout(() => alertEl.remove(), 300);
          }, 3000);
      }
      
      // Attach global functions to window object for HTML event handlers
      window.renderView = renderView;
      window.deleteUnit = deleteUnit;
      window.showReceipt = showReceipt;
      
      // --- INITIALIZATION ---
      initializeFirebase();
    </script>
  </body>
</html>
