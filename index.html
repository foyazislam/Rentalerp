<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>Home/Shop RMS Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script> 
    
    <script>
      tailwind.config = {
        darkMode: 'class', 
        theme: {
          extend: {
            colors: {
              indigo: {
                50: 'var(--theme-50)', 100: 'var(--theme-100)', 200: 'var(--theme-200)', 300: 'var(--theme-300)', 400: 'var(--theme-400)',
                500: 'var(--theme-500)', 600: 'var(--theme-600)', 700: 'var(--theme-700)', 800: 'var(--theme-800)', 900: 'var(--theme-900)',
              }
            },
            padding: { 'safe-bottom': 'env(safe-area-inset-bottom)' },
            animation: { 'slide-up': 'slideUp 0.3s ease-out forwards' },
            keyframes: { slideUp: { '0%': { transform: 'translateY(100%)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } } }
          }
        }
      }
    </script>

    <style>
      /* Base Styles */
      html, body { height: 100%; transition: background-color 0.3s ease, color 0.3s ease; overscroll-behavior-y: none;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
      body { -webkit-tap-highlight-color: transparent; }
      
      /* Theme Variables */
      :root {
        --theme-50: #eef2ff; --theme-100: #e0e7ff; --theme-200: #c7d2fe; --theme-300: #a5b4fc; --theme-400: #818cf8;
        --theme-500: #6366f1; --theme-600: #4f46e5; --theme-700: #4338ca; --theme-800: #3730a3; --theme-900: #312e81;
      }

      /* Custom Scrollbars */
      .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
      .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }

      input[type="date"], input[type="month"] { -webkit-appearance: none; appearance: none; background-color: transparent; min-height: 42px; }
      @media print { .no-print { display: none !important; } }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 selection:bg-indigo-500 selection:text-white">
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState, createContext, useContext } = React;
      /* ------------- Firebase Config ------------- */
      const firebaseConfig = {
        apiKey: "AIzaSyBR20axEzJjcoNNyGxxxvc6AZYrxPBQ6M4",
        authDomain: "homeshop-rms.firebaseapp.com",
        projectId: "homeshop-rms",
        storageBucket: "homeshop-rms.firebasestorage.app",
        messagingSenderId: "860746996508",
        appId: "1:860746996508:web:7a9360811037941725b8d9"
      };
      if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
      const db = firebase.firestore();
      const auth = firebase.auth();
      const storage = firebase.storage();

      /* ------------- Toast Context ------------- */
      const ToastContext = createContext();
      const useToast = () => useContext(ToastContext);

      const ToastProvider = ({ children }) => {
          const [toasts, setToasts] = useState([]);
          const addToast = (msg, type = 'success') => {
              const id = Date.now();
              setToasts(prev => [...prev, { id, msg, type }]);
              setTimeout(() => removeToast(id), 3000);
          };
          const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));
          return (
              <ToastContext.Provider value={{ addToast }}>
                  {children}
                  <div className="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                      {toasts.map(t => (
                          <div key={t.id} className={`pointer-events-auto animate-slide-up px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 text-sm font-medium text-white ${t.type === 'error' ? 'bg-rose-600' : 'bg-emerald-600'}`}>
                              <span>{t.type === 'error' ? '‚ö†Ô∏è' : '‚úÖ'}</span> {t.msg}
                          </div>
                      ))}
                  </div>
              </ToastContext.Provider>
          );
      };

      /* ------------- Theme Definitions ------------- */
      const THEMES = {
        indigo: { name: 'Default', colors: { 50:'#eef2ff', 100:'#e0e7ff', 200:'#c7d2fe', 300:'#a5b4fc', 400:'#818cf8', 500:'#6366f1', 600:'#4f46e5', 700:'#4338ca', 800:'#3730a3', 900:'#312e81' }},
        blue: { name: 'Ocean', colors: { 50:'#eff6ff', 100:'#dbeafe', 200:'#bfdbfe', 300:'#93c5fd', 400:'#60a5fa', 500:'#3b82f6', 600:'#2563eb', 700:'#1d4ed8', 800:'#1e40af', 900:'#1e3a8a' }},
        emerald: { name: 'Forest', colors: { 50:'#ecfdf5', 100:'#d1fae5', 200:'#a7f3d0', 300:'#6ee7b7', 400:'#34d399', 500:'#10b981', 600:'#059669', 700:'#047857', 800:'#065f46', 900:'#064e3b' }},
        slate: { name: 'Graphite', colors: { 50:'#f8fafc', 100:'#f1f5f9', 200:'#e2e8f0', 300:'#cbd5e1', 400:'#94a3b8', 500:'#64748b', 600:'#475569', 700:'#334155', 800:'#1e293b', 900:'#0f172a' }},
      };

      /* ------------- Utilities ------------- */
      const todayStr = () => new Date().toISOString().slice(0, 10);
      const formatDisplayDate = (dateStr) => { if (!dateStr) return ""; const [y, m, d] = dateStr.split('-'); return `${d}-${m}-${y}`; };
      const currency = (n) => { const num = Number(n || 0); try { return num.toLocaleString(undefined, { style: "currency", currency: "BDT" }).replace("BDT", "‡ß≥").trim(); } catch { return `‡ß≥${num.toLocaleString()}`; } };
      const formatMonth = (ym) => { if (!ym || ym.length !== 7) return "N/A"; const [year, month] = ym.split('-'); return new Date(year, month - 1, 1).toLocaleString('default', { month: 'long', year: 'numeric' }); };
      const amountToWords = (n) => {
          if (typeof n !== 'number') { n = Number(n); }
          if (isNaN(n) || n <= 0) { return "Zero Taka Only"; }
          const units = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
          const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
          const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
          function helper(num) {
              if (num === 0) return '';
              if (num < 10) return units[num] + ' ';
              if (num < 20) return teens[num - 10] + ' ';
              if (num < 100) return tens[Math.floor(num / 10)] + ' ' + helper(num % 10);
              if (num < 1000) return units[Math.floor(num / 100)] + ' Hundred ' + helper(num % 100);
              let words = '';
              if (num >= 10000000) { words += helper(Math.floor(num / 10000000)) + ' Crore '; num %= 10000000; }
              if (num >= 100000) { words += helper(Math.floor(num / 100000)) + ' Lakh '; num %= 100000; }
              if (num >= 1000) { words += helper(Math.floor(num / 1000)) + ' Thousand '; num %= 1000; }
              words += helper(num);
              return words;
          }
          let totalAmount = Math.round(n * 100) / 100;
          let taka = Math.floor(totalAmount);
          let paisa = Math.round((totalAmount - taka) * 100);
          let words = helper(taka).trim();
          if (words) words += ' Taka'; else words = '';
          if (paisa > 0) { if (words) words += ' and '; let paisaWords = helper(paisa).trim(); if (paisaWords) words += paisaWords + ' Paisa'; else words += `${String(paisa).padStart(2, '0')}/100 Paisa`; }
          if (words) words += ' Only';
          return words.replace(/\s+/g, ' ').trim() || "Zero Taka Only";
      };

      const monthKey = (dateStr) => { const d = new Date(dateStr); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`; };
      const nextReceiptNo = (allPayments) => { const yyyymm = monthKey(new Date().toISOString()); const prefix = `RC-${yyyymm}-`; const count = allPayments.filter((p) => (p.receiptNo || "").startsWith(prefix)).length + 1; return `${prefix}${String(count).padStart(4, "0")}`; };
      const exportToCSV = (data, filename) => {
          const csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", filename);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      };
      
      const createWhatsAppLink = (phone, tenantName, unitName, orgName, dueDay, rent) => { 
          if (!phone) return null; 
          const p = phone.replace(/\D/g, ''); 
          const msg = `*Rent Reminder from ${orgName}*\n\nDear ${tenantName} (Unit: ${unitName}),\n\nYour rent of ${currency(rent)} is due by date ${dueDay}.\nPlease pay on time.\nThank you!`; 
          return `https://wa.me/${p}?text=${encodeURIComponent(msg)}`; 
      };

      // Receipt Helpers
      function escapeHTML(str) { return String(str || "").replace(/[&<>'"/]/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;","/":"&#x2F;"}[c] || c)); }
      function renderReceiptInner(org, payment, unit) { 
          const unitName = unit?.name || payment.unitId || "N/A"; 
          const formattedMonth = formatMonth(payment.forMonth); 
          const displayDate = formatDisplayDate(payment.date); 
          const displayPurpose = (payment.purpose === "Rent" || !payment.purpose) ? "Rent And Service Charge" : payment.purpose;
          return ` <div style="font-family: Times New Roman, system-ui, sans-serif; max-width: 190mm; margin: 0 auto; padding: 20px; background: white; border: 1px solid #ddd;"> <div style="text-align:center; padding-bottom:4px; border-bottom:3px solid #e2e8f0;"> <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0;">${escapeHTML(org.name)}</h1> <p style="font-size: 0.65rem; color: #475569; margin: 0;">${escapeHTML(org.address)} | Phone: ${escapeHTML(org.phone)}</p> </div> <h2 style="font-size: 1rem; font-weight: 600; text-align:center; padding: 4px 0; margin: 0;">MONEY RECEIPT</h2> <div style="display:flex; justify-content:space-between; font-size: 0.7rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px; margin-bottom: 4px;"> <span><b>Receipt #:</b> ${escapeHTML(payment.receiptNo)}</span> <span><b>Date:</b> ${escapeHTML(displayDate)}</span> </div> <table style="width:100%; font-size:14px; border-collapse: collapse;"> <tr><td style="padding:4px 0;"><b>Received With Thanks From:</b> ${escapeHTML(payment.tenant)}</td></tr> <tr> <td style="padding:4px 0;"><b>For Unit No:</b> ${escapeHTML(unitName)}</td> <td style="padding:4px 0;"><b>Purpose:</b> ${escapeHTML(displayPurpose)}</td> </tr> <tr> <td style="padding:4px 0;"><b>For The Month:</b> ${escapeHTML(formattedMonth)}</td> <td style="padding:4px 0;"><b>Method:</b> ${escapeHTML(payment.method)}</td> </tr> <tr> <td style="padding:4px 0;"><b>In Words:</b> ${amountToWords(payment.amount)}</td> <td style="padding:4px 0;"><b>Amount:</b> <b style="font-size:16px;">${currency(payment.amount)}</b></td> </tr> </table> ${payment.notes ? `<div style="margin-top:4px; font-size:10px; color:#475569;"><b>Notes:</b> ${escapeHTML(payment.notes)}</div>` : ""} <div style="height:30px;"></div> <div style="margin-top:12px; display:flex; justify-content:space-between; align-items:flex-end;"> <div style="font-size:10px; color:#334155; max-width: 50%;">${escapeHTML(org.note || "")}</div> <div style="margin-right:10px;"><div style="border-top:1px solid #94a3b8; padding-top:4px; font-size:10px; text-align:center;">Authorized Signature</div></div> </div> </div> `;
      }
      function renderReceiptHTML(org, payment, unit) { return `<!DOCTYPE html><html><head><meta charset="utf-8" /><title>Receipt</title><style>@media print{@page{size:A4 portrait;margin:0}body{margin:0!important}.sheet{height:98mm;width:100%;padding:5mm;box-sizing:border-box;page-break-inside:avoid;border-bottom:1px dashed #ccc}}body{background:white;margin:0}.sheet{background:white;margin:0 auto;padding:10px;max-width:210mm;}</style></head><body><div class="sheet">${renderReceiptInner(org, payment, unit)}</div></body></html>`; }

      const classNames = (...c) => c.filter(Boolean).join(" ");
      if (!(window.crypto && window.crypto.randomUUID)) { window.crypto = window.crypto || {};
      window.crypto.randomUUID = function () { return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) { const r = (Math.random() * 16) | 0; const v = c === 'x' ? r : (r & 0x3) | 0x8; return v.toString(16); });
      }; }
      
      const shouldShowReminder = (dueDay) => { const today = new Date(); return Math.abs(today.getDate() - Number(dueDay)) <= 2; }

      /* ------------- Initial Data ------------- */
      const initialData = {
        org: { name: "Shahjahan Chowdhury Bari", address: "Bashundhara R/A, Dhaka-1230", phone: "+8801749333661", email: "info@example.com", note: "Thank you for your payment!", },
        settings: { theme: 'indigo', darkMode: false, backupUrl: "" },
        units: [ ...Array.from({ length: 5 }).map((_, i) => ({ id: `F${i + 1}`, type: "Flat", name: `Flat ${i + 1}`, rent: 15000, dueDay: 5, tenant: "", tenantPhone: "", enableReminder: true })), ],
        payments: [], expenses: []
      };
      /* ------------- Cloud Storage ------------- */
      const loadData = async (uid) => { 
        try { 
            const doc = await db.doc(`erp_data/${uid}`).get();
            if (doc.exists) {
                const saved = doc.data();
                return { ...initialData, ...saved };
            }
            return initialData;
        } catch (e) { console.error(e); return initialData; } 
      };
      const saveData = async (data, uid) => { 
        if (!uid) return;
        try { await db.doc(`erp_data/${uid}`).set({ ...data }); } catch (e) { console.error(e); } 
      };
      const uploadFile = async (file, unitId, type) => { 
          const user = auth.currentUser;
          if (!user) throw new Error("Login required");
          const ref = storage.ref(`tenant_docs/${user.uid}/${unitId}/${type}/${file.name}`);
          await ref.put(file); return await ref.getDownloadURL(); 
      };
      /* ------------- Components ------------- */
      const Section = ({ title, right, children, className }) => (
        <div className={classNames("bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-4 md:p-6 transition-all", className)}>
          <div className="flex flex-wrap items-center justify-between mb-4 gap-2 border-b border-slate-100 dark:border-slate-700 pb-2">
            <h2 className="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-100">{title}</h2>
            {right}
          </div>
          {children}
        </div>
      );
      const Input = (props) => (
          <input {...props} className={classNames("w-full rounded-lg border px-3 py-2.5 text-sm shadow-sm transition-colors border-slate-300 bg-white text-slate-700 placeholder:text-slate-400 dark:border-slate-600 dark:bg-slate-900/50 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 disabled:opacity-60", props.className)} />
      );
      const Select = (props) => (
          <div className="relative w-full">
            <select {...props} className={classNames("w-full rounded-lg border px-3 py-2.5 text-sm shadow-sm appearance-none transition-colors border-slate-300 bg-white text-slate-700 dark:border-slate-600 dark:bg-slate-900/50 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-500", props.className)} />
            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><svg className="h-4 w-4 fill-current" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/></svg></div>
          </div>
      );
      const Button = ({ children, variant = "primary", className, loading, ...rest }) => {
        const styles = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700 active:bg-indigo-800 shadow-sm",
          secondary: "bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 border border-slate-300 dark:border-slate-600 hover:bg-slate-50 dark:hover:bg-slate-600",
          danger: "bg-rose-600 text-white hover:bg-rose-700 active:bg-rose-800 shadow-sm",
          ghost: "bg-transparent hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300",
        };
        return (
          <button {...rest} disabled={rest.disabled || loading} className={classNames("rounded-lg px-4 py-2 text-sm font-medium transition-all duration-150 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2", styles[variant], className)}>
            {loading && <div className="h-4 w-4 border-2 border-current border-t-transparent rounded-full animate-spin"></div>}
            {children}
          </button>
        );
      };
      
      const Checkbox = ({ label, id, ...props }) => (
          <div className="flex items-center py-2 cursor-pointer">
              <input type="checkbox" id={id} {...props} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer" />
              {label && <label htmlFor={id} className="ml-2 text-sm text-slate-700 dark:text-slate-300 cursor-pointer select-none">{label}</label>}
          </div>
      );
      const ChartComponent = ({ data, type = 'bar', title }) => {
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        useEffect(() => {
            if (!canvasRef.current) return;
            if (chartRef.current) chartRef.current.destroy();

            const ctx = canvasRef.current.getContext('2d');
            chartRef.current = new Chart(ctx, {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#475569' } },
                        title: { display: !!title, text: title }
                    },
                    scales: type === 'doughnut' ? {} : {
                        y: { 
                            beginAtZero: true, 
                            grid: { color: document.documentElement.classList.contains('dark') ? '#334155' : '#e2e8f0' },
                            ticks: { color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#475569' }
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: document.documentElement.classList.contains('dark') ? '#cbd5e1' : '#475569' }
                        }
                    }
                }
            });
            return () => { if (chartRef.current) chartRef.current.destroy(); };
        }, [data, type, title]);

        return <div className="w-full h-full"><canvas ref={canvasRef}></canvas></div>;
      };
      const Pagination = ({ totalItems, itemsPerPage, currentPage, setCurrentPage }) => {
        const pages = Math.ceil(totalItems / itemsPerPage);
        if (pages <= 1) return null;
        return (
          <div className="flex justify-end gap-2 mt-4 items-center">
            <span className="text-xs text-slate-500 dark:text-slate-400 mr-2">Page {currentPage} of {pages}</span>
            <Button variant="secondary" className="!py-1 !px-2" disabled={currentPage===1} onClick={()=>setCurrentPage(c=>Math.max(1,c-1))}>Prev</Button>
            <Button variant="secondary" className="!py-1 !px-2" disabled={currentPage===pages} onClick={()=>setCurrentPage(c=>Math.min(pages,c+1))}>Next</Button>
          </div>
        )
      };
      function FileUpload({ label, urlKey, unitId, setUnitForm, currentUrl }) {
          const [uploading, setUploading] = useState(false);
          const { addToast } = useToast();
          const handleFileChange = async (event) => {
              const file = event.target.files[0];
              if (!file) return;
              setUploading(true);
              try {
                  const type = urlKey.replace('tenant', '').replace('Nid', 'NID').replace('Agreement', 'Agreement');
                  const url = await uploadFile(file, unitId, type);
                  setUnitForm(f => ({ ...f, [`${urlKey}Url`]: url }));
                  addToast(`${label} uploaded!`);
              } catch (error) { addToast("Upload failed.", "error"); } finally { setUploading(false); }
          };
          return (
              <div className="space-y-1 bg-slate-50 dark:bg-slate-700/50 p-3 rounded-lg border border-slate-200 dark:border-slate-600">
                  <div className="flex justify-between items-center"><label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">{label}</label> {currentUrl && <a href={currentUrl} target="_blank" className="text-xs text-indigo-600 hover:underline">View Current</a>}</div>
                  <div className="flex items-center gap-2">
                      <input type="file" onChange={handleFileChange} disabled={uploading || !unitId} className="block w-full text-xs text-slate-500 file:mr-2 file:py-1.5 file:px-3 file:rounded-md file:border-0 file:text-xs file:font-semibold file:bg-indigo-100 file:text-indigo-700 hover:file:bg-indigo-200 dark:file:bg-indigo-900 dark:file:text-indigo-200" />
                      {uploading && <div className="h-4 w-4 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>}
                  </div>
              </div>
          );
      }
      
      /* ------------- Main App ------------- */
      function App({ currentUser }) {
        const [data, setData] = useState(initialData);
        const [tab, setTab] = useState("dashboard");
        const [showReceipt, setShowReceipt] = useState(null);
        const [loading, setLoading] = useState(true);
        const [deleteRequest, setDeleteRequest] = useState(null);
        const [showSettingsPrompt, setShowSettingsPrompt] = useState(false);
        const { addToast } = useToast();
        const uid = currentUser?.uid;

        // Theme Effect
        useEffect(() => {
            const settings = data.settings || { theme: 'indigo', darkMode: false };
            const themeKey = settings.theme || 'indigo';
            const themeColors = THEMES[themeKey]?.colors || THEMES.indigo.colors;
            const root = document.documentElement;
            Object.entries(themeColors).forEach(([shade, value]) => { root.style.setProperty(`--theme-${shade}`, value); });
            if (settings.darkMode) root.classList.add('dark'); else root.classList.remove('dark');
        }, [data.settings]);
        // Cloud Sync
        useEffect(() => { 
            if (!uid) return;
            setLoading(true); 
            loadData(uid).then(init => { setData(init); setLoading(false); }); 
        }, [uid]);
        // Auto Save Debounce
        useEffect(() => { 
            if (loading || !uid) return; 
            const timer = setTimeout(() => saveData(data, uid), 800); 
            return () => clearTimeout(timer); 
        }, [data, loading, uid]);
        
        const updateOrg = (patch) => setData(d => ({ ...d, org: { ...d.org, ...patch } }));
        const updateSettings = (patch) => setData(d => ({ ...d, settings: { ...d.settings, ...patch } }));
        const upsertUnit = (unit) => {
            setData(d => ({ ...d, units: d.units.some(x => x.id === unit.id) ? d.units.map(x => x.id === unit.id ? { ...x, ...unit } : x) : [...d.units, unit] }));
            addToast("Unit saved successfully");
        };
        const deleteUnit = (id) => { 
            if(!confirm("Delete this unit?")) return;
            setData(d => ({ ...d, units: d.units.filter(u => u.id !== id) })); 
            addToast("Unit deleted");
        };
        const isPasswordCorrect = async (password) => { 
            if (!currentUser?.email) return false;
            try { await auth.signInWithEmailAndPassword(currentUser.email, password); return true; } catch { return false; } 
        };
        const deletePayment = (id) => {
            setData((d) => ({ ...d, payments: d.payments.filter((p) => p.id !== id) }));
            setDeleteRequest(null); 
            addToast("Payment deleted", "error"); 
        };
        const deleteExpense = (id) => { 
            setData((d) => ({ ...d, expenses: d.expenses.filter((e) => e.id !== id) }));
            setDeleteRequest(null); 
            addToast("Expense deleted", "error"); 
        };

        /* --- Google Sheet Sync --- */
        const syncToSheet = (payload) => {
          const url = data.settings?.backupUrl;
          if (!url) return;
          fetch(url, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          }).then(() => console.log("Sent to Sheet")).catch(e => console.error("Sheet sync error", e));
        };

        const addPayment = (p) => {
            const newPayment = { ...p, id: crypto.randomUUID(), isPrinted: false }; // Added isPrinted default
            setData(d => ({ ...d, payments: [newPayment, ...d.payments] }));
            addToast(`Receipt ${p.receiptNo} created`);
            syncToSheet({
              type: "Income",
              date: p.date,
              amount: Number(p.amount),
              desc: `Rent: ${p.tenant} (${p.unitId})`,
              receiptNo: p.receiptNo,
              unit: p.unitId,
              tenant: p.tenant,
              month: p.forMonth,
              method: p.method
            });
        };
        const addExpense = (e) => {
            const newExpense = { ...e, id: crypto.randomUUID() };
            setData(d => ({ ...d, expenses: [newExpense, ...d.expenses] }));
            addToast("Expense recorded");
            syncToSheet({
              type: "Expense",
              date: e.date,
              amount: -Math.abs(Number(e.amount)),
              desc: `${e.category} - ${e.vendor || 'No Vendor'}`,
              category: e.category,
              vendor: e.vendor || "",
              notes: e.notes || ""
            });
        };

        // NEW: Function to mark a payment as printed
        const markAsPrinted = (id) => {
          setData(d => ({
            ...d, 
            payments: d.payments.map(p => p.id === id ? { ...p, isPrinted: true } : p)
          }));
        };

        const totals = useMemo(() => {
            const income = data.payments.reduce((s, p) => s + Number(p.amount || 0), 0);
            const expense = data.expenses.reduce((s, e) => s + Number(e.amount || 0), 0);
            return { income, expense, net: income - expense };
        }, [data.payments, data.expenses]);
        const chartData = useMemo(() => {
            // Last 6 months data for chart
            const labels = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date();
                d.setMonth(d.getMonth() - i);
                const key = monthKey(d.toISOString());
                const label = d.toLocaleString('default', { month: 'short' });
                labels.push(label);
                
                const inc = data.payments.filter(p => (p.date || "").startsWith(key)).reduce((s, p) => s + Number(p.amount || 0), 0);
                const exp = data.expenses.filter(e => (e.date || "").startsWith(key)).reduce((s, e) => s + Number(e.amount || 0), 0);
                incomeData.push(inc);
                expenseData.push(exp);
            }
            return {
                labels,
                datasets: [
                    { label: 'Income', data: incomeData, backgroundColor: '#4f46e5', borderRadius: 4 },
                    { label: 'Expense', data: expenseData, backgroundColor: '#e11d48', borderRadius: 4 }
                ]
            };
        }, [data.payments, data.expenses]);

        const outstandingMap = useMemo(() => {
            const now = new Date();
            const ym = monthKey(now.toISOString());
            const map = {};
            data.units.forEach(u => map[u.id] = u.rent || 0);
            data.payments.filter(p => (p.forMonth || "").startsWith(ym)).forEach(p => { map[p.unitId] = Math.max(0, (map[p.unitId] || 0) - Number(p.amount || 0)); });
            return map;
        }, [data.units, data.payments]);

        if (loading) return (
            <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 dark:bg-slate-900 gap-4">
                <div className="h-10 w-10 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                <div className="text-slate-500 animate-pulse">Loading your data...</div>
            </div>
        );
        return (
          <div className="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 pb-safe-bottom transition-colors duration-300">
            <header className="sticky top-0 z-30 bg-white/80 dark:bg-slate-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 shadow-sm no-print">
              <div className="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-2.5">
                    <div className="bg-indigo-600 text-white p-1.5 rounded-lg shadow-sm"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></div>
                    <div className="font-bold text-lg md:text-xl truncate">{data.org.name || "RMS Pro"}</div>
                </div>
                <div className="flex items-center gap-2">
                    <span className="hidden sm:inline text-xs text-slate-500 dark:text-slate-400">{currentUser.email}</span>
                    <Button variant="ghost" onClick={() => auth.signOut()} className="text-xs !px-2"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></Button>
                </div>
              </div>
              <nav className="mx-auto max-w-6xl px-4 overflow-x-auto custom-scrollbar">
                <div className="flex gap-1 pb-2 min-w-max">
                   {[ ["dashboard", "Dashboard"], ["units", "Units"], ["payments", "History"], ["newReceipt", "+ Receipt"], ["statement", "Statement"], ["expenses", "Expenses"], ["settings", "Settings"] ].map(([key, label]) => (
                     <button key={key} onClick={() => { if (key === 'settings' && currentUser) setShowSettingsPrompt(true);
                      else setTab(key); }}
                      className={classNames("px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap", tab === key ? "bg-indigo-50 dark:bg-indigo-900/40 text-indigo-700 dark:text-indigo-300" : "text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700")}>
                      {label}
                    </button>
                   ))}
                </div>
              </nav>
            </header>

            <main className="mx-auto max-w-6xl p-4 space-y-6 pb-24 md:pb-12 no-print">
              {tab === "dashboard" && <Dashboard totals={totals} units={data.units} outstanding={outstandingMap} chartData={chartData} expenses={data.expenses} org={data.org} />}
              {tab === "units" && <UnitsSection units={data.units} upsertUnit={upsertUnit} deleteUnit={deleteUnit} />}
              {tab === "payments" && <PaymentsSection payments={data.payments} units={data.units} onRowClick={setShowReceipt} onDelete={(id) => setDeleteRequest({ type: 'payment', id })} />}
              {tab === "newReceipt" && <NewReceiptSection units={data.units} addPayment={addPayment} data={data} />}
              {tab === "statement" && <Section title="Financial Statement"><StatementView payments={data.payments} expenses={data.expenses} org={data.org} /></Section>}
              {tab === "expenses" && <ExpensesSection expenses={data.expenses} addExpense={addExpense} onDelete={(id) => setDeleteRequest({ type: 'expense', id })} />}
              {tab === "settings" && <SettingsSection org={data.org} settings={data.settings} updateOrg={updateOrg} updateSettings={updateSettings} data={data} setData={setData} />}
            </main>

            {showReceipt && <ReceiptModal org={data.org} payment={showReceipt} unit={data.units.find(u => u.id === showReceipt.unitId)} onClose={() => setShowReceipt(null)} onPrintMark={() => markAsPrinted(showReceipt.id)} />}
            {(showSettingsPrompt || deleteRequest) && <PasswordPromptModal currentUser={currentUser} isPasswordCorrect={isPasswordCorrect} onClose={() => { setShowSettingsPrompt(false); setDeleteRequest(null); }} onSuccess={() => { if (showSettingsPrompt) { setTab('settings'); setShowSettingsPrompt(false);
            } else if (deleteRequest) { if (deleteRequest.type === 'payment') deletePayment(deleteRequest.id); else if (deleteRequest.type === 'expense') deleteExpense(deleteRequest.id); } }} actionLabel={showSettingsPrompt ? "Access Settings" : "Delete Record"} />}
          </div>
        );
      }

      /* ------------- Sub-Sections ------------- */
      function Dashboard({ totals, units, outstanding, chartData, expenses, org }) {
          const dueCount = Object.values(outstanding).filter(v => v > 0).length;
          const totalDue = Object.values(outstanding).reduce((a,b) => a+b, 0);
          
          // --- PIE CHART LOGIC ---
          const expenseCats = {};
          expenses.forEach(e => { const cat = e.category || "Uncategorized"; expenseCats[cat] = (expenseCats[cat] || 0) + Number(e.amount); });
          const pieData = { labels: Object.keys(expenseCats), datasets: [{ data: Object.values(expenseCats), backgroundColor: ['#6366f1', '#ec4899', '#10b981', '#f59e0b', '#8b5cf6', '#64748b'], borderWidth: 0 }] };

          // --- WHATSAPP REMINDER LOGIC ---
          const overdueUnits = units.filter(u => {
              const balance = outstanding[u.id] || 0;
              if (balance <= 0) return false;
              if (!u.enableReminder) return false;
              const today = new Date().getDate();
              const startRemindingDay = Number(u.dueDay) - 2; 
              return today >= startRemindingDay;
          });

          // --- NEW: UNPAID UNITS LOGIC ---
          const unpaidUnits = units.filter(u => {
              const balance = outstanding[u.id] || 0;
              return balance > 0 && u.tenant; // Has balance and has tenant
          });

          return (
              <div className="space-y-6 animate-slide-up">
                  <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                      <StatCard label="Total Income" value={currency(totals.income)} icon="üí∞" color="text-emerald-600" />
                      <StatCard label="Total Expense" value={currency(totals.expense)} icon="üìâ" color="text-rose-600" />
                      <StatCard label="Net Profit" value={currency(totals.net)} icon="üè¶" color="text-indigo-600" />
                      <StatCard label="Total Due" value={currency(totalDue)} icon="‚ö†Ô∏è" color="text-orange-500" sub={`${dueCount} units pending`} />
                  </div>
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                      <div className="lg:col-span-2 space-y-6">
                          <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                              <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center gap-2"><span className="bg-indigo-100 dark:bg-indigo-900/50 p-1 rounded text-indigo-600">üìä</span> Cash Flow Trend</h3>
                              <ChartComponent data={chartData} type="bar" />
                          </div>
                          
                          {/* NEW: UNPAID STATUS */}
                          <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center justify-between">
                                  <div className="flex items-center gap-2"><span className="bg-red-100 dark:bg-red-900/50 p-1 rounded text-red-600">‚ö†Ô∏è</span> Unpaid Status (Current Month)</div>
                                  <span className="text-xs bg-slate-100 text-slate-700 px-2 py-1 rounded-full">{unpaidUnits.length} Units</span>
                                </h3>
                                <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                                  {unpaidUnits.length === 0 ? (
                                    <div className="text-center py-4 text-emerald-500 text-sm font-medium">All tenants have paid! üéâ</div>
                                  ) : (
                                    unpaidUnits.map(u => (
                                      <div key={u.id} className="flex items-center justify-between p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-100 dark:border-red-800">
                                          <div className="flex items-center gap-3">
                                              <div className="h-8 w-8 rounded-full bg-white dark:bg-slate-800 flex items-center justify-center font-bold text-slate-500 text-xs shadow-sm">{u.id}</div>
                                              <div>
                                                  <div className="font-bold text-sm text-slate-800 dark:text-slate-200">{u.tenant || "Unknown"}</div>
                                                  <div className="text-xs text-slate-500">Rent: {currency(u.rent)}</div>
                                              </div>
                                          </div>
                                          <div className="text-right">
                                             <div className="text-sm font-bold text-red-600">Due: {currency(outstanding[u.id])}</div>
                                             <div className="text-xs text-slate-400">by {u.dueDay}th</div>
                                          </div>
                                      </div>
                                    ))
                                  )}
                                </div>
                          </div>

                          {/* REMINDER CENTER */}
                          <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                              <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-4 flex items-center justify-between">
                                  <div className="flex items-center gap-2"><span className="bg-emerald-100 dark:bg-emerald-900/50 p-1 rounded text-emerald-600">üí¨</span> Due Reminders</div>
                                  <span className="text-xs bg-rose-100 text-rose-700 px-2 py-1 rounded-full">{overdueUnits.length} To Send</span>
                              </h3>
                              <div className="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                                  {overdueUnits.length === 0 ? (
                                    <div className="text-center py-8 text-slate-400 italic text-sm">
                                        No active reminders.<br/>
                                        <span className="text-xs opacity-70">(Check if WhatsApp is enabled in Unit settings & due date is near)</span>
                                    </div>
                                  ) : (
                                    overdueUnits.map(u => (
                                      <div key={u.id} className="flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-700/30 rounded-lg border border-slate-100 dark:border-slate-700">
                                          <div className="flex items-center gap-3">
                                              <div className="h-10 w-10 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center font-bold text-slate-500 text-xs">{u.id}</div>
                                              <div>
                                                  <div className="font-bold text-sm text-slate-800 dark:text-slate-200">{u.tenant || "Unknown"}</div>
                                                  <div className="text-xs text-rose-500 font-mono">Due: {currency(outstanding[u.id])} by {u.dueDay}th</div>
                                              </div>
                                          </div>
                                          <a href={createWhatsAppLink(u.tenantPhone, u.tenant, u.name, org.name, u.dueDay, outstanding[u.id])} 
                                             target="_blank" 
                                             className="bg-emerald-500 hover:bg-emerald-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 shadow-sm hover:shadow active:scale-95 transition-all">
                                              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.374-5.03c0-5.445 4.431-9.872 9.871-9.872 2.636 0 5.115 1.026 6.979 2.89 1.864 1.864 2.89 4.343 2.89 6.979 0 5.445-4.431 9.872-9.871 9.872z"/></svg>
                                              Send
                                          </a>
                                      </div>
                                    ))
                                  )}
                              </div>
                          </div>
                      </div>

                      {/* RIGHT COLUMN: PIE CHART & TOP UNITS */}
                      <div className="space-y-6">
                          <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 h-80">
                               <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-2 text-sm flex items-center gap-2"><span className="bg-rose-100 dark:bg-rose-900/50 p-1 rounded text-rose-600">üìâ</span> Expense Breakdown</h3>
                              {Object.keys(expenseCats).length > 0 ? <div className="relative h-60"><ChartComponent data={pieData} type="doughnut" /></div> : <div className="h-full flex items-center justify-center text-slate-400 text-xs">No expenses recorded</div>}
                          </div>
                          <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                              <h3 className="font-bold text-slate-700 dark:text-slate-200 mb-3 text-sm">Top Unit Value</h3>
                              <div className="space-y-3">
                                  {units.sort((a,b) => b.rent - a.rent).slice(0,3).map((u, i) => (
                                      <div key={u.id} className="flex items-center justify-between">
                                          <div className="flex items-center gap-2"><span className={`text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full ${i===0?'bg-yellow-100 text-yellow-600': 'bg-slate-100 text-slate-500'}`}>{i+1}</span><span className="text-sm text-slate-600 dark:text-slate-300">{u.name}</span></div>
                                          <span className="text-sm font-bold text-slate-800 dark:text-slate-100">{currency(u.rent)}</span>
                                      </div>
                                  ))}
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          );
      }

      function UnitsSection({ units, upsertUnit, deleteUnit }) {
          const [form, setForm] = useState({});
          const [search, setSearch] = useState("");
          
          const filtered = units.filter(u => u.name.toLowerCase().includes(search.toLowerCase()) || (u.tenant||"").toLowerCase().includes(search.toLowerCase()));
          return (
              <div className="grid lg:grid-cols-3 gap-6">
                  <Section title={form.id ? "Edit Unit" : "Add Unit"} className="h-fit">
                      <div className="space-y-3">
                          <div className="grid grid-cols-3 gap-2">
                              <Input placeholder="ID (e.g. A1)" value={form.id||""} onChange={e => setForm({...form, id: e.target.value})} disabled={!!form.rent} className="col-span-1" />
                              <Select value={form.type||"Flat"} onChange={e => setForm({...form, type: e.target.value})} className="col-span-2"><option>Flat</option><option>Shop</option></Select>
                          </div>
                          <Input placeholder="Unit Name" value={form.name||""} onChange={e => setForm({...form, name: e.target.value})} />
                          <div className="grid grid-cols-2 gap-2">
                              <Input type="number" placeholder="Rent" value={form.rent||""} onChange={e => setForm({...form, rent: e.target.value})} />
                              <Input type="number" placeholder="Due Day" value={form.dueDay||""} onChange={e => setForm({...form, dueDay: e.target.value})} />
                          </div>
                          <hr className="border-slate-100 dark:border-slate-700" />
                          <Input placeholder="Tenant Name" value={form.tenant||""} onChange={e => setForm({...form, tenant: e.target.value})} />
                          <Input placeholder="Tenant Phone" value={form.tenantPhone||""} onChange={e => setForm({...form, tenantPhone: e.target.value})} />
                          <Checkbox id="remind" label="WhatsApp Reminder" checked={!!form.enableReminder} onChange={e => setForm({...form, enableReminder: e.target.checked})} />
                          
                          {form.id && (
                              <div className="grid grid-cols-3 gap-2 mt-2">
                                  <FileUpload label="Photo" urlKey="tenantPhoto" unitId={form.id} setUnitForm={setForm} currentUrl={form.tenantPhotoUrl} />
                                  <FileUpload label="NID" urlKey="tenantNid" unitId={form.id} setUnitForm={setForm} currentUrl={form.tenantNidUrl} />
                                  <FileUpload label="Deed" urlKey="rentAgreement" unitId={form.id} setUnitForm={setForm} currentUrl={form.rentAgreementUrl} />
                              </div>
                          )}

                          <div className="flex gap-2 pt-2">
                              <Button className="flex-1" onClick={() => { if(!form.id) return; upsertUnit(form); setForm({}); }}>Save</Button>
                              <Button variant="secondary" onClick={() => setForm({})}>Cancel</Button>
                              {form.id && <Button variant="danger" onClick={() => { deleteUnit(form.id); setForm({}); }}>Del</Button>}
                          </div>
                      </div>
                  </Section>
                  
                  <Section title="Unit List" right={<Input placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} className="w-40" />} className="lg:col-span-2">
                      <div className="overflow-x-auto">
                          <table className="min-w-full text-sm">
                              <thead className="bg-slate-50 dark:bg-slate-700/50 text-left text-slate-500">
                                  <tr><th className="p-3 rounded-l-lg">Unit</th><th className="p-3">Tenant</th><th className="p-3 text-right">Rent</th><th className="p-3 rounded-r-lg w-10"></th></tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                  {filtered.map(u => (
                                      <tr key={u.id} className="group hover:bg-slate-50 dark:hover:bg-slate-700/30 transition">
                                          <td className="p-3 font-medium">{u.name} <div className="text-xs text-slate-400">{u.type}</div></td>
                                          <td className="p-3">{u.tenant ? <div>{u.tenant}<div className="text-xs text-slate-400">{u.tenantPhone}</div></div> : <span className="text-slate-400 text-xs italic">Vacant</span>}</td>
                                          <td className="p-3 text-right font-mono">{currency(u.rent)}</td>
                                          <td className="p-3"><Button variant="ghost" className="!p-1" onClick={() => setForm(u)}>‚úé</Button></td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                  </Section>
              </div>
          );
      }

      function PaymentsSection({ payments, units, onRowClick, onDelete }) {
          const [search, setSearch] = useState("");
          const [monthFilter, setMonthFilter] = useState("");
          const [currentPage, setCurrentPage] = useState(1);
          const itemsPerPage = 10;
          const filtered = useMemo(() => {
              let res = payments;
              if (monthFilter) res = res.filter(p => (p.forMonth || "").startsWith(monthFilter));
              if (search) {
                  const q = search.toLowerCase();
                  res = res.filter(p => p.receiptNo.toLowerCase().includes(q) || p.tenant.toLowerCase().includes(q));
              }
              return res.sort((a,b) => new Date(b.date) - new Date(a.date));
          }, [payments, search, monthFilter]);
          const paginated = useMemo(() => {
              const start = (currentPage - 1) * itemsPerPage;
              return filtered.slice(start, start + itemsPerPage);
          }, [filtered, currentPage]);
          useEffect(() => setCurrentPage(1), [search, monthFilter]);

          const exportCsv = () => {
              const header = ["Date", "Receipt No", "Unit", "Tenant", "Month", "Amount", "Method"];
              const rows = filtered.map(p => [p.date, p.receiptNo, p.unitId, p.tenant, p.forMonth, p.amount, p.method]);
              exportToCSV([header, ...rows], `payments_${todayStr()}.csv`);
          };
          return (
              <Section title="Transaction History" right={
                  <div className="flex gap-2">
                      <Input type="month" value={monthFilter} onChange={e => setMonthFilter(e.target.value)} className="w-auto" />
                      <Button variant="secondary" onClick={exportCsv} title="Export CSV">‚¨á CSV</Button>
                  </div>
              }>
                  <div className="mb-4"><Input placeholder="Search receipt number or tenant name..." value={search} onChange={e => setSearch(e.target.value)} /></div>
                  <div className="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                      <table className="min-w-full text-sm">
                          <thead className="bg-slate-50 dark:bg-slate-700/50 text-left text-slate-500">
                              <tr><th className="p-3 w-10 text-center">S.N.</th><th className="p-3">Date</th><th className="p-3">Receipt</th><th className="p-3">Details</th><th className="p-3 text-right">Amount</th><th className="p-3 text-center">Action</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                              {paginated.map((p, i) => (
                                  <tr key={p.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/30">
                                      <td className="p-3 text-center text-xs text-slate-400">{(currentPage - 1) * itemsPerPage + i + 1}</td>
                                      <td className="p-3 whitespace-nowrap text-slate-500">{formatDisplayDate(p.date)}</td>
                                      <td className="p-3 font-mono text-xs">
                                        {p.receiptNo}
                                        {/* NEW: Print Indicator */}
                                        {p.isPrinted && <span className="ml-2 text-emerald-500 text-xs" title="Printed">‚úì‚úì</span>}
                                      </td>
                                      <td className="p-3">
                                          <div className="font-medium">{p.tenant}</div>
                                          <div className="text-xs text-slate-400">{units.find(u => u.id === p.unitId)?.name} ‚Ä¢ {formatMonth(p.forMonth)}</div>
                                      </td>
                                      <td className="p-3 text-right font-medium text-emerald-600">{currency(p.amount)}</td>
                                      <td className="p-3 flex justify-center gap-2">
                                          <button onClick={() => onRowClick(p)} className="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded">Print</button>
                                          <button onClick={() => onDelete(p.id)} className="text-rose-600 hover:bg-rose-50 p-1.5 rounded">‚úï</button>
                                      </td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                      {filtered.length === 0 && <div className="p-8 text-center text-slate-400">No records found.</div>}
                  </div>
                  <Pagination totalItems={filtered.length} itemsPerPage={itemsPerPage} currentPage={currentPage} setCurrentPage={setCurrentPage} />
              </Section>
          );
      }

      function NewReceiptSection({ units, addPayment, data }) {
          const [form, setForm] = useState({ date: todayStr(), method: "Cash", purpose: "Rent" });
          useEffect(() => { if (!form.receiptNo) setForm(f => ({ ...f, receiptNo: nextReceiptNo(data.payments) })); }, [data.payments]);
          const handleUnitChange = (e) => {
              const u = units.find(x => x.id === e.target.value);
              if (u) setForm(f => ({ ...f, unitId: u.id, tenant: u.tenant, amount: u.rent }));
          };
          const submit = () => {
              if (!form.unitId || !form.amount || !form.forMonth) return alert("Please fill all required fields");
              addPayment({ ...form, amount: Number(form.amount), purpose: form.purpose });
              setForm({ date: todayStr(), method: "Cash", purpose: "Rent", receiptNo: nextReceiptNo([...data.payments, form]) });
          };
          const selectedUnit = units.find(u => u.id === form.unitId);

          return (
              <div className="grid md:grid-cols-3 gap-6">
                  <Section title="Issue Receipt" className="md:col-span-2">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                          <Input label="Date" type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                          <Select label="Purpose" value={form.purpose} onChange={e => setForm({...form, purpose: e.target.value})}><option>Rent</option><option>Advance</option><option>Service Charge</option><option>Utility</option></Select>
                          <Select label="Unit" value={form.unitId||""} onChange={handleUnitChange}>
                              <option value="" disabled>Select Unit...</option>
                              {units.map(u => <option key={u.id} value={u.id}>{u.name} {u.tenant ? `(${u.tenant})` : '- Vacant'}</option>)}
                          </Select>
                          <Input label="For Month" type="month" value={form.forMonth||""} onChange={e => setForm({...form, forMonth: e.target.value})} />
                          <Input label="Tenant" value={form.tenant||""} onChange={e => setForm({...form, tenant: e.target.value})} />
                          <Select label="Method" value={form.method} onChange={e => setForm({...form, method: e.target.value})}><option>Cash</option><option>Bank Transfer</option><option>Bkash</option><option>Nagad</option></Select>
                          <div className="md:col-span-2">
                              <Input label="Amount" type="number" value={form.amount||""} onChange={e => setForm({...form, amount: e.target.value})} className="font-bold text-lg text-indigo-600" placeholder="0.00" />
                          </div>
                          <div className="md:col-span-2">
                              <Input placeholder="Notes (Optional)" value={form.notes||""} onChange={e => setForm({...form, notes: e.target.value})} />
                          </div>
                      </div>
                      <div className="flex gap-4">
                          <Button onClick={submit} className="flex-1 py-3 text-base shadow-md">Generate Receipt</Button>
                          <Button variant="secondary" onClick={() => setForm({ date: todayStr(), method: "Cash", purpose: "Rent" })}>Reset</Button>
                      </div>
                  </Section>

                  <div className="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-xl p-6 h-fit">
                      <h3 className="font-bold text-indigo-900 dark:text-indigo-300 mb-4 border-b border-indigo-200 pb-2">Receipt Preview</h3>
                      {selectedUnit ? (
                          <div className="space-y-3 text-sm text-slate-700 dark:text-slate-300">
                              <div className="flex justify-between"><span>Unit:</span> <span className="font-bold">{selectedUnit.name}</span></div>
                              <div className="flex justify-between"><span>Tenant:</span> <span>{selectedUnit.tenant}</span></div>
                              <div className="flex justify-between"><span>Standard Rent:</span> <span>{currency(selectedUnit.rent)}</span></div>
                              <div className="mt-4 p-3 bg-white dark:bg-slate-900 rounded border border-indigo-100 dark:border-indigo-800 text-xs text-indigo-600">
                                  Next Receipt No: <b>{form.receiptNo}</b><br/>
                                  Month: <b>{form.forMonth ? formatMonth(form.forMonth) : '...'}</b>
                              </div>
                          </div>
                      ) : (
                          <div className="text-sm text-indigo-400 italic text-center py-8">Select a unit to see details</div>
                      )}
                  </div>
              </div>
          );
      }

      function ExpensesSection({ expenses, addExpense, onDelete }) {
          const [form, setForm] = useState({ date: todayStr() });
          const [currentPage, setCurrentPage] = useState(1);
          const itemsPerPage = 10;

          const sorted = useMemo(() => expenses.sort((a,b) => new Date(b.date)-new Date(a.date)), [expenses]);
          const paginated = useMemo(() => {
              const start = (currentPage - 1) * itemsPerPage;
              return sorted.slice(start, start + itemsPerPage);
          }, [sorted, currentPage]);
          return (
              <div className="grid lg:grid-cols-3 gap-6">
                  <Section title="Add Expense" className="h-fit">
                      <div className="space-y-3">
                          <Input type="date" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                          <Input placeholder="Category (e.g. Repair)" value={form.category||""} onChange={e => setForm({...form, category: e.target.value})} />
                          <Input placeholder="Vendor (Optional)" value={form.vendor||""} onChange={e => setForm({...form, vendor: e.target.value})} />
                          <Input type="number" placeholder="Amount" value={form.amount||""} onChange={e => setForm({...form, amount: e.target.value})} />
                          <Input placeholder="Notes" value={form.notes||""} onChange={e => setForm({...form, notes: e.target.value})} />
                          <Button className="w-full" onClick={() => { if(!form.amount) return; addExpense(form); setForm({ date: todayStr() }); }}>Record Expense</Button>
                      </div>
                  </Section>
                  <Section title="Expense Log" className="lg:col-span-2">
                      <div className="overflow-x-auto">
                          <table className="min-w-full text-sm">
                              <thead className="bg-slate-50 dark:bg-slate-700/50 text-left text-slate-500"><tr><th className="p-3 w-10 text-center">S.N.</th><th className="p-3">Date</th><th className="p-3">Details</th><th className="p-3 text-right">Amount</th><th className="p-3 text-center"></th></tr></thead>
                              <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                                  {paginated.map((e, i) => (
                                      <tr key={e.id}>
                                          <td className="p-3 text-center text-xs text-slate-400">{(currentPage - 1) * itemsPerPage + i + 1}</td>
                                          <td className="p-3 text-slate-500">{formatDisplayDate(e.date)}</td>
                                          <td className="p-3"><div className="font-medium">{e.category}</div><div className="text-xs text-slate-400">{e.vendor}</div></td>
                                          <td className="p-3 text-right font-medium text-rose-600">{currency(e.amount)}</td>
                                          <td className="p-3 text-center"><button onClick={() => onDelete(e.id)} className="text-slate-400 hover:text-rose-600">‚úï</button></td>
                                      </tr>
                                  ))}
                              </tbody>
                          </table>
                      </div>
                      <Pagination totalItems={sorted.length} itemsPerPage={itemsPerPage} currentPage={currentPage} setCurrentPage={setCurrentPage} />
                  </Section>
              </div>
          );
      }

      function StatementView({ payments, expenses, org }) {
          const [range, setRange] = useState({ start: new Date().toISOString().slice(0, 8) + "01", end: todayStr() });
          const report = useMemo(() => {
              const s = new Date(range.start).getTime();
              const e = new Date(range.end).getTime() + 86400000;
              const pItems = payments.filter(x => { const t = new Date(x.date).getTime(); return t >= s && t < e; }).map(x => ({ ...x, type: 'inc', desc: `Rent - ${x.tenant}` }));
              const eItems = expenses.filter(x => { const t = new Date(x.date).getTime(); return t >= s && t < e; }).map(x => ({ ...x, type: 'exp', desc: `${x.category} (${x.vendor||'-'})` }));
              
              const all = [...pItems, ...eItems].sort((a,b) => new Date(a.date) - new Date(b.date));
              const totalInc = pItems.reduce((sum, x) => sum + Number(x.amount), 0);
              const totalExp = eItems.reduce((sum, x) => sum + Number(x.amount), 0);
              
              let bal = 0;
              const rows = all.map(item => {
                  bal += item.type === 'inc' ? Number(item.amount) : -Number(item.amount);
                  return { ...item, bal };
              });
              return { rows, totalInc, totalExp, net: totalInc - totalExp };
          }, [payments, expenses, range]);
          const printStatement = () => {
              const w = window.open("", "_blank");
              const html = `
              <!DOCTYPE html>
              <html>
              <head>
                <title>Statement</title>
                <style>
                  body { font-family: sans-serif; font-size: 12px; padding: 20px; }
                  .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                  .header h1 { margin: 0; font-size: 20px; }
                  .header p { margin: 2px 0; color: #555; }
                  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                  th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
                  th { background: #f0f0f0; }
                  .text-right { text-align: right; }
                  .summary { margin-top: 20px; display: flex; justify-content: flex-end; gap: 20px; font-weight: bold; }
                </style>
              </head>
              <body>
                <div class="header">
                  <h1>${escapeHTML(org.name)}</h1>
                  <p>${escapeHTML(org.address)}</p>
                  <p>Phone: ${escapeHTML(org.phone)}</p>
                  <h3>Financial Statement</h3>
                  <p>From: ${formatDisplayDate(range.start)} To: ${formatDisplayDate(range.end)}</p>
                </div>
                <table>
                  <thead>
                    <tr>
                      <th style="width: 40px">S.N.</th>
                      <th>Date</th>
                      <th>Description</th>
                      <th>Type</th>
                      <th class="text-right">Amount</th>
                      <th class="text-right">Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${report.rows.map((item, index) => `
                      <tr>
                        <td>${index + 1}</td>
                        <td>${formatDisplayDate(item.date)}</td>
                        <td>${escapeHTML(item.desc)}</td>
                        <td>${item.type === 'inc' ? 'Income' : 'Expense'}</td>
                        <td class="text-right">${currency(item.amount)}</td>
                        <td class="text-right">${currency(item.bal)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
                <div class="summary">
                  <div>Total Income: ${currency(report.totalInc)}</div>
                  <div style="margin-left: 20px;">Total Expense: ${currency(report.totalExp)}</div>
                  <div style="margin-left: 20px;">Net Profit: ${currency(report.net)}</div>
                </div>
                <script>window.print();<\/script>
              </body>
              </html>
              `;
              w.document.write(html);
              w.document.close();
          };

          return (
              <div className="space-y-6">
                  <div className="flex gap-4 items-end bg-slate-50 dark:bg-slate-700/50 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                      <div className="flex-1"><label className="block text-xs font-bold uppercase text-slate-500 mb-1">From</label><Input type="date" value={range.start} onChange={e => setRange({...range, start: e.target.value})} /></div>
                      <div className="flex-1"><label className="block text-xs font-bold uppercase text-slate-500 mb-1">To</label><Input type="date" value={range.end} onChange={e => setRange({...range, end: e.target.value})} /></div>
                      <Button onClick={printStatement}>Print Report</Button>
                  </div>
                  
                  <div className="grid grid-cols-3 gap-4 text-center">
                      <div className="p-4 bg-emerald-50 text-emerald-700 rounded-xl border border-emerald-100">
                          <div className="text-xs font-bold uppercase opacity-70">Income</div>
                          <div className="text-xl font-bold">{currency(report.totalInc)}</div>
                      </div>
                      <div className="p-4 bg-rose-50 text-rose-700 rounded-xl border border-rose-100">
                          <div className="text-xs font-bold uppercase opacity-70">Expense</div>
                          <div className="text-xl font-bold">{currency(report.totalExp)}</div>
                      </div>
                      <div className="p-4 bg-indigo-50 text-indigo-700 rounded-xl border border-indigo-100">
                          <div className="text-xs font-bold uppercase opacity-70">Net Profit</div>
                          <div className="text-xl font-bold">{currency(report.net)}</div>
                      </div>
                  </div>

                  <div className="overflow-x-auto rounded-xl border border-slate-200 dark:border-slate-700 print:border-black">
                      <table className="min-w-full text-sm">
                          <thead className="bg-slate-100 dark:bg-slate-800 font-bold text-slate-600">
                              <tr><th className="p-3 w-10 text-center">S.N.</th><th className="p-3 text-left">Date</th><th className="p-3 text-left">Description</th><th className="p-3 text-right">Credit</th><th className="p-3 text-right">Debit</th><th className="p-3 text-right">Balance</th></tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                              {report.rows.map((r, i) => (
                                  <tr key={r.id}>
                                      <td className="p-3 text-center text-xs text-slate-400">{i + 1}</td>
                                      <td className="p-3 whitespace-nowrap">{formatDisplayDate(r.date)}</td>
                                      <td className="p-3">{r.desc}</td>
                                      <td className="p-3 text-right text-emerald-600">{r.type === 'inc' ? currency(r.amount) : '-'}</td>
                                      <td className="p-3 text-right text-rose-600">{r.type === 'exp' ? currency(r.amount) : '-'}</td>
                                      <td className="p-3 text-right font-mono font-bold text-slate-600 dark:text-slate-300">{currency(r.bal)}</td>
                                  </tr>
                              ))}
                          </tbody>
                      </table>
                  </div>
              </div>
          );
      }
      
      function SettingsSection({ org, settings, updateOrg, updateSettings, data, setData }) {
          const [showTutorial, setShowTutorial] = useState(false);
          
          const exportData = () => {
              const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href = url; a.download = `backup_${todayStr()}.json`; a.click();
          };
          const importData = (e) => {
              const fr = new FileReader();
              fr.onload = (ev) => { setData(JSON.parse(ev.target.result)); alert("Restored!"); };
              if (e.target.files[0]) fr.readAsText(e.target.files[0]);
          };
          return (
              <div className="grid md:grid-cols-2 gap-6">
                  <Section title="Appearance">
                      <div className="flex items-center justify-between mb-4">
                          <span>Dark Mode</span>
                          <button onClick={() => updateSettings({ darkMode: !settings.darkMode })} className={`w-12 h-6 rounded-full transition-colors relative ${settings.darkMode ? 'bg-indigo-600' : 'bg-slate-300'}`}>
                              <span className={`absolute top-1 left-1 bg-white h-4 w-4 rounded-full transition-transform ${settings.darkMode ? 'translate-x-6' : ''}`} />
                          </button>
                      </div>
                      
                      <div className="flex gap-2">
                          {Object.entries(THEMES).map(([k,v]) => (
                              <button key={k} onClick={() => updateSettings({ theme: k })} className={`w-8 h-8 rounded-full border-2 ${settings.theme === k ? 'border-slate-800 dark:border-white scale-110' : 'border-transparent'}`} style={{background: v.colors[500]}} />
                          ))}
                      </div>
                  </Section>
                  
                  <Section title="Google Sheet Backup">
                       <div className="space-y-3">
                          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300">
                              Script Web App URL
                          </label>
                          <Input 
                              placeholder="https://script.google.com/macros/s/..." 
                              value={settings.backupUrl || ""} 
                              onChange={e => updateSettings({ backupUrl: e.target.value })} 
                          />
                          <div className="flex justify-between items-center text-xs text-slate-500">
                             <span>Auto-sync enabled when URL is present.</span>
                             <button onClick={() => setShowTutorial(true)} className="text-indigo-600 font-bold hover:underline">How to setup?</button>
                          </div>
                      </div>
                  </Section>

                  <Section title="Organization Info">
                      <div className="space-y-3">
                          <Input placeholder="Organization Name" value={org.name} onChange={e => updateOrg({ name: e.target.value })} />
                          <Input placeholder="Address" value={org.address} onChange={e => updateOrg({ address: e.target.value })} />
                          <Input placeholder="Phone" value={org.phone} onChange={e => updateOrg({ phone: e.target.value })} />
                          <Input placeholder="Receipt Footer Note" value={org.note} onChange={e => updateOrg({ note: e.target.value })} />
                      </div>
                  </Section>
                  <Section title="Data Management" className="md:col-span-2">
                      <div className="flex flex-col md:flex-row gap-4">
                          <Button onClick={exportData} className="flex-1">Download Backup</Button>
                          <label className="flex-1 flex items-center justify-center px-4 py-2 border-2 border-dashed border-indigo-300 rounded-lg cursor-pointer hover:bg-indigo-50 dark:hover:bg-slate-700 text-indigo-600">
                              Restore Backup <input type="file" className="hidden" onChange={importData} />
                          </label>
                          <Button variant="danger" onClick={() => { if(confirm("ERASE ALL DATA?")) setData({ ...initialData, settings: data.settings }); }}>Factory Reset</Button>
                      </div>
                  </Section>
                  
                  {showTutorial && <TutorialModal onClose={() => setShowTutorial(false)} />}
              </div>
          );
      }

      /* ------------- Shared UI ------------- */
      function StatCard({ label, value, icon, color, sub }) {
          return (
              <div className="bg-white dark:bg-slate-800 p-5 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 relative overflow-hidden group hover:shadow-md transition">
                  <div className="relative z-10">
                      <div className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">{label}</div>
                      <div className={`text-2xl font-bold ${color}`}>{value}</div>
                      {sub && <div className="text-xs text-slate-400 mt-1">{sub}</div>}
                  </div>
                  <div className="absolute right-4 bottom-4 text-4xl opacity-10 grayscale group-hover:grayscale-0 group-hover:opacity-20 transition-all group-hover:scale-110">{icon}</div>
              </div>
          );
      }

      // MODIFIED: Accepts onPrintMark callback
      function ReceiptModal({ org, payment, unit, onClose, onPrintMark }) {
        const ref = useRef();
        const printNow = () => { 
            const w = window.open("", "_blank"); 
            w.document.write(renderReceiptHTML(org, payment, unit)); 
            w.document.close(); 
            w.focus(); 
            onPrintMark(); // Mark as printed in database
            setTimeout(() => w.print(), 200); 
        };
        return ( <div className="fixed inset-0 z-50 bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm"> <div ref={ref} className="bg-white w-full sm:max-w-lg rounded-t-2xl sm:rounded-xl shadow-2xl flex flex-col max-h-[90vh] animate-in slide-in-from-bottom sm:zoom-in-95"> <div className="p-4 border-b flex items-center justify-between"> <h3 className="font-bold text-lg text-slate-900">Receipt #{payment.receiptNo}</h3> <div className="flex gap-2"> <Button variant="primary" onClick={printNow}>üñ®Ô∏è Print</Button> <Button variant="secondary" onClick={onClose}>Close</Button> </div> </div> <div className="p-6 overflow-y-auto bg-slate-100 flex-1 flex items-center justify-center"> <div className="bg-white shadow-lg w-full max-w-[100%]" dangerouslySetInnerHTML={{ __html: renderReceiptInner(org, payment, unit) }} /> </div> </div> </div> );
      }
      
      function TutorialModal({ onClose }) {
          const scriptCode = `function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000); 

  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var data = JSON.parse(e.postData.contents);
    
    // Safety check for amount
    var rawAmount = data.amount;
    var amountVal = parseFloat(rawAmount);
    if (isNaN(amountVal)) amountVal = 0;

    // --- 1. LEDGER (Smart Write) ---
    var sheetLedger = ss.getSheetByName("Ledger");
    if (sheetLedger) {
      // Find the next empty row based specifically on Column A (Date)
      // This ignores the formula in Column E preventing the "Row 1000" bug.
      var lastRow = getLastRowInColumn(sheetLedger, 1); // 1 = Column A
      var nextRow = lastRow + 1;
      
      // Write Date, Type, Desc, Amount to Columns A, B, C, D
      sheetLedger.getRange(nextRow, 1, 1, 4).setValues([[
        data.date, 
        data.type, 
        data.desc, 
        amountVal
      ]]);
    }

    // --- 2. RECEIPTS (Normal Append) ---
    if (data.type === "Income") {
      var sheetReceipts = ss.getSheetByName("Receipts");
      if (sheetReceipts) {
        sheetReceipts.appendRow([
          data.date, 
          "'" + data.receiptNo, 
          data.unit, 
          data.tenant, 
          data.month, 
          data.method, 
          Math.abs(amountVal)
        ]);
      }
    } 
    // --- 3. EXPENSES (Normal Append) ---
    else if (data.type === "Expense") {
      var sheetExpenses = ss.getSheetByName("Expenses");
      if (sheetExpenses) {
        sheetExpenses.appendRow([
          data.date, 
          data.category, 
          data.vendor, 
          data.notes, 
          Math.abs(amountVal)
        ]);
      }
    }
    
    return ContentService.createTextOutput(JSON.stringify({"result":"success"})).setMimeType(ContentService.MimeType.JSON);
  } catch(e) {
    return ContentService.createTextOutput(JSON.stringify({"result":"error", "error": e.toString()})).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// Helper function to find the real last row with data in a specific column
function getLastRowInColumn(sheet, columnNumber) {
  var lastRow = sheet.getLastRow();
  if (lastRow === 0) return 0;
  
  var range = sheet.getRange(1, columnNumber, lastRow);
  var values = range.getValues();
  
  for (var i = values.length - 1; i >= 0; i--) {
    if (values[i][0] !== "" && values[i][0] != null) {
      return i + 1;
    }
  }
  return 0; // If column is completely empty
}`;
          return (
              <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
                  <div className="bg-white dark:bg-slate-800 w-full max-w-3xl rounded-xl shadow-2xl p-6 overflow-y-auto max-h-[90vh] custom-scrollbar">
                      <div className="flex justify-between items-center mb-4">
                          <h2 className="text-xl font-bold text-slate-800 dark:text-white">Setup Google Sheet Backup</h2>
                          <button onClick={onClose} className="text-2xl text-slate-400 hover:text-rose-500">&times;</button>
                      </div>
                      <div className="space-y-6 text-sm text-slate-600 dark:text-slate-300">
                          
                          <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg space-y-2">
                              <h3 className="font-bold text-indigo-700 dark:text-indigo-300">Step 1: Create Sheets & Columns</h3>
                              <p>Create a new Google Sheet. Rename the tabs at the bottom to <b>exactly</b> these names (case sensitive). Then add these headers in the first row:</p>
                              <ul className="list-disc ml-5 space-y-1 mt-2 font-mono text-xs">
                                  <li><b>Ledger</b> (Tab 1) -> A1:Date, B1:Type, C1:Desc, D1:Amount, E1:Balance</li>
                                  <li><b>Receipts</b> (Tab 2) -> A1:Date, B1:Receipt No, C1:Unit, D1:Tenant, E1:Month, F1:Method, G1:Amount</li>
                                  <li><b>Expenses</b> (Tab 3) -> A1:Date, B1:Category, C1:Vendor, D1:Notes, E1:Amount</li>
                              </ul>
                          </div>

                          <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg space-y-2">
                              <h3 className="font-bold text-indigo-700 dark:text-indigo-300">Step 2: Add Balance Formula</h3>
                              <p>In the <b>Ledger</b> tab, paste this formula into cell <code className="bg-white dark:bg-slate-700 px-1 rounded font-bold">E2</code> (It will calculate balance for all rows automatically):</p>
                              <div className="p-2 bg-slate-800 text-green-400 rounded font-mono text-xs select-all">
                                =ARRAYFORMULA(IF(A2:A="", "", SCAN(0, D2:D, LAMBDA(acc, val, acc + val))))
                              </div>
                          </div>

                          <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg space-y-2">
                              <h3 className="font-bold text-indigo-700 dark:text-indigo-300">Step 3: Add The Script</h3>
                              <p>Go to <b>Extensions &gt; Apps Script</b>. Delete any code there, copy the code below, and paste it in:</p>
                              <textarea readOnly className="w-full h-40 p-2 bg-slate-800 text-slate-100 rounded font-mono text-xs focus:ring-2 ring-indigo-500 outline-none" value={scriptCode} onClick={(e) => e.target.select()}></textarea>
                              <p className="text-xs italic text-slate-500">Click inside the box to select all, then copy (Ctrl+C).</p>
                          </div>

                          <div className="p-4 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg space-y-2">
                              <h3 className="font-bold text-indigo-700 dark:text-indigo-300">Step 4: Deploy</h3>
                              <ul className="list-decimal ml-5 space-y-1">
                                  <li>Click the blue <b>Deploy</b> button (top right) &gt; <b>New Deployment</b>.</li>
                                  <li>Select type: <b>Web App</b>.</li>
                                  <li>Description: "RMS v1".</li>
                                  <li>Execute as: <b>Me</b> (your email).</li>
                                  <li>Who has access: <b>Anyone</b> (Important!).</li>
                                  <li>Click <b>Deploy</b> and copy the <b>Web App URL</b>.</li>
                                  <li>Paste that URL into the Settings box in this app.</li>
                              </ul>
                          </div>
                      </div>
                      <div className="mt-6 flex justify-end">
                          <Button onClick={onClose} className="w-full md:w-auto">I Have Copied The URL</Button>
                      </div>
                  </div>
              </div>
          )
      }

      function PasswordPromptModal({ currentUser, isPasswordCorrect, onClose, onSuccess, actionLabel }) {
          const [password, setPassword] = useState("");
          const [error, setError] = useState(""); const [loading, setLoading] = useState(false);
          const handleSubmit = async (e) => { e.preventDefault();
          if (!currentUser) { onSuccess(); return; } setLoading(true); setError(""); const correct = await isPasswordCorrect(password); setLoading(false); if (correct) onSuccess();
          else { setError("Incorrect password."); setPassword(""); } };
          return (
              <div className="fixed inset-0 z-50 bg-black/60 flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-all">
                  <div className="bg-white dark:bg-slate-800 w-full sm:max-w-sm rounded-t-2xl sm:rounded-2xl shadow-2xl p-6 animate-in slide-in-from-bottom sm:zoom-in-95 duration-200 border dark:border-slate-700">
                      <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-2">{actionLabel}</h2>
                      <p className="text-sm text-slate-500 dark:text-slate-400 mb-4">Please verify your identity to continue.</p>
                      <form onSubmit={handleSubmit} className="space-y-4">
                          <Input type="password" placeholder="Enter Password" value={password} onChange={(e) => setPassword(e.target.value)} required disabled={loading} autoFocus />
                          {error && <p className="text-xs text-rose-600 font-medium">{error}</p>}
                          <div className="flex justify-end gap-3 pt-2">
                              <Button type="button" variant="secondary" onClick={onClose} className="w-full sm:w-auto">Cancel</Button>
                              <Button type="submit" disabled={loading || !password} className="w-full sm:w-auto">{loading ? "Verifying..." : "Confirm"}</Button>
                          </div>
                      </form>
                  </div>
              </div>
          );
      }

      /* ------------- Auth & Init ------------- */
      function LoginScreen({ error }) {
          const [email, setEmail] = useState("");
          const [pass, setPass] = useState("");
          const [loading, setLoading] = useState(false);
          const handleLogin = async (e) => { e.preventDefault(); setLoading(true);
          try { await auth.signInWithEmailAndPassword(email, pass); } catch(err) { alert(err.message); setLoading(false); } };
          return (
              <div className="min-h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900 p-4">
                  <div className="w-full max-w-sm bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-100 dark:border-slate-700">
                      <div className="text-center mb-8">
                          <div className="inline-flex h-12 w-12 items-center justify-center rounded-xl bg-indigo-600 text-white mb-4"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></div>
                          <h1 className="text-2xl font-bold text-slate-900 dark:text-white">RMS</h1>
                          <p className="text-slate-500 text-sm">Property Management System</p>
                      </div>
                      <form onSubmit={handleLogin} className="space-y-4">
                          <Input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required />
                          <Input type="password" placeholder="Password" value={pass} onChange={e => setPass(e.target.value)} required />
                          <Button type="submit" className="w-full py-2.5" loading={loading}>Sign In</Button>
                      </form>
                      {error && <div className="mt-4 p-3 bg-rose-50 text-rose-600 text-sm rounded-lg text-center">{error}</div>}
                      <div className="mt-6 text-center text-xs text-slate-400 font-medium">Developed by <b>Foyaz Chowdhury</b></div>
                  </div>
              </div>
          );
      }

      function AuthWrapper() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          useEffect(() => auth.onAuthStateChanged(u => { setUser(u); setLoading(false); }), []);
          if (loading) return <div className="min-h-screen flex items-center justify-center dark:bg-slate-900"><div className="w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>;
          return user ? <ToastProvider><App currentUser={user} /></ToastProvider> : <LoginScreen />;
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<AuthWrapper />);
    </script>
  </body>
</html>
