<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile ERP ‚Äî Single-File HTML (Tenant Profile & Advanced Payments)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script> 
    
    <style>
      /* Ensure full height and base background */
      html, body { height: 100%; background: #f1f5f9; }
      /* Print styles for the receipt modal */
      @media print {
        @page { size: A4; margin: 16mm; }
        /* Hide everything except the receipt when printing */
        body > *:not(.print-only) { display: none !important; } 
        .print-only { 
          display: block !important; 
          position: fixed; 
          top: 0; 
          left: 0; 
          width: 100%; 
          height: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      /* ------------- Utilities ------------- */
      const STORAGE_KEY = "rental_erp_v1";
      const todayStr = () => new Date().toISOString().slice(0, 10);

      const currency = (n) => {
        const num = Number(n || 0);
        try {
          return num
            .toLocaleString(undefined, { style: "currency", currency: "BDT" })
            .replace("BDT", "‡ß≥")
            .trim();
        } catch {
          return `‡ß≥${num.toLocaleString()}`;
        }
      };
      
      const formatMonthKey = (key) => {
        if (!key || key === 'N/A') return "N/A";
        // Safely extract year and month to create a date object
        try {
            const [year, month] = key.split('-');
            const date = new Date(year, month - 1, 1);
            if (isNaN(date)) return key; // return raw if invalid date
            return date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
        } catch (e) {
            return key;
        }
      };

      const monthKey = (dateStr) => {
        const d = new Date(dateStr);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`; // YYYY-MM
      };

      const nextReceiptNo = (allPayments) => {
        const yyyymm = monthKey(new Date().toISOString());
        const prefix = `RC-${yyyymm}-`;
        
        const maxNum = allPayments
          .filter((p) => (p.receiptNo || "").startsWith(prefix))
          .map((p) => parseInt((p.receiptNo || "").substring(prefix.length), 10))
          .filter(n => !isNaN(n))
          .reduce((max, current) => Math.max(max, current), 0);
          
        const count = maxNum + 1;
        
        return `${prefix}${String(count).padStart(4, "0")}`;
      };

      const download = (filename, text) => {
        const blob = new Blob([text], { type: "application/json;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };
      
      const downloadFile = (base64, filename) => {
          const parts = base64.split(';base64,');
          if (parts.length !== 2) {
              alert("Error: Invalid Base64 data format.");
              return;
          }
          const mime = parts[0].substring(5);
          const data = parts[1];
          
          const byteCharacters = atob(data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
              byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: mime });
          
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
      };

      const classNames = (...c) => c.filter(Boolean).join(" ");

      if (!(window.crypto && window.crypto.randomUUID)) {
        window.crypto = window.crypto || {};
        window.crypto.randomUUID = function () {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = (Math.random() * 16) | 0;
            const v = c === 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          });
        };
      }
      
      const EXPENSE_CATEGORIES = [
        "Maintenance", "Utilities (Electricity, Gas, Water)", "Property Tax", 
        "Salary (Staff/Guard)", "Advertising/Marketing", "Other"
      ];


      /* ------------- Demo initial data ------------- */
      const initialData = {
        org: {
          name: "Foyaz Properties",
          address: "123 Example Road, Dhaka",
          phone: "+8801XXXXXXXXX",
          email: "owner@example.com",
          note: "Thank you for your payment!",
        },
        units: [
          ...Array.from({ length: 10 }).map((_, i) => ({
            id: `F${i + 1}`,
            type: "Flat",
            name: `Flat ${i + 1}`,
            floor: Math.ceil((i + 1) / 2),
            rent: 15000,
            dueDay: 5,
            tenant: "",
            // NEW: Tenant Profile fields
            tenantPhoto: null,
            tenantNid: null,
            tenantAgreement: null,
          })),
          ...Array.from({ length: 5 }).map((_, i) => ({
            id: `S${i + 1}`,
            type: "Shop",
            name: `Shop ${i + 1}`,
            floor: 0,
            rent: 25000,
            dueDay: 5,
            tenant: "",
            // NEW: Tenant Profile fields
            tenantPhoto: null,
            tenantNid: null,
            tenantAgreement: null,
          })),
        ],
        payments: [], 
        expenses: [], 
      };

      const loadData = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return initialData;
          const parsed = JSON.parse(raw);
          
          // Ensure new fields exist on old data structure
          parsed.units = (parsed.units || []).map(u => ({
              ...u,
              tenantPhoto: u.tenantPhoto || null,
              tenantNid: u.tenantNid || null,
              tenantAgreement: u.tenantAgreement || null,
          }));
          
          // Ensure old payments get a default reason
          parsed.payments = (parsed.payments || []).map(p => ({
              ...p, 
              reason: p.reason || 'Rent' 
          }));

          return { ...initialData, ...parsed };
        } catch (e) {
          console.error("Load error", e);
          return initialData;
        }
      };

      const saveData = (data) => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      };
      
      const ErrorMessage = ({ message }) => 
        message ? <p className="text-rose-500 text-xs mt-1">{message}</p> : null;


      /* ------------- Small UI primitives ------------- */
      const Section = ({ title, right, children }) => (
        <div className="bg-white rounded-2xl shadow p-4 md:p-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
            {right}
          </div>
          {children}
        </div>
      );

      const Input = ({ error, ...props }) => (
        <>
          <input
            {...props}
            aria-invalid={!!error}
            className={classNames(
              "w-full rounded-xl border px-3 py-2 text-sm md:text-base",
              "focus:outline-none focus:ring-2 focus:ring-indigo-400",
              error ? "border-rose-400 focus:ring-rose-400" : "border-slate-300",
              props.className
            )}
          />
          <ErrorMessage message={error} />
        </>
      );

      const Select = ({ error, ...props }) => (
        <>
          <select
            {...props}
            aria-invalid={!!error}
            className={classNames(
              "w-full rounded-xl border px-3 py-2 text-sm md:text-base bg-white", 
              "focus:outline-none focus:ring-2 focus:ring-indigo-400",
              error ? "border-rose-400 focus:ring-rose-400" : "border-slate-300",
              props.className
            )}
          >
            {props.children}
          </select>
          <ErrorMessage message={error} />
        </>
      );

      // Improved Button component with 'size' prop, ARIA support, and refined styles
      const Button = ({ children, variant = "primary", size = "base", className, title, ...rest }) => {
        const styles = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700 active:bg-indigo-800 shadow-indigo-500/50",
          secondary: "bg-slate-100 text-slate-700 border border-slate-200 hover:bg-slate-200 active:bg-slate-300", 
          danger: "bg-rose-600 text-white hover:bg-rose-700 active:bg-rose-800",
          ghost: "bg-transparent text-slate-700 hover:bg-slate-100 active:bg-slate-200 shadow-none",
        };
        const sizes = {
          small: "px-3 py-1 text-xs",
          base: "px-4 py-2 text-sm md:text-base",
          large: "px-6 py-3 text-base md:text-lg",
        };
        
        // Simple ARIA logic for buttons that might contain icons or be titles
        const ariaLabel = title || (typeof children === 'string' ? children : undefined);


        return (
          <button
            {...rest}
            aria-label={ariaLabel}
            className={classNames(
              "rounded-xl transition shadow-sm font-medium",
              "focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400", 
              "disabled:opacity-50 disabled:cursor-not-allowed",
              styles[variant],
              sizes[size], 
              className
            )}
          >
            {children}
          </button>
        );
      };
      
      const FilterBar = ({ search, setSearch, month, setMonth, children }) => (
        <div className="grid grid-cols-2 md:grid-cols-5 gap-2 items-start">
            <Input 
                placeholder="Search by ID, name, tenant‚Ä¶" 
                value={search} 
                onChange={(e) => setSearch(e.target.value)} 
                className="col-span-2 md:col-span-2"
            />
            {setMonth && (
                <Input 
                    type="month" 
                    value={month} 
                    onChange={(e) => setMonth(e.target.value)} 
                />
            )}
            <div className={classNames("flex gap-2", setMonth ? "col-span-1" : "col-span-3")}>
              {children}
              {(search || month) && (
                <Button variant="ghost" onClick={() => { setSearch(""); setMonth && setMonth(""); }}>
                    Reset Filters
                </Button>
              )}
            </div>
        </div>
      );


      /* ------------- Main App ------------- */
      function App() {
        const [data, setData] = useState(loadData());
        const [tab, setTab] = useState("dashboard");
        const [search, setSearch] = useState(""); 
        const [month, setMonth] = useState(""); 
        const [showReceipt, setShowReceipt] = useState(null); 
        const [selectedUnitId, setSelectedUnitId] = useState(null); // State to manage which unit profile is open

        useEffect(() => saveData(data), [data]);

        const units = data.units;
        const payments = data.payments;
        const expenses = data.expenses;

        const isPaymentsFiltered = !!search || !!month;

        const totals = useMemo(() => {
          const income = payments.reduce((s, p) => s + Number(p.amount || 0), 0);
          const expense = expenses.reduce((s, e) => s + Number(e.amount || 0), 0);
          return { income, expense, net: income - expense };
        }, [payments, expenses]);

        const outstandingByUnit = useMemo(() => {
          const now = new Date();
          const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
          const map = Object.fromEntries(units.map((u) => [u.id, u.rent || 0])); 
          
          payments
            .filter((p) => (p.forMonth || "").startsWith(ym) && (p.reason === 'Rent' || p.reason === 'Advance Rent' || !p.reason)) // Only count payments for the current month's rent
            .forEach((p) => {
              map[p.unitId] = (map[p.unitId] || 0) - Number(p.amount || 0);
            });
          return map; 
        }, [units, payments]);

        const filteredUnits = useMemo(() => {
          if (!search) return units;
          const q = search.toLowerCase();
          return units.filter(
            (u) =>
              u.id.toLowerCase().includes(q) ||
              u.name.toLowerCase().includes(q) ||
              (u.tenant || "").toLowerCase().includes(q) ||
              (u.type || "").toLowerCase().includes(q)
          );
        }, [units, search]);

        // Data helpers
        const updateOrg = (patch) => setData((d) => ({ ...d, org: { ...d.org, ...patch } }));
        
        // Function to update or insert a unit
        const upsertUnit = (unit) =>
          setData((d) => ({
            ...d,
            units: d.units.some((x) => x.id === unit.id)
              ? d.units.map((x) => (x.id === unit.id ? { ...x, ...unit } : x))
              : [...d.units, unit],
          }));

        // Function to update only tenant profile fields for a unit
        const updateTenantProfile = (unitId, updates) =>
            setData((d) => ({
                ...d,
                units: d.units.map((u) => 
                    u.id === unitId ? { ...u, ...updates } : u
                ),
            }));


        const deleteUnit = (id) => setData((d) => ({ ...d, units: d.units.filter((u) => u.id !== id) }));
        const addPayment = (p) =>
          setData((d) => ({ ...d, payments: [{ ...p, id: crypto.randomUUID(), reason: p.reason || 'Rent' }, ...d.payments] }));
        const addExpense = (e) =>
          setData((d) => ({ ...d, expenses: [{ ...e, id: crypto.randomUUID() }, ...d.expenses] }));

        const exportData = () => download(`rental-erp-backup-${todayStr()}.json`, JSON.stringify(data, null, 2));
        const importData = (file) => {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const parsed = JSON.parse(evt.target.result);
              // Simple check for basic structure
              if (parsed.units && parsed.payments) {
                 // Ensure old payments get a default reason
                 parsed.payments = parsed.payments.map(p => ({...p, reason: p.reason || 'Rent' }));
                 // Ensure new unit fields exist
                 parsed.units = (parsed.units || []).map(u => ({
                    ...u,
                    tenantPhoto: u.tenantPhoto || null,
                    tenantNid: u.tenantNid || null,
                    tenantAgreement: u.tenantAgreement || null,
                 }));
                 setData(parsed);
                 alert("Import successful ‚úÖ");
              } else {
                 alert("Import failed: JSON structure is invalid.");
              }
            } catch (e) {
              alert("Import failed: invalid JSON");
            }
          };
          reader.readAsText(file);
        };

        const clearOrgFields = () =>
          setData((d) => ({ ...d, org: { name: "", address: "", phone: "", email: "", note: "" } }));

        const restoreDemoOrg = () =>
          setData((d) => ({ ...d, org: { ...initialData.org } }));

        const clearPayments = () =>
          setData((d) => ({ ...d, payments: [] }));

        const clearExpenses = () =>
          setData((d) => ({ ...d, expenses: [] }));

        const factoryReset = () => {
          setData({ ...initialData });
        };
        
        useEffect(() => {
            if (tab !== 'payments' && tab !== 'units') {
                setSearch("");
                setMonth("");
            }
        }, [tab]);


        return (
          <div className="min-h-screen bg-slate-50 text-slate-800">
            <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
              <div className="mx-auto max-w-6xl px-4 py-3 flex items-center gap-2">
                <div className="text-xl md:text-2xl font-bold">üè¢ {data.org.name}</div>
                <div className="ml-auto flex items-center gap-2">
                  <Button variant="secondary" size="small" onClick={exportData} title="Download data backup">‚§ì Export</Button>
                  <label className="cursor-pointer">
                    <span className="inline-block rounded-xl px-3 py-1 text-xs transition shadow-sm bg-slate-100 hover:bg-slate-200 border border-slate-200">Import</span>
                    <input className="hidden" type="file" accept="application/json" onChange={(e) => e.target.files?.[0] && importData(e.target.files[0])} />
                  </label>
                </div>
              </div>
              <nav className="mx-auto max-w-6xl px-2 pb-3">
                <div className="grid grid-cols-3 md:grid-cols-6 gap-2">
                  {[
                    ["dashboard", "Dashboard"],
                    ["units", "Units"],
                    ["payments", "Payments", isPaymentsFiltered && "Filtered"],
                    ["newReceipt", "New Receipt"],
                    ["expenses", "Expenses"],
                    ["settings", "Settings"],
                  ].map(([key, label, indicator]) => (
                    <Button
                      key={key}
                      variant={tab === key ? "primary" : "secondary"}
                      className="w-full relative"
                      onClick={() => { setTab(key); setSelectedUnitId(null); }} // Close profile on tab change
                    >
                      {label}
                      {indicator && (
                          <span className="absolute top-0 right-0 -mt-1 -mr-1 bg-indigo-500 text-white text-[8px] font-bold px-1 rounded-full pointer-events-none transform translate-x-1/2 -translate-y-1/2">
                              {indicator}
                          </span>
                      )}
                    </Button>
                  ))}
                </div>
              </nav>
            </header>

            <main className="mx-auto max-w-6xl p-4 space-y-4 md:space-y-6">
              {tab === "dashboard" && (
                <DashboardSection totals={totals} units={units} outstandingByUnit={outstandingByUnit} setTab={setTab} />
              )}

              {tab === "units" && (
                <Section
                  title="Units (Flats & Shops)"
                  right={<FilterBar search={search} setSearch={setSearch} />} 
                >
                  <UnitsTable 
                      units={filteredUnits} 
                      allUnits={units} 
                      upsertUnit={upsertUnit} 
                      deleteUnit={deleteUnit} 
                      onEditProfile={setSelectedUnitId}
                  />
                  {selectedUnitId && (
                      <TenantProfileModal
                          unit={units.find(u => u.id === selectedUnitId)}
                          onClose={() => setSelectedUnitId(null)}
                          updateProfile={updateTenantProfile}
                      />
                  )}
                </Section>
              )}

              {tab === "payments" && (
                <Section 
                    title="Payments (tap a row for receipt)"
                    right={<FilterBar search={search} setSearch={setSearch} month={month} setMonth={setMonth} />} 
                >
                  <PaymentsTable payments={payments} units={units} onRowClick={setShowReceipt} search={search} month={month} />
                </Section>
              )}

              {tab === "newReceipt" && (
                <Section title="Create Money Receipt">
                  <NewReceiptForm units={units} addPayment={addPayment} data={data} />
                </Section>
              )}

              {tab === "expenses" && (
                <Section title="Expenses">
                  <ExpensesSection expenses={expenses} addExpense={addExpense} />
                </Section>
              )}

              {tab === "settings" && (
                <Section title="Settings & Data Management">
                  <OrgSettings
                    org={data.org}
                    updateOrg={updateOrg}
                    clearOrgFields={clearOrgFields}
                    restoreDemoOrg={restoreDemoOrg}
                    clearPayments={() => { if (confirm("Clear ALL payments? This will remove every receipt.")) clearPayments(); }}
                    clearExpenses={() => { if (confirm("Clear ALL expenses?")) clearExpenses(); }}
                    factoryReset={() => { if (confirm("Factory Reset EVERYTHING? Units, payments, expenses and org will reset to demo.")) factoryReset(); }}
                  />
                </Section>
              )}
            </main>

            {showReceipt && (
              <ReceiptModal
                org={data.org}
                payment={showReceipt}
                unit={units.find((u) => u.id === showReceipt.unitId)}
                onClose={() => setShowReceipt(null)}
              />
            )}
          </div>
        );
      }

      /* ------------- Dashboard ------------- */
      function DashboardSection({ totals, units, outstandingByUnit, setTab }) {
        const totalDue = Object.values(outstandingByUnit).reduce((s, v) => s + Math.max(0, v), 0);

        return (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
            <StatCard label="Total Income" value={currency(totals.income)} />
            <StatCard label="Total Expenses" value={currency(totals.expense)} />
            <StatCard label="Net Profit" value={currency(totals.net)} />
            <StatCard label="Current Month Due" value={currency(totalDue)} />

            <div className="col-span-2 md:col-span-4">
              <Section title="Quick Actions" right={<div />}> 
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <Button className="w-full" size="large" onClick={() => setTab("newReceipt")}>+ New Receipt</Button>
                  <Button variant="secondary" size="large" className="w-full" onClick={() => setTab("payments")}>View Payments</Button>
                  <Button variant="secondary" size="large" className="w-full" onClick={() => setTab("units")}>Manage Units</Button>
                  <Button variant="secondary" size="large" className="w-full" onClick={() => setTab("expenses")}>+ Add Expense</Button>
                </div>
              </Section>
            </div>

            <div className="col-span-2 md:col-span-4">
              <Section title="Current Month Dues by Unit">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  {units.map((u) => (
                    <div key={u.id} className="flex items-center justify-between rounded-xl border p-3 bg-slate-50">
                      <div>
                        <div className="font-medium">{u.name} <span className="text-xs text-slate-500">({u.type})</span></div>
                        <div className="text-xs text-slate-500">Tenant: {u.tenant || "‚Äî"}</div>
                      </div>
                      <div className={classNames("text-right font-semibold", (outstandingByUnit[u.id] || 0) > 0 ? "text-rose-600" : "text-emerald-600")}>{currency(Math.max(0, outstandingByUnit[u.id] || 0))}</div>
                    </div>
                  ))}
                  {units.length === 0 && <div className="text-center text-slate-500 py-4 col-span-2">No units defined.</div>}
                </div>
              </Section>
            </div>
          </div>
        );
      }

      function StatCard({ label, value }) {
        return (
          <div className="bg-slate-50 rounded-2xl shadow border p-4">
            <div className="text-xs uppercase tracking-wide text-slate-500">{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1">{value}</div>
          </div>
        );
      }

      /* ------------- Units ------------- */
      function UnitsTable({ units, allUnits, upsertUnit, deleteUnit, onEditProfile }) {
        const [form, setForm] = useState({ type: "Flat", rent: 15000, dueDay: 5 });
        const [formErrors, setFormErrors] = useState({});

        const edit = (u) => {
            setFormErrors({});
            setForm({ ...u, originalId: u.id });
        };
        
        const reset = () => {
            setFormErrors({});
            setForm({ type: "Flat", rent: 15000, dueDay: 5, id: "", name: "", floor: "", tenant: "" });
        };

        const validateForm = (currentForm, isSubmit = false) => {
            const errors = {};
            
            const isEditing = !!currentForm.originalId;
            const currentId = currentForm.id ? currentForm.id.trim() : "";
            
            if (!currentId) {
                errors.id = "Unit ID is required.";
            } else if (!isEditing || currentId !== currentForm.originalId) {
                // Check uniqueness only if adding or changing ID during edit
                if (allUnits.some(u => u.id === currentId && u.id !== currentForm.originalId)) {
                    errors.id = "This Unit ID already exists.";
                }
            }
            
            if (!currentForm.name) errors.name = "Unit Name is required.";
            
            const rent = Number(currentForm.rent);
            if (isNaN(rent) || rent < 0) errors.rent = "Rent must be 0 or greater.";

            const dueDay = Number(currentForm.dueDay);
            if (isNaN(dueDay) || dueDay < 1 || dueDay > 28) errors.dueDay = "Due Day must be between 1 and 28.";

            if (isSubmit) {
                setFormErrors(errors);
            }
            
            return Object.keys(errors).length === 0;
        };
        
        // Immediate validation for ID input
        const handleIdChange = (e) => {
            const newId = e.target.value;
            setForm({ ...form, id: newId });
            
            const currentErrors = { ...formErrors };
            delete currentErrors.id;

            if (!newId.trim()) {
                currentErrors.id = "Unit ID is required.";
            } else if (allUnits.some(u => u.id === newId.trim() && u.id !== form.originalId)) {
                currentErrors.id = "This Unit ID already exists.";
            }

            setFormErrors(currentErrors);
        };


        const submit = () => {
          if (!validateForm(form, true)) return;
          
          const newUnit = { 
            ...form, 
            id: form.id.trim(), 
            rent: Number(form.rent || 0), 
            dueDay: Number(form.dueDay || 1) ,
            // Ensure document fields are carried over if editing
            tenantPhoto: form.tenantPhoto || null,
            tenantNid: form.tenantNid || null,
            tenantAgreement: form.tenantAgreement || null,
          };
          
          upsertUnit(newUnit);
          reset();
        };

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">{form.originalId ? "Edit Unit" : "Add New Unit"}</div>
              <div className="grid gap-2">
                <div className="grid grid-cols-2 gap-2">
                  <Input 
                    placeholder="Unit ID (e.g., F1)*" 
                    value={form.id || ""} 
                    onChange={handleIdChange} 
                    disabled={!!form.originalId && !form.id} // Disable ID change only if actively editing and ID is set
                    error={formErrors.id}
                  />
                  <Select 
                    value={form.type} 
                    onChange={(e) => setForm({ ...form, type: e.target.value })}
                  >
                    <option>Flat</option>
                    <option>Shop</option>
                  </Select>
                </div>
                <Input 
                  placeholder="Name*" 
                  value={form.name || ""} 
                  onChange={(e) => setForm({ ...form, name: e.target.value })}
                  error={formErrors.name}
                />
                <Input type="number" placeholder="Floor (0=Ground)" value={form.floor ?? ""} onChange={(e) => setForm({ ...form, floor: Number(e.target.value) })} />
                <Input 
                  type="number" 
                  placeholder="Monthly Rent (‡ß≥)*" 
                  value={form.rent ?? ""} 
                  onChange={(e) => setForm({ ...form, rent: e.target.value })}
                  error={formErrors.rent}
                />
                <Input 
                  type="number" 
                  placeholder="Due Day (1-28)*" 
                  value={form.dueDay ?? ""} 
                  onChange={(e) => setForm({ ...form, dueDay: e.target.value })}
                  error={formErrors.dueDay}
                />
                <Input placeholder="Tenant Name" value={form.tenant || ""} onChange={(e) => setForm({ ...form, tenant: e.target.value })} />
              </div>
              <div className="flex gap-2 mt-2">
                <Button onClick={submit} disabled={!validateForm(form)}>Save</Button>
                <Button variant="secondary" onClick={reset}>Clear</Button>
              </div>
            </div>

            <div className="md:col-span-2 overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600 sticky top-0">
                  <tr>
                    <th className="p-3 text-left">ID</th>
                    <th className="p-3 text-left">Name</th>
                    <th className="p-3">Rent</th>
                    <th className="p-3">Tenant</th>
                    <th className="p-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {units.map((u) => (
                    <tr key={u.id} className="border-t">
                      <td className="p-3 font-medium">{u.id}</td>
                      <td className="p-3">{u.name}</td>
                      <td className="p-3 text-right font-semibold">{currency(u.rent)}</td>
                      <td className="p-3">{u.tenant || "‚Äî"}</td>
                      <td className="p-3">
                        <div className="flex flex-col sm:flex-row gap-2">
                          <Button variant="secondary" size="small" onClick={() => edit(u)} title={`Edit ${u.name}`}>Edit Unit</Button>
                          <Button 
                              variant="secondary" 
                              size="small" 
                              onClick={() => onEditProfile(u.id)} 
                              title={`Edit Tenant Profile for ${u.name}`}
                          >
                              {u.tenantPhoto || u.tenantNid || u.tenantAgreement ? 'View Profile' : 'Add Profile'}
                          </Button>
                          <Button variant="danger" size="small" onClick={() => {if (confirm(`Delete unit ${u.id}?`)) deleteUnit(u.id);}} title={`Delete ${u.name}`}>Delete</Button>
                        </div>
                      </td>
                    </tr>
                  ))}
                  {units.length === 0 && (
                    <tr><td colSpan="7" className="text-center text-slate-500 py-4">No units found.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      }
      
      /* ------------- Tenant Profile Modal ------------- */
      function TenantProfileModal({ unit, onClose, updateProfile }) {
          const [profile, setProfile] = useState(unit);
          const modalRef = useRef(null);

          useEffect(() => {
            if (modalRef.current) {
              modalRef.current.focus();
              const handleKeyDown = (e) => {
                  if (e.key === 'Escape') onClose();
              };
              window.addEventListener('keydown', handleKeyDown);
              return () => window.removeEventListener('keydown', handleKeyDown);
            }
          }, [onClose]);

          const handleFileChange = (field) => (event) => {
              const file = event.target.files[0];
              if (!file) return;

              // Check file size limit (e.g., 5MB for a single file)
              if (file.size > 5 * 1024 * 1024) {
                  alert("File size exceeds 5MB limit. Please choose a smaller file.");
                  event.target.value = null; // Clear the input
                  return;
              }

              const reader = new FileReader();
              reader.onload = (e) => {
                  const base64Data = e.target.result;
                  setProfile(prev => ({ 
                      ...prev, 
                      [field]: { 
                          name: file.name, 
                          data: base64Data 
                      } 
                  }));
              };
              reader.onerror = (error) => {
                  console.error("Error reading file:", error);
                  alert("Failed to read file.");
              };
              reader.readAsDataURL(file);
          };

          const handleClearFile = (field) => () => {
              setProfile(prev => ({ 
                  ...prev, 
                  [field]: null
              }));
          };
          
          const handleDownload = (file) => {
              if (file && file.data && file.name) {
                  downloadFile(file.data, file.name);
              }
          }

          const handleSave = () => {
              updateProfile(unit.id, {
                  tenant: profile.tenant, // Allow saving name change if needed
                  tenantPhoto: profile.tenantPhoto,
                  tenantNid: profile.tenantNid,
                  tenantAgreement: profile.tenantAgreement,
              });
              alert(`Tenant profile for ${unit.name} saved successfully.`);
              onClose();
          };
          
          const FileInputBlock = ({ label, field, accept = 'image/*,application/pdf' }) => (
              <div className="space-y-1 p-2 bg-white rounded-lg border">
                  <div className="font-medium text-sm text-slate-700">{label}</div>
                  
                  {profile[field] ? (
                      <div className="flex items-center gap-2">
                          <span className="text-xs truncate font-mono bg-slate-100 px-2 py-1 rounded-md max-w-[150px]">{profile[field].name}</span>
                          <Button size="small" variant="secondary" onClick={() => handleDownload(profile[field])} title="Download File">
                              ‚¨áÔ∏è
                          </Button>
                          <Button size="small" variant="danger" onClick={handleClearFile(field)} title="Remove File">
                              ‚ùå
                          </Button>
                      </div>
                  ) : (
                      <label className="flex items-center gap-2 cursor-pointer bg-slate-100 hover:bg-slate-200 p-2 rounded-xl text-sm transition">
                          Upload File
                          <input 
                              type="file" 
                              accept={accept}
                              onChange={handleFileChange(field)} 
                              className="hidden"
                          />
                      </label>
                  )}
                  {field === 'tenantPhoto' && profile.tenantPhoto && profile.tenantPhoto.data && profile.tenantPhoto.data.startsWith('data:image') && (
                      <img 
                          src={profile.tenantPhoto.data} 
                          alt="Tenant Photo Preview" 
                          className="w-16 h-16 object-cover rounded-full border mt-2"
                      />
                  )}
                  <p className="text-xs text-slate-500 mt-1">
                      Max 5MB. Photo/PDF accepted. Stored in browser storage (exported in backup).
                  </p>
              </div>
          );

          return (
              <div 
                  ref={modalRef} 
                  role="dialog" 
                  aria-modal="true" 
                  aria-label={`Tenant Profile for ${unit.name}`}
                  tabIndex="-1"
                  className="fixed inset-0 z-50 bg-black/50 flex items-end md:items-center justify-center p-0 md:p-6"
                  onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}
              >
                  <div className="bg-slate-50 w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-xl overflow-y-auto max-h-[90vh]">
                      <div className="p-3 border-b flex items-center justify-between bg-white sticky top-0">
                          <div className="text-lg font-semibold">Tenant Profile: {unit.name}</div>
                          <Button variant="secondary" onClick={onClose} size="small">Close</Button>
                      </div>
                      
                      <div className="p-4 space-y-4">
                          <div className="bg-white p-3 rounded-xl border space-y-2">
                              <div className="font-semibold text-base">Personal Information</div>
                              <Input 
                                  label="Tenant Name" 
                                  placeholder="Tenant Name" 
                                  value={profile.tenant || ""} 
                                  onChange={(e) => setProfile(prev => ({ ...prev, tenant: e.target.value }))} 
                              />
                          </div>

                          <div className="font-semibold text-base pt-2">Tenant Documents</div>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                              <FileInputBlock label="Tenant Photo" field="tenantPhoto" accept="image/*" />
                              <FileInputBlock label="NID/ID Card" field="tenantNid" accept="image/*,application/pdf" />
                              <FileInputBlock label="Agreement Document" field="tenantAgreement" accept="application/pdf" />
                          </div>
                      </div>
                      
                      <div className="p-4 border-t bg-white sticky bottom-0">
                          <Button className="w-full" size="large" onClick={handleSave}>Save Profile</Button>
                      </div>
                  </div>
              </div>
          );
      }


      /* ------------- Payments ------------- */
      function PaymentsTable({ payments, units, onRowClick, search, month }) {
        
        const list = useMemo(() => {
            const q = search.toLowerCase();
            return payments.filter((p) => {
                const unit = units.find((u) => u.id === p.unitId);
                const blob = `${p.receiptNo} ${p.tenant} ${unit?.name} ${unit?.id} ${p.reason}`.toLowerCase();
                const okQ = !q || blob.includes(q);
                const okM = !month || p.forMonth.startsWith(month);
                return okQ && okM;
            });
        }, [payments, units, search, month]);


        return (
          <div className="overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600 sticky top-0">
                  <tr>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3">Receipt #</th>
                    <th className="p-3">Unit</th>
                    <th className="p-3 text-left">Reason</th> 
                    <th className="p-3 text-right">Amount</th>
                    <th className="p-3">For Month</th>
                    <th className="p-3">Method</th>
                  </tr>
                </thead>
                <tbody>
                  {list.map((p) => {
                    const unit = units.find((u) => u.id === p.unitId);
                    return (
                      <tr key={p.id} className="border-t hover:bg-indigo-50 cursor-pointer" onClick={() => onRowClick(p)} role="button" aria-label={`View receipt ${p.receiptNo}`}>
                        <td className="p-3">{p.date}</td>
                        <td className="p-3 text-center font-medium">{p.receiptNo}</td>
                        <td className="p-3 text-center">{unit?.name || p.unitId}</td>
                        <td className="p-3">{p.reason || "Rent"}</td> 
                        <td className="p-3 text-right font-semibold">{currency(p.amount)}</td>
                        <td className="p-3 text-center">
                          {p.reason === 'Security Deposit' ? 'N/A' : formatMonthKey(p.forMonth)} 
                        </td> 
                        <td className="p-3 text-center">{p.method}</td>
                      </tr>
                    );
                  })}
                  {list.length === 0 && (
                    <tr><td colSpan="7" className="text-center text-slate-500 py-4">No payments found with current filters.</td></tr>
                  )}
                </tbody>
              </table>
          </div>
        );
      }

      function NewReceiptForm({ units, addPayment, data }) {
        // Updated state to include default reason
        const [form, setForm] = useState({ 
            date: todayStr(), 
            method: "Cash",
            reason: "Rent",
        });
        const [formErrors, setFormErrors] = useState({});

        useEffect(() => {
          if (!form.receiptNo) setForm((f) => ({ ...f, receiptNo: nextReceiptNo(data.payments) }));
        }, [data.payments, form.receiptNo]);
        
        const nextRn = useMemo(() => nextReceiptNo(data.payments), [data.payments]);

        const resetForm = () => {
            setFormErrors({});
            setForm({ 
                date: todayStr(), 
                method: "Cash", 
                receiptNo: nextRn,
                reason: "Rent",
                unitId: "",
                tenant: "",
                amount: "",
                forMonth: "",
                notes: "",
            });
        }

        const validateForm = (currentForm) => {
            const errors = {};
            if (!currentForm.unitId) errors.unitId = "Unit is required.";
            if (!currentForm.tenant) errors.tenant = "Tenant name is required.";
            
            const reason = currentForm.reason || 'Rent';
            
            // Validation for 'For Month' based on reason
            if ((reason === 'Rent' || reason === 'Advance Rent') && !currentForm.forMonth) {
                errors.forMonth = "Billing month is required for rent or advance payments.";
            }
            
            const amount = Number(currentForm.amount);
            if (isNaN(amount) || amount <= 0) errors.amount = "Amount must be greater than zero.";
            
            setFormErrors(errors);
            return Object.keys(errors).length === 0;
        };

        const submit = () => {
          if (!validateForm(form)) return;
          
          const reason = form.reason || 'Rent';
          
          const newPayment = { 
            ...form, 
            amount: Number(form.amount || 0),
            reason: reason,
            // Clear forMonth if it's a security deposit, store as N/A to keep the field.
            forMonth: reason === 'Security Deposit' ? 'N/A' : form.forMonth, 
          };
          addPayment(newPayment);
          
          alert(`Receipt ${form.receiptNo} created successfully! ‚úÖ`);
          
          const newNextRn = nextReceiptNo([...data.payments, newPayment]);

          setForm({ 
            date: todayStr(), 
            method: form.method, 
            receiptNo: newNextRn,
            reason: form.reason,
            unitId: "",
            tenant: "",
            amount: "",
            forMonth: "",
            notes: "",
          });
        };

        const unit = units.find((u) => u.id === form.unitId);
        
        const isFormValid = useMemo(() => validateForm(form), [form]);

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-2 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="grid grid-cols-2 gap-2">
                <Select 
                    value={form.unitId || ""} 
                    onChange={(e) => {
                        const unitId = e.target.value;
                        setForm({ 
                            ...form, 
                            unitId, 
                            tenant: units.find(u => u.id === unitId)?.tenant || "" 
                        });
                        if (formErrors.unitId) validateForm({ ...form, unitId });
                    }}
                    error={formErrors.unitId}
                >
                  <option value="">Select Unit‚Ä¶</option>
                  {units.map((u) => (
                    <option key={u.id} value={u.id}>{u.name} ({u.type})</option>
                  ))}
                </Select>
                <Select 
                    value={form.reason || "Rent"}
                    onChange={(e) => {
                        // When reason changes, reset forMonth validation
                        setForm({ ...form, reason: e.target.value, forMonth: '' });
                        if (formErrors.forMonth) validateForm({ ...form, reason: e.target.value });
                    }}
                >
                    <option value="Rent">Monthly Rent</option>
                    <option value="Security Deposit">Security Deposit</option>
                    <option value="Advance Rent">Advance Rent</option>
                    <option value="Other">Other</option>
                </Select>
              </div>

              <Input 
                    placeholder="Tenant Name*" 
                    value={form.tenant || (unit?.tenant || "")} 
                    onChange={(e) => {
                        setForm({ ...form, tenant: e.target.value });
                        if (formErrors.tenant) validateForm({ ...form, tenant: e.target.value });
                    }}
                    error={formErrors.tenant}
                />
              
              <div className="grid grid-cols-2 gap-2">
                <Input 
                    type="number" 
                    placeholder="Amount (‡ß≥)*" 
                    value={form.amount ?? ""} 
                    onChange={(e) => {
                        setForm({ ...form, amount: e.target.value });
                        if (formErrors.amount) validateForm({ ...form, amount: e.target.value });
                    }}
                    error={formErrors.amount}
                />
                <Input 
                    type="month" 
                    placeholder={form.reason === 'Security Deposit' ? 'N/A' : "For Month*"} 
                    value={form.reason === 'Security Deposit' ? '' : form.forMonth || ""} 
                    onChange={(e) => {
                        setForm({ ...form, forMonth: e.target.value });
                        if (formErrors.forMonth) validateForm({ ...form, forMonth: e.target.value });
                    }}
                    error={formErrors.forMonth}
                    disabled={form.reason === 'Security Deposit'}
                    title={form.reason === 'Security Deposit' ? 'For Month is N/A for Security Deposits.' : 'Select the month this payment covers.'}
                />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <Input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} />
                <Select value={form.method} onChange={(e) => setForm({ ...form, method: e.target.value })}>
                  <option>Cash</option>
                  <option>Bank</option>
                  <option>Bkash</option>
                  <option>Nagad</option>
                  <option>Card</option>
                </Select>
              </div>
              {/* Using a textarea for better notes input */}
              <textarea 
                  placeholder="Notes (optional, supports multiple lines)" 
                  value={form.notes || ""} 
                  onChange={(e) => setForm({ ...form, notes: e.target.value })}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-indigo-400"
                  rows="3"
              />
              <div className="text-sm text-slate-500">Receipt #: <span className="font-medium text-slate-700">{form.receiptNo || "RC-YYYY-MM-0001"}</span></div>
              <div className="flex gap-2">
                <Button size="large" onClick={submit} disabled={!isFormValid}>Save Receipt</Button>
                <Button size="large" variant="secondary" onClick={resetForm}>Reset Form</Button>
              </div>
            </div>

            <div className="md:col-span-1 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Unit Details</div>
              {unit ? (
                <div className="text-sm space-y-1">
                  <div><span className="text-slate-500">Name:</span> {unit.name}</div>
                  <div><span className="text-slate-500">Type:</span> {unit.type}</div>
                  <div><span className="text-slate-500">Rent:</span> {currency(unit.rent)}</div>
                  <div><span className="text-slate-500">Tenant:</span> {unit.tenant || "‚Äî"}</div>
                </div>
              ) : (
                <div className="text-sm text-slate-500">Select a unit to preview details.</div>
              )}
            </div>
          </div>
        );
      }

      /* ------------- Expenses ------------- */
      function ExpensesSection({ expenses, addExpense }) {
        const [form, setForm] = useState({ date: todayStr() });
        const [formErrors, setFormErrors] = useState({});

        const resetForm = () => {
            setFormErrors({});
            setForm({ date: todayStr(), category: "", vendor: "", amount: "", notes: "" });
        }
        
        const validateForm = (currentForm) => {
            const errors = {};
            if (!currentForm.category) errors.category = "Category is required.";
            
            const amount = Number(currentForm.amount);
            if (isNaN(amount) || amount <= 0) errors.amount = "Amount must be greater than zero.";
            
            setFormErrors(errors);
            return Object.keys(errors).length === 0;
        };

        const submit = () => {
          if (!validateForm(form)) return;
          addExpense({ ...form, amount: Number(form.amount || 0) });
          resetForm();
        };

        const isFormValid = useMemo(() => validateForm(form), [form]);

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Add Expense</div>
              <Input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} />
              <Select 
                value={form.category || ""} 
                onChange={(e) => {
                    setForm({ ...form, category: e.target.value });
                    if (formErrors.category) validateForm({ ...form, category: e.target.value });
                }}
                error={formErrors.category}
              >
                <option value="">Select Category*</option>
                {EXPENSE_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
              </Select>
              <Input placeholder="Vendor/Payee" value={form.vendor || ""} onChange={(e) => setForm({ ...form, vendor: e.target.value })} />
              <Input 
                type="number" 
                placeholder="Amount (‡ß≥)*" 
                value={form.amount ?? ""} 
                onChange={(e) => {
                    setForm({ ...form, amount: e.target.value });
                    if (formErrors.amount) validateForm({ ...form, amount: e.target.value });
                }}
                error={formErrors.amount}
              />
              <Input placeholder="Notes" value={form.notes || ""} onChange={(e) => setForm({ ...form, notes: e.target.value })} />
              <div className="flex gap-2">
                <Button onClick={submit} disabled={!isFormValid}>Save Expense</Button>
                <Button variant="secondary" onClick={resetForm}>Reset Form</Button>
              </div>
            </div>

            <div className="md:col-span-2 overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600 sticky top-0">
                  <tr>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3 text-left">Category</th>
                    <th className="p-3 text-left">Vendor</th>
                    <th className="p-3 text-right">Amount</th>
                    <th className="p-3 text-left">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((e) => (
                    <tr key={e.id} className="border-t">
                      <td className="p-3">{e.date}</td>
                      <td className="p-3">{e.category}</td>
                      <td className="p-3">{e.vendor || "‚Äî"}</td>
                      <td className="p-3 text-right font-semibold">{currency(e.amount)}</td>
                      <td className="p-3">{e.notes || "‚Äî"}</td>
                    </tr>
                  ))}
                   {expenses.length === 0 && (
                    <tr><td colSpan="5" className="text-center text-slate-500 py-4">No expenses recorded.</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      /* ------------- Settings ------------- */
      function OrgSettings({ org, updateOrg, clearOrgFields, restoreDemoOrg, clearPayments, clearExpenses, factoryReset }) {
        return (
          <div className="grid md:grid-cols-2 gap-3 md:gap-4">
            <div className="space-y-2 bg-white border rounded-2xl p-4 shadow">
              <div className="font-semibold text-base">Organization / Landlord Info</div>
              <Input placeholder="Name" value={org.name} onChange={(e) => updateOrg({ name: e.target.value })} />
              <Input placeholder="Address" value={org.address} onChange={(e) => updateOrg({ address: e.target.value })} />
              <Input placeholder="Phone" value={org.phone} onChange={(e) => updateOrg({ phone: e.target.value })} />
              <Input placeholder="Email" value={org.email} onChange={(e) => updateOrg({ email: e.target.value })} />
              <Input placeholder="Receipt Footer Note" value={org.note} onChange={(e) => updateOrg({ note: e.target.value })} />
              <div className="flex gap-2 pt-1">
                <Button variant="secondary" size="small" onClick={clearOrgFields}>Clear Fields</Button>
                <Button variant="secondary" size="small" onClick={restoreDemoOrg}>Restore Demo</Button>
              </div>
            </div>

            <div className="space-y-3 bg-slate-50 border rounded-2xl p-4">
              <div className="font-semibold text-base">Data Management / Reset</div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                <Button variant="danger" onClick={clearPayments}>Clear ALL Payments</Button>
                <Button variant="danger" onClick={clearExpenses}>Clear ALL Expenses</Button>
                <Button variant="danger" onClick={factoryReset} className="md:col-span-2">Factory Reset (Everything)</Button>
              </div>
              <div className="text-xs text-slate-500 pt-2">
                ‚Ä¢ **Clear Payments** removes all receipts. <br/>
                ‚Ä¢ **Clear Expenses** removes all expense entries. <br/>
                ‚Ä¢ **Factory Reset** restores demo units and org, and wipes payments & expenses. Use with caution.
              </div>
            </div>
          </div>
        );
      }

      /* ------------- Receipt Modal (printable) ------------- */
      function ReceiptModal({ org, payment, unit, onClose }) {
        // Simple manual focus management for accessibility
        const modalRef = useRef(null);
        useEffect(() => {
          if (modalRef.current) {
            modalRef.current.focus();
            // Optional: add keyboard listener to close on escape key
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') onClose();
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
          }
        }, [onClose]);
        
        const printNow = () => {
          const w = window.open("", "_blank");
          const html = renderReceiptHTML(org, payment, unit);
          w.document.write(html);
          w.document.close();
          w.focus();
          setTimeout(() => {
            w.print();
            w.close();
          }, 200);
        };

        return (
          // Added role="dialog" and aria-modal for accessibility
          <div 
            ref={modalRef} 
            role="dialog" 
            aria-modal="true" 
            aria-label={`Receipt Preview for ${payment.receiptNo}`}
            tabIndex="-1"
            className="fixed inset-0 z-50 bg-black/50 flex items-end md:items-center justify-center p-0 md:p-6 print-only"
            // Click outside to close (optional, but good UX)
            onClick={(e) => { if (e.target === e.currentTarget) onClose(); }}
          >
            <div className="bg-white w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-xl">
              <div className="p-3 border-b flex items-center justify-between">
                <div className="font-semibold">Receipt Preview: {payment.receiptNo}</div>
                <div className="flex gap-2">
                  <Button variant="primary" onClick={printNow}>üñ® Print</Button>
                  <Button variant="secondary" onClick={onClose}>Close</Button>
                </div>
              </div>
              <div className="p-4 bg-slate-50 overflow-y-auto max-h-[80vh] md:max-h-[70vh]">
                <div className="bg-white border rounded-xl p-4" dangerouslySetInnerHTML={{ __html: renderReceiptInner(org, payment, unit) }} />
              </div>
            </div>
          </div>
        );
      }

      function renderReceiptInner(org, payment, unit) {
        // Convert newlines in notes to <br> for proper rendering in HTML
        const notesHtml = escapeHTML(payment.notes).replace(/\n/g, '<br/>');
        const paymentReason = escapeHTML(payment.reason || 'Rent');
        const monthDisplay = payment.reason === 'Security Deposit' ? 'N/A' : formatMonthKey(payment.forMonth);

        return `
          <div style="font-family: ui-sans-serif, system-ui; max-width: 700px; margin: 0 auto;">
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
              <div>
                <div style="font-size:20px; font-weight:700;">${escapeHTML(org.name)}</div>
                <div style="font-size:12px; color:#334155;">${escapeHTML(org.address)}</div>
                <div style="font-size:12px; color:#334155;">Phone: ${escapeHTML(org.phone)} | Email: ${escapeHTML(org.email)}</div>
              </div>
              <div style="text-align:right; font-size:12px; color:#334155;">
                <div><b>Receipt #</b>: ${escapeHTML(payment.receiptNo)}</div>
                <div><b>Date</b>: ${escapeHTML(payment.date)}</div>
              </div>
            </div>
            <hr style="margin:12px 0; border:none; border-top:1px dashed #cbd5e1;" />
            <div style="font-size:14px; margin-bottom:8px;"><b>Received with Thanks From:</b> ${escapeHTML(payment.tenant)}</div>
            <table style="width:100%; font-size:14px; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:#f1f5f9; border-bottom:2px solid #e2e8f0;">Unit</th>
                  <th style="text-align:left; padding:8px; background:#f1f5f9; border-bottom:2px solid #e2e8f0;">Reason</th> 
                  <th style="text-align:left; padding:8px; background:#f1f5f9; border-bottom:2px solid #e2e8f0;">For Month</th> 
                  <th style="text-align:center; padding:8px; background:#f1f5f9; border-bottom:2px solid #e2e8f0;">Method</th>
                  <th style="text-align:right; padding:8px; background:#f1f5f9; border-bottom:2px solid #e2e8f0;">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding:8px; border-top:1px solid #e2e8f0;">${escapeHTML(unit?.name || payment.unitId)}</td>
                  <td style="padding:8px; border-top:1px solid #e2e8f0;">${paymentReason}</td> 
                  <td style="padding:8px; border-top:1px solid #e2e8f0;">${monthDisplay}</td> 
                  <td style="padding:8px; text-align:center; border-top:1px solid #e2e8f0;">${escapeHTML(payment.method)}</td>
                  <td style="padding:8px; text-align:right; border-top:1px solid #e2e8f0;"><b>${currency(payment.amount)}</b></td>
                </tr>
              </tbody>
            </table>
            ${payment.notes ? `<div style="margin-top:8px; font-size:12px; color:#475569; line-height:1.4;"><b>Notes:</b> ${notesHtml}</div>` : ""}
            <div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
              <div style="font-size:12px; color:#334155; line-height:1.4;">${escapeHTML(org.note || "")}</div>
              <div style="text-align:center;">
                <div style="border-top:1px solid #94a3b8; padding-top:6px; font-size:12px; min-width:150px;">Authorized Signature</div>
              </div>
            </div>
          </div>
        `;
      }

      function renderReceiptHTML(org, payment, unit) {
        return `<!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>${escapeHTML(org.name)} ‚Äî Receipt ${escapeHTML(payment.receiptNo)}</title>
          <style>
            @media print {
              @page { size: A5; margin: 10mm; } 
            }
            body { 
              font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
              background:#ffffff; 
              margin:0; 
              padding:0; 
            }
            .sheet { 
              background:white; 
              padding:16px; 
              border:1px solid #e2e8f0; 
              max-width: 600px;
              margin: 20px auto;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }
          </style>
        </head>
        <body>
          <div class="sheet print-only">${renderReceiptInner(org, payment, unit)}</div>
        </body>
        </html>`;
      }

      function escapeHTML(str) {
        return String(str || "").replace(/[&<>'"]/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;"}[c]));
      }

      /* ------------- Mount app ------------- */
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
