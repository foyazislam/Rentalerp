<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB21YCBgR4qJgRRunwWPx3tUeELvFegxnE",
    authDomain: "rentalerp-abe70.firebaseapp.com",
    projectId: "rentalerp-abe70",
    storageBucket: "rentalerp-abe70.firebasestorage.app",
    messagingSenderId: "400286046254",
    appId: "1:400286046254:web:50a278b1c0d97246b2a7bf"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile ERP ‚Äî Cloud Sync with Authentication</title>
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React 18 (UMD) + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for in-browser JSX transform (fine for small apps) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- NEW: Firebase SDKs for Cloud Firestore and Authentication -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <style>
      html, body { height: 100%; background: #f1f5f9; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useEffect, useMemo, useRef, useState } = React;

      /* ------------- Firebase Setup (Using Canvas Globals) ------------- */
      // Global variables provided by the Canvas environment
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

      let app, db, auth;
      if (firebaseConfig) {
        // Initialize Firebase app
        if (!firebase.apps.length) {
            app = firebase.initializeApp(firebaseConfig);
        } else {
            app = firebase.app();
        }
        // Get service instances
        db = app.firestore();
        auth = app.auth();
        // Enable verbose logging for debugging
        // FIX: db.setLogLevel is not a function in the compat SDK. Use firebase.firestore.setLogLevel instead.
        firebase.firestore.setLogLevel('debug'); 
      }

      // Function to get the correct user-scoped document reference
      const getUserDocRef = (userId) => {
        if (!db || !userId) return null;
        // Path MUST be /artifacts/{appId}/users/{userId}/erp_data/main_rental_data
        return db.collection("artifacts").doc(appId)
            .collection("users").doc(userId)
            .collection("erp_data").doc("main_rental_data");
      };

      /* ------------- Utilities ------------- */
      const todayStr = () => new Date().toISOString().slice(0, 10);

      const currency = (n) => {
        const num = Number(n || 0);
        try {
          return num
            .toLocaleString(undefined, { style: "currency", currency: "BDT" })
            .replace("BDT", "‡ß≥")
            .trim();
        } catch {
          return `‡ß≥${num.toLocaleString()}`;
        }
      };

      const monthKey = (dateStr) => {
        const d = new Date(dateStr);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}`; // YYYY-MM
      };

      const nextReceiptNo = (allPayments) => {
        const yyyymm = monthKey(new Date().toISOString());
        const prefix = `RC-${yyyymm}-`;
        const count = allPayments.filter((p) => (p.receiptNo || "").startsWith(prefix)).length + 1;
        return `${prefix}${String(count).padStart(4, "0")}`;
      };

      const download = (filename, text) => {
        const blob = new Blob([text], { type: "application/json;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const classNames = (...c) => c.filter(Boolean).join(" ");

      if (!(window.crypto && window.crypto.randomUUID)) {
        window.crypto = window.crypto || {};
        window.crypto.randomUUID = function () {
          return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = (Math.random() * 16) | 0;
            const v = c === 'x' ? r : (r & 0x3) | 0x8;
            return v.toString(16);
          });
        };
      }

      /* ------------- Demo initial data (unchanged) ------------- */
      const initialData = {
        org: {
          name: "Foyaz Properties",
          address: "123 Example Road, Dhaka",
          phone: "+8801XXXXXXXXX",
          email: "owner@example.com",
          note: "Thank you for your payment!",
        },
        units: [
          ...Array.from({ length: 10 }).map((_, i) => ({
            id: `F${i + 1}`,
            type: "Flat",
            name: `Flat ${i + 1}`,
            floor: Math.ceil((i + 1) / 2),
            rent: 15000,
            dueDay: 5,
            tenant: "Demo Tenant",
          })),
        ],
        payments: [], 
        expenses: [], 
      };

      /* ------------- Cloud Storage Functions (UPDATED FOR AUTH) ------------- */

      const loadData = async (userId) => {
        const docRef = getUserDocRef(userId);
        if (!docRef) {
             console.error("Firestore not initialized or userId missing.");
             return initialData;
        }

        try {
          const doc = await docRef.get();

          if (doc.exists) {
            console.log("Data loaded from user cloud storage.");
            return { ...initialData, ...doc.data() };
          }

          console.log("No user cloud data found. Saving initial demo data.");
          // Initial save of demo data to the cloud
          await saveData(initialData, userId);
          return initialData;

        } catch (e) {
          console.error("Cloud Load error. Returning initial data.", e);
          return initialData;
        }
      };

      const saveData = async (data, userId) => {
        const docRef = getUserDocRef(userId);
        if (!docRef) {
             console.error("Firestore not initialized or userId missing. Cannot save.");
             return;
        }

        try {
          // Only save the user-mutable parts of the data object
          const dataToSave = {
            org: data.org,
            units: data.units,
            payments: data.payments,
            expenses: data.expenses,
          };
          await docRef.set(dataToSave);
          console.log("Data saved to user cloud successfully.");

        } catch (e) {
          console.error("Cloud Save error.", e);
          alert("Warning: Data failed to save to the cloud. Check your connection or Firebase rules.");
        }
      };
      
      /* ------------- NEW: Sign In Component ------------- */

      function SignInPage({ auth, onAuthSuccess }) {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [mode, setMode] = useState("login"); // 'login' or 'signup'
        const [error, setError] = useState("");
        const [isLoading, setIsLoading] = useState(false);

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError("");
          setIsLoading(true);

          try {
            if (mode === 'login') {
              await auth.signInWithEmailAndPassword(email, password);
              // onAuthStateChanged listener in App handles navigation
            } else {
              await auth.createUserWithEmailAndPassword(email, password);
              // onAuthStateChanged listener in App handles navigation
            }
          } catch (err) {
            console.error(err);
            setError(err.message || "An unknown error occurred during authentication.");
          } finally {
            setIsLoading(false);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
            <div className="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl space-y-6">
              <h1 className="text-3xl font-bold text-center text-indigo-700">Mobile ERP Login</h1>
              <p className="text-center text-slate-500">
                {mode === 'login' ? 'Sign in to access your data.' : 'Create a new account.'}
              </p>

              <form onSubmit={handleSubmit} className="space-y-4">
                <Input
                  type="email"
                  placeholder="Email Address"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                />
                <Input
                  type="password"
                  placeholder="Password (min 6 characters)"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                />

                {error && <div className="text-sm text-rose-600 bg-rose-50 p-3 rounded-xl border border-rose-200">{error}</div>}

                <Button type="submit" className="w-full text-lg" disabled={isLoading}>
                  {isLoading ? 'Processing...' : (mode === 'login' ? 'Log In' : 'Sign Up')}
                </Button>
              </form>

              <div className="flex justify-center text-sm">
                <Button variant="ghost" onClick={() => setMode(mode === 'login' ? 'signup' : 'login')}>
                  {mode === 'login'
                    ? "Need an account? Sign Up"
                    : "Already have an account? Log In"}
                </Button>
              </div>
            </div>
          </div>
        );
      }


      /* ------------- Small UI primitives (unchanged) ------------- */
      const Section = ({ title, right, children }) => (
        <div className="bg-white rounded-2xl shadow p-4 md:p-6">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg md:text-xl font-semibold">{title}</h2>
            {right}
          </div>
          {children}
        </div>
      );

      const Input = (props) => (
        <input
          {...props}
          className={classNames(
            "w-full rounded-xl border px-3 py-2 text-sm md:text-base",
            "focus:outline-none focus:ring-2 focus:ring-indigo-400",
            props.className
          )}
        />
      );

      const Select = (props) => (
        <select
          {...props}
          className={classNames(
            "w-full rounded-xl border px-3 py-2 text-sm md:text-base bg-white",
            "focus:outline-none focus:ring-2 focus:ring-indigo-400",
            props.className
          )}
        />
      );

      const Button = ({ children, variant = "primary", className, ...rest }) => {
        const styles = {
          primary: "bg-indigo-600 text-white hover:bg-indigo-700",
          secondary: "bg-slate-100 hover:bg-slate-200 text-slate-700",
          danger: "bg-rose-600 text-white hover:bg-rose-700",
          ghost: "bg-transparent text-indigo-600 hover:bg-indigo-50",
        };
        return (
          <button
            {...rest}
            className={classNames(
              "rounded-xl px-4 py-2 text-sm md:text-base transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed",
              styles[variant],
              className
            )}
          >
            {children}
          </button>
        );
      };
      
      /* ------------- Main App (UPDATED) ------------- */
      function App() {
        // Auth State
        const [user, setUser] = useState(null); // Firebase User object
        const [loadingAuth, setLoadingAuth] = useState(true);

        // App Data State (only loaded when user is active)
        const [data, setData] = useState(null); 
        const [loadingData, setLoadingData] = useState(false);
        const [tab, setTab] = useState("dashboard");
        const [search, setSearch] = useState("");
        const [showReceipt, setShowReceipt] = useState(null); 

        // 1. Authentication Listener (runs once on mount)
        useEffect(() => {
            if (!auth) {
                console.error("Firebase Auth not initialized.");
                setLoadingAuth(false);
                return;
            }

            // 1a. Handle Canvas initial auth token
            if (initialAuthToken && loadingAuth) {
                 auth.signInWithCustomToken(initialAuthToken)
                    .then(() => console.log("Signed in with Canvas custom token."))
                    .catch((error) => console.error("Custom token sign-in failed:", error))
                    .finally(() => setLoadingAuth(false));
            } else {
                 setLoadingAuth(false);
            }

            // 1b. Listen for auth changes
            const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                setUser(currentUser);
                setLoadingAuth(false); 
                // When a user logs out, clear the app data
                if (!currentUser) {
                    setData(null);
                }
            });

            return () => unsubscribe();
        }, []);


        // 2. Data Fetcher (runs when user changes)
        useEffect(() => {
            if (user) {
                setLoadingData(true);
                // Load data specific to the current user's UID
                loadData(user.uid).then(initialData => {
                    setData(initialData);
                    setLoadingData(false);
                }).catch(e => {
                    console.error("Data load failed after login:", e);
                    setData(initialData); // Fallback to demo data structure
                    setLoadingData(false);
                });
            }
        }, [user]);


        // 3. Data Persistence (Debounced Cloud Save)
        const saveTimeout = useRef(null);
        useEffect(() => {
          if (!data || !user || loadingData) return; // Do not save if data not ready or user is missing

          if (saveTimeout.current) {
            clearTimeout(saveTimeout.current);
          }

          saveTimeout.current = setTimeout(() => {
            saveData(data, user.uid);
          }, 500); 

          return () => {
            if (saveTimeout.current) {
              clearTimeout(saveTimeout.current);
            }
          };
        }, [data, user, loadingData]);

        
        const isLoading = loadingAuth || loadingData || !data;
        const isAuthenticated = !!user && !!data;


        // Render Sign In Page or Loading Screen
        if (loadingAuth) {
            return (
              <div className="min-h-screen flex flex-col items-center justify-center p-8 text-center bg-slate-50">
                <div className="h-12 w-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                <div className="text-xl font-semibold text-indigo-600 mt-4">Initializing Application...</div>
                <div className="text-sm text-slate-500 mt-2">Checking user session.</div>
              </div>
            );
        }

        if (!isAuthenticated) {
            return <SignInPage auth={auth} />;
        }


        // --- Main ERP Content ---
        const units = data.units;
        const payments = data.payments;
        const expenses = data.expenses;

        // Data helpers
        const updateOrg = (patch) => setData((d) => ({ ...d, org: { ...d.org, ...patch } }));
        const upsertUnit = (unit) =>
          setData((d) => ({
            ...d,
            units: d.units.some((x) => x.id === unit.id)
              ? d.units.map((x) => (x.id === unit.id ? { ...x, ...unit } : x))
              : [...d.units, unit],
          }));

        const deleteUnit = (id) => setData((d) => ({ ...d, units: d.units.filter((u) => u.id !== id) }));
        const addPayment = (p) =>
          setData((d) => ({ ...d, payments: [{ ...p, id: crypto.randomUUID() }, ...d.payments] }));
        const addExpense = (e) =>
          setData((d) => ({ ...d, expenses: [{ ...e, id: crypto.randomUUID() }, ...d.expenses] }));

        const totals = useMemo(() => { /* ... (unchanged logic) ... */
          const income = payments.reduce((s, p) => s + Number(p.amount || 0), 0);
          const expense = expenses.reduce((s, e) => s + Number(e.amount || 0), 0);
          return { income, expense, net: income - expense };
        }, [payments, expenses]);

        const outstandingByUnit = useMemo(() => { /* ... (unchanged logic) ... */
          const now = new Date();
          const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}`;
          const map = Object.fromEntries(units.map((u) => [u.id, u.rent || 0]));
          payments
            .filter((p) => (p.forMonth || "").startsWith(ym))
            .forEach((p) => {
              map[p.unitId] = (map[p.unitId] || 0) - Number(p.amount || 0);
            });
          return map; 
        }, [units, payments]);

        const filteredUnits = useMemo(() => { /* ... (unchanged logic) ... */
          if (!search) return units;
          const q = search.toLowerCase();
          return units.filter(
            (u) =>
              u.id.toLowerCase().includes(q) ||
              u.name.toLowerCase().includes(q) ||
              (u.tenant || "").toLowerCase().includes(q) ||
              (u.type || "").toLowerCase().includes(q)
          );
        }, [units, search]);


        const exportData = () => download(`rental-erp-backup-${todayStr()}.json`, JSON.stringify(data, null, 2));
        const importData = (file) => {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try {
              const parsed = JSON.parse(evt.target.result);
              setData(parsed);
              alert("Import successful ‚úÖ");
            } catch (e) {
              alert("Import failed: invalid JSON");
            }
          };
          reader.readAsText(file);
        };

        // Reset / data management actions for Settings
        const clearOrgFields = () =>
          setData((d) => ({ ...d, org: { name: "", address: "", phone: "", email: "", note: "" } }));

        const restoreDemoOrg = () =>
          setData((d) => ({ ...d, org: { ...initialData.org } }));

        const clearPayments = () =>
          setData((d) => ({ ...d, payments: [] }));

        const clearExpenses = () =>
          setData((d) => ({ ...d, expenses: [] }));

        const factoryReset = () => {
          setData({ ...initialData });
        };

        const handleLogout = () => {
            auth.signOut().catch(e => console.error("Logout failed", e));
        };

        return (
          <div className="min-h-screen bg-slate-50 text-slate-800">
            {loadingData && (
              <div className="fixed inset-0 bg-white/70 z-50 flex flex-col items-center justify-center p-8 text-center">
                <div className="h-12 w-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                <div className="text-xl font-semibold text-indigo-600 mt-4">Loading Data...</div>
                <div className="text-sm text-slate-500 mt-2">Fetching data for User: {user.uid}</div>
              </div>
            )}
            <header className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b">
              <div className="mx-auto max-w-6xl px-4 py-3 flex items-center gap-2">
                <div className="text-xl md:text-2xl font-bold">üè¢ {data.org.name}</div>
                <div className="ml-auto flex items-center gap-2">
                  <Button variant="secondary" onClick={handleLogout}>Log Out</Button>
                  <Button variant="secondary" onClick={exportData}>‚§ì Export</Button>
                  <label className="cursor-pointer">
                    <span className="inline-block bg-slate-100 hover:bg-slate-200 rounded-xl px-4 py-2 text-sm">Import</span>
                    <input className="hidden" type="file" accept="application/json" onChange={(e) => e.target.files?.[0] && importData(e.target.files[0])} />
                  </label>
                </div>
              </div>
              <nav className="mx-auto max-w-6xl px-2 pb-3">
                <div className="grid grid-cols-2 md:grid-cols-6 gap-2">
                  {[
                    ["dashboard", "Dashboard"],
                    ["units", "Units"],
                    ["payments", "Payments"],
                    ["newReceipt", "New Receipt"],
                    ["expenses", "Expenses"],
                    ["settings", "Settings"],
                  ].map(([key, label]) => (
                    <Button
                      key={key}
                      variant={tab === key ? "primary" : "secondary"}
                      className="w-full"
                      onClick={() => setTab(key)}
                      disabled={isLoading}
                    >
                      {label}
                    </Button>
                  ))}
                </div>
              </nav>
            </header>

            <main className="mx-auto max-w-6xl p-4 space-y-4 md:space-y-6">
              {tab === "dashboard" && (
                <DashboardSection totals={totals} units={units} outstandingByUnit={outstandingByUnit} setTab={setTab} />
              )}

              {tab === "units" && (
                <Section
                  title="Units (Flats & Shops)"
                  right={<Input placeholder="Search units/tenant‚Ä¶" value={search} onChange={(e) => setSearch(e.target.value)} />}
                >
                  <UnitsTable units={filteredUnits} upsertUnit={upsertUnit} deleteUnit={deleteUnit} />
                </Section>
              )}

              {tab === "payments" && (
                <Section title="Payments (tap a row for receipt)">
                  <PaymentsTable payments={payments} units={units} onRowClick={setShowReceipt} />
                </Section>
              )}

              {tab === "newReceipt" && (
                <Section title="Create Money Receipt">
                  <NewReceiptForm units={units} addPayment={addPayment} data={data} />
                </Section>
              )}

              {tab === "expenses" && (
                <Section title="Expenses">
                  <ExpensesSection expenses={expenses} addExpense={addExpense} />
                </Section>
              )}

              {tab === "settings" && (
                <Section title="Organization Settings">
                  <OrgSettings
                    org={data.org}
                    updateOrg={updateOrg}
                    clearOrgFields={clearOrgFields}
                    restoreDemoOrg={restoreDemoOrg}
                    clearPayments={() => { if (confirm("Clear ALL payments? This will remove every receipt.")) clearPayments(); }}
                    clearExpenses={() => { if (confirm("Clear ALL expenses?")) clearExpenses(); }}
                    factoryReset={() => { if (confirm("Factory Reset EVERYTHING? Units, payments, expenses and org will reset to demo.")) factoryReset(); }}
                  />
                </Section>
              )}
            </main>

            {showReceipt && (
              <ReceiptModal
                org={data.org}
                payment={showReceipt}
                unit={units.find((u) => u.id === showReceipt.unitId)}
                onClose={() => setShowReceipt(null)}
              />
            )}
          </div>
        );
      }
      
      /* --- All other components (DashboardSection, StatCard, UnitsTable, PaymentsTable, NewReceiptForm, ExpensesSection, OrgSettings, ReceiptModal, renderReceiptInner, renderReceiptHTML, escapeHTML) go here, unchanged from the previous version. --- */
      // Due to space limitations, the auxiliary components are not repeated but should be included in the final file.
      // Copy and paste them from the previous version below this line.

      /* ------------- Dashboard (unchanged) ------------- */
      function DashboardSection({ totals, units, outstandingByUnit, setTab }) {
        const totalDue = Object.values(outstandingByUnit).reduce((s, v) => s + Math.max(0, v), 0);

        return (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
            <StatCard label="Income" value={currency(totals.income)} />
            <StatCard label="Expenses" value={currency(totals.expense)} />
            <StatCard label="Net" value={currency(totals.net)} />
            <StatCard label="This Month Due" value={currency(totalDue)} />

            <div className="col-span-2 md:col-span-4">
              <Section title="Quick Actions" right={<div />}> 
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <Button className="w-full" onClick={() => setTab("newReceipt")}>New Receipt</Button>
                  <Button variant="secondary" className="w-full" onClick={() => setTab("payments")}>View Payments</Button>
                  <Button variant="secondary" className="w-full" onClick={() => setTab("units")}>Manage Units</Button>
                  <Button variant="secondary" className="w-full" onClick={() => setTab("expenses")}>Add Expense</Button>
                </div>
              </Section>
            </div>

            <div className="col-span-2 md:col-span-4">
              <Section title="Current Month Dues by Unit">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                  {units.map((u) => (
                    <div key={u.id} className="flex items-center justify-between rounded-xl border p-3">
                      <div>
                        <div className="font-medium">{u.name} <span className="text-xs text-slate-500">({u.type})</span></div>
                        <div className="text-xs text-slate-500">Tenant: {u.tenant || "‚Äî"}</div>
                      </div>
                      <div className={classNames("text-right font-semibold", (outstandingByUnit[u.id] || 0) > 0 ? "text-rose-600" : "text-emerald-600")}>{currency(Math.max(0, outstandingByUnit[u.id] || 0))}</div>
                    </div>
                  ))}
                </div>
              </Section>
            </div>
          </div>
        );
      }

      function StatCard({ label, value }) {
        return (
          <div className="bg-white rounded-2xl shadow p-4">
            <div className="text-xs uppercase tracking-wide text-slate-500">{label}</div>
            <div className="text-xl md:text-2xl font-semibold mt-1">{value}</div>
          </div>
        );
      }

      /* ------------- Units (unchanged) ------------- */
      function UnitsTable({ units, upsertUnit, deleteUnit }) {
        const [form, setForm] = useState({ type: "Flat", rent: 15000, dueDay: 5 });

        const edit = (u) => setForm({ ...u });
        const reset = () => setForm({ type: "Flat", rent: 15000, dueDay: 5 });

        const submit = () => {
          if (!form.id || !form.name) return alert("Please fill ID and Name");
          upsertUnit({ ...form, rent: Number(form.rent || 0), dueDay: Number(form.dueDay || 1) });
          reset();
        };

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Add / Edit Unit</div>
              <div className="grid gap-2">
                <div className="grid grid-cols-2 gap-2">
                  <Input placeholder="Unit ID (e.g., F1)" value={form.id || ""} onChange={(e) => setForm({ ...form, id: e.target.value })} />
                  <Select value={form.type} onChange={(e) => setForm({ ...form, type: e.target.value })}>
                    <option>Flat</option>
                    <option>Shop</option>
                  </Select>
                </div>
                <Input placeholder="Name" value={form.name || ""} onChange={(e) => setForm({ ...form, name: e.target.value })} />
                <Input type="number" placeholder="Floor" value={form.floor ?? ""} onChange={(e) => setForm({ ...form, floor: Number(e.target.value) })} />
                <Input type="number" placeholder="Monthly Rent" value={form.rent ?? ""} onChange={(e) => setForm({ ...form, rent: e.target.value })} />
                <Input type="number" placeholder="Due Day (1-28)" value={form.dueDay ?? ""} onChange={(e) => setForm({ ...form, dueDay: e.target.value })} />
                <Input placeholder="Tenant Name" value={form.tenant || ""} onChange={(e) => setForm({ ...form, tenant: e.target.value })} />
              </div>
              <div className="flex gap-2 mt-2">
                <Button onClick={submit}>Save</Button>
                <Button variant="secondary" onClick={reset}>Clear</Button>
              </div>
            </div>

            <div className="md:col-span-2 overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600">
                  <tr>
                    <th className="p-3 text-left">ID</th>
                    <th className="p-3 text-left">Name</th>
                    <th className="p-3">Type</th>
                    <th className="p-3 text-right">Rent</th>
                    <th className="p-3">Due Day</th>
                    <th className="p-3">Tenant</th>
                    <th className="p-3">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {units.map((u) => (
                    <tr key={u.id} className="border-t">
                      <td className="p-3">{u.id}</td>
                      <td className="p-3">{u.name}</td>
                      <td className="p-3 text-center">{u.type}</td>
                      <td className="p-3 text-right">{currency(u.rent)}</td>
                      <td className="p-3 text-center">{u.dueDay}</td>
                      <td className="p-3">{u.tenant || "‚Äî"}</td>
                      <td className="p-3">
                        <div className="flex gap-2">
                          <Button variant="secondary" onClick={() => edit(u)}>Edit</Button>
                          <Button variant="danger" onClick={() => { if (confirm(`Are you sure you want to delete unit ${u.name}?`)) deleteUnit(u.id); }}>Delete</Button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      /* ------------- Payments (unchanged) ------------- */
      function PaymentsTable({ payments, units, onRowClick }) {
        const [q, setQ] = useState("");
        const [month, setMonth] = useState("");

        const list = payments.filter((p) => {
          const unit = units.find((u) => u.id === p.unitId);
          const blob = `${p.receiptNo} ${p.tenant} ${unit?.name} ${unit?.id}`.toLowerCase();
          const okQ = !q || blob.includes(q.toLowerCase());
          const okM = !month || p.forMonth.startsWith(month);
          return okQ && okM;
        });

        return (
          <div className="space-y-3">
            <div className="grid grid-cols-2 md:grid-cols-5 gap-2 items-start">
              <Input placeholder="Search receipt/tenant/unit‚Ä¶" value={q} onChange={(e) => setQ(e.target.value)} />
              <Input type="month" value={month} onChange={(e) => setMonth(e.target.value)} />
              <div className="md:col-span-3 flex gap-2">
                <Button variant="secondary" onClick={() => { setQ(""); setMonth(""); }}>Reset Filters</Button>
              </div>
            </div>
            <div className="overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600">
                  <tr>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3">Receipt #</th>
                    <th className="p-3">Unit</th>
                    <th className="p-3 text-left">Tenant</th>
                    <th className="p-3 text-right">Amount</th>
                    <th className="p-3">For Month</th>
                    <th className="p-3">Method</th>
                  </tr>
                </thead>
                <tbody>
                  {list.map((p) => {
                    const unit = units.find((u) => u.id === p.unitId);
                    return (
                      <tr key={p.id} className="border-t hover:bg-indigo-50 cursor-pointer" onClick={() => onRowClick(p)}>
                        <td className="p-3">{p.date}</td>
                        <td className="p-3 text-center font-medium">{p.receiptNo}</td>
                        <td className="p-3 text-center">{unit?.name || p.unitId}</td>
                        <td className="p-3">{p.tenant}</td>
                        <td className="p-3 text-right font-semibold">{currency(p.amount)}</td>
                        <td className="p-3 text-center">{p.forMonth}</td>
                        <td className="p-3 text-center">{p.method}</td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      function NewReceiptForm({ units, addPayment, data }) {
        const [form, setForm] = useState({ date: todayStr(), method: "Cash" });

        useEffect(() => {
          if (!form.receiptNo) setForm((f) => ({ ...f, receiptNo: nextReceiptNo(data.payments) }));
        }, []);

        const resetForm = () =>
          setForm({ date: todayStr(), method: "Cash", receiptNo: nextReceiptNo(data.payments) });

        const submit = () => {
          if (!form.unitId || !form.tenant || !form.amount || !form.forMonth) {
            return alert("Please fill Unit, Tenant, Amount and For Month.");
          }
          addPayment({ ...form, amount: Number(form.amount || 0) });
          alert(`Receipt ${form.receiptNo} created ‚úÖ`);
          setForm({ date: todayStr(), method: form.method, receiptNo: nextReceiptNo([...data.payments, form]) });
        };

        const unit = units.find((u) => u.id === form.unitId);

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-2 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="grid grid-cols-2 gap-2">
                <Select value={form.unitId || ""} onChange={(e) => setForm({ ...form, unitId: e.target.value })}>
                  <option value="">Select Unit‚Ä¶</option>
                  {units.map((u) => (
                    <option key={u.id} value={u.id}>{u.name} ({u.type})</option>
                  ))}
                </Select>
                <Input placeholder="Tenant Name" value={form.tenant || (unit?.tenant || "")} onChange={(e) => setForm({ ...form, tenant: e.target.value })} />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <Input type="number" placeholder="Amount (‡ß≥)" value={form.amount ?? ""} onChange={(e) => setForm({ ...form, amount: e.target.value })} />
                <Input type="month" placeholder="For Month" value={form.forMonth || ""} onChange={(e) => setForm({ ...form, forMonth: e.target.value })} />
              </div>
              <div className="grid grid-cols-2 gap-2">
                <Input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} />
                <Select value={form.method} onChange={(e) => setForm({ ...form, method: e.target.value })}>
                  <option>Cash</option>
                  <option>Bank</option>
                  <option>Bkash</option>
                  <option>Nagad</option>
                  <option>Card</option>
                </Select>
              </div>
              <Input placeholder="Notes (optional)" value={form.notes || ""} onChange={(e) => setForm({ ...form, notes: e.target.value })} />
              <div className="text-xs text-slate-500">Auto Receipt #: <span className="font-medium text-slate-700">{form.receiptNo || "(will generate)"}</span></div>
              <div className="flex gap-2">
                <Button onClick={submit}>Save Receipt</Button>
                <Button variant="secondary" onClick={resetForm}>Reset Form</Button>
                <Button variant="secondary" onClick={() => window.scrollTo({ top: 0, behavior: "smooth" })}>Back to Top</Button>
              </div>
            </div>

            <div className="md:col-span-1 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Unit Details</div>
              {unit ? (
                <div className="text-sm space-y-1">
                  <div><span className="text-slate-500">Name:</span> {unit.name}</div>
                  <div><span className="text-slate-500">Type:</span> {unit.type}</div>
                  <div><span className="text-slate-500">Rent:</span> {currency(unit.rent)}</div>
                  <div><span className="text-slate-500">Tenant:</span> {unit.tenant || "‚Äî"}</div>
                </div>
              ) : (
                <div className="text-sm text-slate-500">Select a unit to preview details.</div>
              )}
            </div>
          </div>
        );
      }

      /* ------------- Expenses (unchanged) ------------- */
      function ExpensesSection({ expenses, addExpense }) {
        const [form, setForm] = useState({ date: todayStr() });

        const resetForm = () => setForm({ date: todayStr() });

        const submit = () => {
          if (!form.category || !form.amount) return alert("Fill Category and Amount");
          addExpense({ ...form, amount: Number(form.amount || 0) });
          resetForm();
        };

        return (
          <div className="grid md:grid-cols-3 gap-3 md:gap-4">
            <div className="md:col-span-1 bg-slate-50 border rounded-2xl p-3 space-y-2">
              <div className="font-semibold">Add Expense</div>
              <Input type="date" value={form.date} onChange={(e) => setForm({ ...form, date: e.target.value })} />
              <Input placeholder="Category (e.g., Maintenance)" value={form.category || ""} onChange={(e) => setForm({ ...form, category: e.target.value })} />
              <Input placeholder="Vendor/Payee" value={form.vendor || ""} onChange={(e) => setForm({ ...form, vendor: e.target.value })} />
              <Input type="number" placeholder="Amount (‡ß≥)" value={form.amount ?? ""} onChange={(e) => setForm({ ...form, amount: e.target.value })} />
              <Input placeholder="Notes" value={form.notes || ""} onChange={(e) => setForm({ ...form, notes: e.target.value })} />
              <div className="flex gap-2">
                <Button onClick={submit}>Save Expense</Button>
                <Button variant="secondary" onClick={resetForm}>Reset Form</Button>
              </div>
            </div>

            <div className="md:col-span-2 overflow-auto rounded-2xl border">
              <table className="min-w-full text-sm">
                <thead className="bg-slate-100 text-slate-600">
                  <tr>
                    <th className="p-3 text-left">Date</th>
                    <th className="p-3 text-left">Category</th>
                    <th className="p-3 text-left">Vendor</th>
                    <th className="p-3 text-right">Amount</th>
                    <th className="p-3 text-left">Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((e) => (
                    <tr key={e.id} className="border-t">
                      <td className="p-3">{e.date}</td>
                      <td className="p-3">{e.category}</td>
                      <td className="p-3">{e.vendor || "‚Äî"}</td>
                      <td className="p-3 text-right">{currency(e.amount)}</td>
                      <td className="p-3">{e.notes || ""}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      /* ------------- Settings (unchanged) ------------- */
      function OrgSettings({ org, updateOrg, clearOrgFields, restoreDemoOrg, clearPayments, clearExpenses, factoryReset }) {
        return (
          <div className="grid md:grid-cols-2 gap-3 md:gap-4">
            <div className="space-y-2">
              <div className="text-sm text-slate-500">Organization / Landlord Info</div>
              <Input placeholder="Name" value={org.name} onChange={(e) => updateOrg({ name: e.target.value })} />
              <Input placeholder="Address" value={org.address} onChange={(e) => updateOrg({ address: e.target.value })} />
              <Input placeholder="Phone" value={org.phone} onChange={(e) => updateOrg({ phone: e.target.value })} />
              <Input placeholder="Email" value={org.email} onChange={(e) => updateOrg({ email: e.target.value })} />
              <Input placeholder="Receipt Footer Note" value={org.note} onChange={(e) => updateOrg({ note: e.target.value })} />
              <div className="flex gap-2 pt-1">
                <Button variant="secondary" onClick={clearOrgFields}>Reset Org Fields</Button>
                <Button variant="secondary" onClick={restoreDemoOrg}>Restore Demo Org</Button>
              </div>
            </div>

            <div className="space-y-3 bg-slate-50 border rounded-2xl p-3">
              <div className="text-sm text-slate-500">Data Management / Reset</div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                <Button variant="danger" onClick={clearPayments}>Clear ALL Payments</Button>
                <Button variant="danger" onClick={clearExpenses}>Clear ALL Expenses</Button>
                <Button variant="danger" onClick={factoryReset}>Factory Reset (Everything)</Button>
              </div>
              <div className="text-xs text-slate-500">
                ‚Ä¢ Clearing payments removes all receipts. <br/>
                ‚Ä¢ Clearing expenses removes all expense entries. <br/>
                ‚Ä¢ Factory reset restores demo units and org, and wipes payments & expenses.
              </div>
            </div>
          </div>
        );
      }

      /* ------------- Receipt Modal (printable) (unchanged) ------------- */
      function ReceiptModal({ org, payment, unit, onClose }) {
        const ref = useRef();

        const printNow = () => {
          const w = window.open("", "_blank");
          const html = renderReceiptHTML(org, payment, unit);
          w.document.write(html);
          w.document.close();
          w.focus();
          w.print();
        };

        return (
          <div className="fixed inset-0 z-50 bg-black/50 flex items-end md:items-center justify-center p-0 md:p-6">
            <div ref={ref} className="bg-white w-full md:max-w-2xl rounded-t-2xl md:rounded-2xl shadow-xl">
              <div className="p-3 border-b flex items-center justify-between">
                <div className="font-semibold">Receipt Preview</div>
                <div className="flex gap-2">
                  <Button variant="secondary" onClick={printNow}>Print</Button>
                  <Button variant="danger" onClick={onClose}>Close</Button>
                </div>
              </div>
              <div className="p-4 bg-slate-50">
                <div className="bg-white border rounded-xl p-4" dangerouslySetInnerHTML={{ __html: renderReceiptInner(org, payment, unit) }} />
              </div>
            </div>
          </div>
        );
      }

      function renderReceiptInner(org, payment, unit) {
        return `
          <div style="font-family: ui-sans-serif, system-ui; max-width: 700px; margin: 0 auto;">
            <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
              <div>
                <div style="font-size:20px; font-weight:700;">${escapeHTML(org.name)}</div>
                <div style="font-size:12px; color:#334155;">${escapeHTML(org.address)}</div>
                <div style="font-size:12px; color:#334155;">Phone: ${escapeHTML(org.phone)} | Email: ${escapeHTML(org.email)}</div>
              </div>
              <div style="text-align:right; font-size:12px; color:#334155;">
                <div><b>Receipt #</b>: ${escapeHTML(payment.receiptNo)}</div>
                <div><b>Date</b>: ${escapeHTML(payment.date)}</div>
              </div>
            </div>
            <hr style="margin:12px 0; border:none; border-top:1px dashed #cbd5e1;" />
            <div style="font-size:14px; margin-bottom:8px;"><b>Received From:</b> ${escapeHTML(payment.tenant)}</div>
            <table style="width:100%; font-size:14px; border-collapse:collapse;">
              <thead>
                <tr>
                  <th style="text-align:left; padding:8px; background:#f1f5f9;">Unit</th>
                  <th style="text-align:left; padding:8px; background:#f1f5f9;">For Month</th>
                  <th style="text-align:center; padding:8px; background:#f1f5f9;">Method</th>
                  <th style="text-align:right; padding:8px; background:#f1f5f9;">Amount</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="padding:8px; border-top:1px solid #e2e8f0;">${escapeHTML(unit?.name || payment.unitId)}</td>
                  <td style="padding:8px; border-top:1px solid #e2e8f0;">${escapeHTML(payment.forMonth)}</td>
                  <td style="padding:8px; text-align:center; border-top:1px solid #e2e8f0;">${escapeHTML(payment.method)}</td>
                  <td style="padding:8px; text-align:right; border-top:1px solid #e2e8f0;"><b>${currency(payment.amount)}</b></td>
                </tr>
              </tbody>
            </table>
            ${payment.notes ? `<div style="margin-top:8px; font-size:12px; color:#475569;"><b>Notes:</b> ${escapeHTML(payment.notes)}</div>` : ""}
            <div style="margin-top:24px; display:flex; justify-content:space-between; align-items:center;">
              <div style="font-size:12px; color:#334155;">${escapeHTML(org.note || "")}</div>
              <div style="text-align:center;">
                <div style="border-top:1px solid #94a3b8; padding-top:6px; font-size:12px;">Authorized Signature</div>
              </div>
            </div>
          </div>
        `;
      }

      function renderReceiptHTML(org, payment, unit) {
        return `<!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />
          <title>${escapeHTML(org.name)} ‚Äî Receipt ${escapeHTML(payment.receiptNo)}</title>
          <style>
            @media print {
              @page { size: A4; margin: 16mm; }
            }
            body { background:#f8fafc; margin:0; padding:16px; }
            .sheet { background:white; padding:16px; border:1px solid #e2e8f0; border-radius:12px; }
          </style>
        </head>
        <body>
          <div class="sheet">${renderReceiptInner(org, payment, unit)}</div>
        </body>
        </html>`;
      }

      function escapeHTML(str) {
        return String(str || "").replace(/[&<>'"]/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;","\"":"&quot;"}[c]));
      }
      
      /* ------------- Mount app ------------- */
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
